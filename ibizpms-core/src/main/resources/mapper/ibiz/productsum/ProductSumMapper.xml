<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper	namespace="cn.ibizlab.pms.core.ibiz.mapper.ProductSumMapper">

    <!--该方法用于重写mybatis中selectById方法，以实现查询逻辑属性-->
	<select id="selectById"  resultMap="ProductSumResultMap" databaseId="mysql">
        <![CDATA[select t1.* from (SELECT 0 AS `ACTIVESTORYCNT`, 0 AS `CHANGEDSTORYCNT`, 0 AS `CLOSEDSTORYCNT`, t1.`ID`, t1.`NAME`, 0 AS `PLAN`, t1.`PO`, 0 AS `STORYCNT`, 0 AS `WAITSTORYCNT` FROM `zt_product` t1  ) t1 where id=#{id}]]>
    </select>

    <!--通过mybatis将查询结果注入到entity中,通过配置autoMapping="true"由mybatis自动处理映射关系 -->
    <resultMap id="ProductSumResultMap" type="cn.ibizlab.pms.core.ibiz.domain.ProductSum" autoMapping="true">
		<id property="id" column="id" /><!--主键字段映射-->
            
		
    </resultMap>


    <!--数据集合[Default]-->
	 <select id="searchDefault"  parameterType="cn.ibizlab.pms.core.ibiz.filter.ProductSumSearchContext"  resultMap="ProductSumResultMap">
         select t1.* from (
                <include refid="Default" />
         )t1
         <where><if test="ew!=null and ew.sqlSegment!=null and !ew.emptyOfWhere">${ew.sqlSegment}</if></where>
         <if test="ew!=null and ew.sqlSegment!=null and ew.emptyOfWhere">${ew.sqlSegment}</if>
     </select>

    <!--数据集合[ProductCreateStory]-->
	 <select id="searchProductCreateStory"  parameterType="cn.ibizlab.pms.core.ibiz.filter.ProductSumSearchContext"  resultMap="ProductSumResultMap">
         select t1.* from (
                <include refid="ProductCreateStory" />
         )t1
         <where><if test="ew!=null and ew.sqlSegment!=null and !ew.emptyOfWhere">${ew.sqlSegment}</if></where>
         <if test="ew!=null and ew.sqlSegment!=null and ew.emptyOfWhere">${ew.sqlSegment}</if>
     </select>

    <!--数据查询[Default]-->
    <sql id="Default" databaseId="mysql">
		<![CDATA[ select t1.*  from(select  t1.id,t1.`NAME`,t1.po,t1.PLAN, case when t1.`begin` = '2030-01-01' then '待定' else t1.`begin` end as `begin`,case when t1.`end` = '2030-01-01' then '待定' else t1.`end` end as `end`, 	sum( IF ( t1.`status` = 'draft', t1.rowcnt, 0 ) ) AS WAITSTORYCNT, 	SUM( IF ( t1.`status` = 'active', t1.rowcnt, 0 ) ) AS ACTIVESTORYCNT, 	SUM( IF ( t1.`status` = 'changed', t1.rowcnt, 0 ) ) AS CHANGEDSTORYCNT, 	SUM( IF ( t1.`status` = 'closed', t1.rowcnt, 0 ) ) AS CLOSEDSTORYCNT, 	sum( IF ( t1.`deleted` = '0',  t1.rowcnt, 0) ) AS STORYCNT  FROM 	( 	SELECT 		1 AS rowcnt, 	t41.id as plan, 		t31.`NAME` AS `NAME`, 		t31.id AS id, 		t1.`status`, 		t31.po, 		t41.`begin`, 		t41.`end` , 		t1.deleted 	FROM 		zt_product t31 		LEFT JOIN ZT_PRODUCTPLAN t41 ON t41.PRODUCT = t31.ID 		LEFT JOIN  `zt_story` t1  ON t41.id = t1.plan  where t31.deleted = '0' and  ( 			( ( t31.`status` = 'normal' ) OR ( t31.`status` = 'closed' AND #{srf.datacontext.closed} = '1' ) )  			and ( t41.id is null or 				( t41.`end` >= now( ) )  				OR ( t41.`end` <= now( ) AND #{srf.datacontext.expired} = '1' )  			)  		) ) t1 GROUP BY t1.id,t1.`NAME`,t1.po,t1.PLAN,t1.`begin`,t1.`end`) t1
			]]>
    </sql>
    <!--数据查询[ProductCreateStory]-->
    <sql id="ProductCreateStory" databaseId="mysql">
		<![CDATA[ SELECT 0 AS `ACTIVESTORYCNT`, 0 AS `CHANGEDSTORYCNT`, 0 AS `CLOSEDSTORYCNT`, t1.`ID`, t1.`NAME`, 0 AS `PLAN`, t1.`PO`, 0 AS `STORYCNT`, 0 AS `WAITSTORYCNT` FROM `zt_product` t1  
			]]>
    </sql>
    <!--数据查询[View]-->
    <sql id="View" databaseId="mysql">
		<![CDATA[ SELECT 0 AS `ACTIVESTORYCNT`, 0 AS `CHANGEDSTORYCNT`, 0 AS `CLOSEDSTORYCNT`, t1.`ID`, t1.`NAME`, 0 AS `PLAN`, t1.`PO`, 0 AS `STORYCNT`, 0 AS `WAITSTORYCNT` FROM `zt_product` t1  
			]]>
    </sql>
</mapper>

