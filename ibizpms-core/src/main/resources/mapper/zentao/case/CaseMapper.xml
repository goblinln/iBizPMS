<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper	namespace="cn.ibizlab.pms.core.zentao.mapper.CaseMapper">
	
	<!-- 无视图模式 -->
	<sql id="select" databaseId="mysql">
        <![CDATA[ SELECT t1.`AUTO`, t1.`BRANCH`, t1.`CASESN`, t1.`COLOR`, t1.`DELETED`, t1.`DEPT`, t1.`DEPTNAME`, t1.`FRAME`, t1.`FREQUENCY`, t1.`FROMBUG`, t1.`FROMCASEID`, t1.`FROMCASEVERSION`, t1.`HOWRUN`, t1.`ID`, 0 AS `ISFAVORITES`, t1.`KEYWORDS`, t1.`LASTEDITEDBY`, t1.`LASTEDITEDDATE`, t1.`LASTRUNDATE`, t1.`LASTRUNNER`, t1.`LASTRUNRESULT`, (case when t1.`LASTRUNRESULT` = '' or t1.`LASTRUNRESULT` is null then 'no' else t1.`LASTRUNRESULT` end) AS `LASTRUNRESULT1`, t1.`LIB`, t11.`NAME` AS `LIBNAME`, t1.`LINKCASE`, t1.`MODULE`, t31.`NAME` AS `MODULENAME`, (case when t1.module = '0' then '/' else (SELECT GROUP_CONCAT( tt.NAME SEPARATOR '>' )  FROM zt_module tt WHERE FIND_IN_SET( tt.id, t31.path ) AND tt.type = 'story'  GROUP BY tt.root limit 0,1) end) AS `MODULENAME1`, t1.`OPENEDBY`, t1.`OPENEDDATE`, t1.`ORDER`, t1.`ORG`, t1.`ORGNAME`, t1.`PATH`, t1.`PRECONDITION`, t1.`PRI`, t1.`PRODUCT`, t41.`name` AS `PRODUCTNAME`, (SELECT COUNT(1) FROM zt_testresult WHERE `case` = t1.`ID` ) AS `RESULTCNT`, (SELECT COUNT(1) FROM zt_testresult WHERE `case` = t1.`ID`  and caseResult in('fail','blocked') ) AS `RESULTFALICNT`, t1.`REVIEWEDBY`, t1.`REVIEWEDDATE`, t1.`SCRIPTEDBY`, t1.`SCRIPTEDDATE`, t1.`SCRIPTLOCATION`, t1.`SCRIPTSTATUS`, t1.`STAGE`, t1.`STATUS`, (case when t1.storyVersion < t21.version and t21.`status` <> 'changed' then 'storychange'  else t1.`status` end ) AS `STATUS1`, (SELECT COUNT(1) FROM zt_casestep WHERE `case` = t1.`ID` AND version = t1.`VERSION` ) AS `STEPCNT`, t1.`STORY`, t21.`TITLE` AS `STORYNAME`, t1.`STORYVERSION`, t1.`SUBSTATUS`, t1.`TITLE`, (SELECT COUNT(1) FROM zt_bug WHERE `case` = t1.`ID` ) AS `TOBUGCNT`, t1.`TYPE`, t1.`VERSION` FROM `zt_case` t1  LEFT JOIN `zt_testsuite` t11 ON t1.`LIB` = t11.`TESTSUITESN`  LEFT JOIN `zt_story` t21 ON t1.`STORY` = t21.`STORYSN`  LEFT JOIN `zt_module` t31 ON t1.`MODULE` = t31.`MODULESN`  LEFT JOIN `zt_product` t41 ON t1.`PRODUCT` = t41.`productsn`   ]]>
    </sql>

	
	<!-- 搜索条件 -->
	<sql id="searchMode" databaseId="mysql">
		<if test="srf.n_color_eq != null ">
			<![CDATA[ AND  t1.`COLOR` = #{srf.n_color_eq,jdbcType=VARCHAR} ]]>
        </if>
		<if test="srf.n_lastrunresult_eq != null ">
			<![CDATA[ AND  t1.`LASTRUNRESULT` = #{srf.n_lastrunresult_eq,jdbcType=VARCHAR} ]]>
        </if>
		<if test="srf.n_openedby_eq != null ">
			<![CDATA[ AND  t1.`OPENEDBY` = #{srf.n_openedby_eq,jdbcType=VARCHAR} ]]>
        </if>
		<if test="srf.n_type_eq != null ">
			<![CDATA[ AND  t1.`TYPE` = #{srf.n_type_eq,jdbcType=VARCHAR} ]]>
        </if>
		<if test="srf.n_status_eq != null ">
			<![CDATA[ AND  t1.`STATUS` = #{srf.n_status_eq,jdbcType=VARCHAR} ]]>
        </if>
		<if test="srf.n_isfavorites_eq != null ">
			<![CDATA[ AND  0 = #{srf.n_isfavorites_eq,jdbcType=VARCHAR} ]]>
        </if>
		<if test="srf.n_frequency_eq != null ">
			<![CDATA[ AND  t1.`FREQUENCY` = #{srf.n_frequency_eq,jdbcType=VARCHAR} ]]>
        </if>
		<if test="srf.n_title_like != null ">
            <bind name="bind_n_title_like" value="'%' + srf.n_title_like + '%'" />
            <![CDATA[ AND  t1.`TITLE` like #{bind_n_title_like,jdbcType=VARCHAR} ]]>
        </if>
		<if test="srf.n_pri_eq != null ">
			<![CDATA[ AND  t1.`PRI` = #{srf.n_pri_eq,jdbcType=INTEGER} ]]>
        </if>
		<if test="srf.n_status1_eq != null ">
			<![CDATA[ AND  (case when t1.storyVersion < t21.version and t21.`status` <> 'changed' then 'storychange'  else t1.`status` end ) = #{srf.n_status1_eq,jdbcType=VARCHAR} ]]>
        </if>
		<if test="srf.n_frame_eq != null ">
			<![CDATA[ AND  t1.`FRAME` = #{srf.n_frame_eq,jdbcType=VARCHAR} ]]>
        </if>
		<if test="srf.n_lastrunresult1_eq != null ">
			<![CDATA[ AND  (case when t1.`LASTRUNRESULT` = '' or t1.`LASTRUNRESULT` is null then 'no' else t1.`LASTRUNRESULT` end) = #{srf.n_lastrunresult1_eq,jdbcType=VARCHAR} ]]>
        </if>
		<if test="srf.n_id_eq != null ">
			<![CDATA[ AND  t1.`ID` = #{srf.n_id_eq,jdbcType=BIGINT} ]]>
        </if>
		<if test="srf.n_lastrunner_eq != null ">
			<![CDATA[ AND  t1.`LASTRUNNER` = #{srf.n_lastrunner_eq,jdbcType=VARCHAR} ]]>
        </if>
		<if test="srf.n_libname_eq != null ">
			<![CDATA[ AND  t41.`NAME` = #{srf.n_libname_eq,jdbcType=VARCHAR} ]]>
        </if>
		<if test="srf.n_libname_like != null ">
            <bind name="bind_n_libname_like" value="'%' + srf.n_libname_like + '%'" />
            <![CDATA[ AND  t41.`NAME` like #{bind_n_libname_like,jdbcType=VARCHAR} ]]>
        </if>
		<if test="srf.n_storyname_eq != null ">
			<![CDATA[ AND  t21.`TITLE` = #{srf.n_storyname_eq,jdbcType=VARCHAR} ]]>
        </if>
		<if test="srf.n_storyname_like != null ">
            <bind name="bind_n_storyname_like" value="'%' + srf.n_storyname_like + '%'" />
            <![CDATA[ AND  t21.`TITLE` like #{bind_n_storyname_like,jdbcType=VARCHAR} ]]>
        </if>
		<if test="srf.n_modulename_eq != null ">
			<![CDATA[ AND  t11.`NAME` = #{srf.n_modulename_eq,jdbcType=VARCHAR} ]]>
        </if>
		<if test="srf.n_modulename_like != null ">
            <bind name="bind_n_modulename_like" value="'%' + srf.n_modulename_like + '%'" />
            <![CDATA[ AND  t11.`NAME` like #{bind_n_modulename_like,jdbcType=VARCHAR} ]]>
        </if>
		<if test="srf.n_productname_eq != null ">
			<![CDATA[ AND  t31.`NAME` = #{srf.n_productname_eq,jdbcType=VARCHAR} ]]>
        </if>
		<if test="srf.n_productname_like != null ">
            <bind name="bind_n_productname_like" value="'%' + srf.n_productname_like + '%'" />
            <![CDATA[ AND  t31.`NAME` like #{bind_n_productname_like,jdbcType=VARCHAR} ]]>
        </if>
		<if test="srf.n_fromcaseid_eq != null ">
			<![CDATA[ AND  t1.`FROMCASEID` = #{srf.n_fromcaseid_eq,jdbcType=BIGINT} ]]>
        </if>
		<if test="srf.n_branch_eq != null ">
			<![CDATA[ AND  t1.`BRANCH` = #{srf.n_branch_eq,jdbcType=BIGINT} ]]>
        </if>
		<if test="srf.n_frombug_eq != null ">
			<![CDATA[ AND  t1.`FROMBUG` = #{srf.n_frombug_eq,jdbcType=BIGINT} ]]>
        </if>
		<if test="srf.n_story_eq != null ">
			<![CDATA[ AND  t1.`STORY` = #{srf.n_story_eq,jdbcType=BIGINT} ]]>
        </if>
		<if test="srf.n_product_eq != null ">
			<![CDATA[ AND  t1.`PRODUCT` = #{srf.n_product_eq,jdbcType=BIGINT} ]]>
        </if>
		<if test="srf.n_lib_eq != null ">
			<![CDATA[ AND  t1.`LIB` = #{srf.n_lib_eq,jdbcType=BIGINT} ]]>
        </if>
		<if test="srf.n_module_eq != null ">
			<![CDATA[ AND  t1.`MODULE` = #{srf.n_module_eq,jdbcType=BIGINT} ]]>
        </if>
		<if test="ew!=null and ew.sqlSegment!=null and ew.sqlSegment!=''">
		AND ${ew.sqlSegment}
		</if>
	</sql>


    <!--该方法用于重写mybatis中selectById方法，以实现查询逻辑属性-->
	<select id="selectById"  resultMap="CaseResultMap" databaseId="mysql">
        <include refid="select" />
		<trim prefix="where" prefixOverrides="and">
			<if test="true">
			<![CDATA[ AND t1.DELETED = '0' ]]>
			</if>
			<![CDATA[ AND T1.ID = #{id} ]]>
		</trim>
    </select>


    <!--通过mybatis将查询结果注入到entity中,通过配置autoMapping="true"由mybatis自动处理映射关系 -->
    <resultMap id="CaseResultMap" type="cn.ibizlab.pms.core.zentao.domain.Case" autoMapping="true">
		<id property="id" column="id" /><!--主键字段映射-->
		<result property="fromcaseid" column="fromcaseid" />
		<result property="branch" column="branch" />
		<result property="frombug" column="frombug" />
		<result property="story" column="story" />
		<result property="product" column="product" />
		<result property="lib" column="lib" />
		<result property="module" column="module" />
            
		
		<!--通过mybatis自动注入关系属性[主实体]，fetchType="lazy"为懒加载配置 -->
		<association property="ztbranch" javaType="cn.ibizlab.pms.core.zentao.domain.Branch" column="branch" select="cn.ibizlab.pms.core.zentao.mapper.BranchMapper.selectById" fetchType="lazy"></association>
		<!--通过mybatis自动注入关系属性[主实体]，fetchType="lazy"为懒加载配置 -->
		<association property="ztfrombug" javaType="cn.ibizlab.pms.core.zentao.domain.Bug" column="frombug" select="cn.ibizlab.pms.core.zentao.mapper.BugMapper.selectById" fetchType="lazy"></association>
		<!--通过mybatis自动注入关系属性[主实体]，fetchType="lazy"为懒加载配置 -->
		<association property="ztfromcase" javaType="cn.ibizlab.pms.core.zentao.domain.Case" column="fromcaseid" select="cn.ibizlab.pms.core.zentao.mapper.CaseMapper.selectById" fetchType="lazy"></association>
		<!--通过mybatis自动注入关系属性[主实体]，fetchType="lazy"为懒加载配置 -->
		<association property="ztmodule" javaType="cn.ibizlab.pms.core.zentao.domain.Module" column="module" select="cn.ibizlab.pms.core.zentao.mapper.ModuleMapper.selectById" fetchType="lazy"></association>
		<!--通过mybatis自动注入关系属性[主实体]，fetchType="lazy"为懒加载配置 -->
		<association property="ztproduct" javaType="cn.ibizlab.pms.core.zentao.domain.Product" column="product" select="cn.ibizlab.pms.core.zentao.mapper.ProductMapper.selectById" fetchType="lazy"></association>
		<!--通过mybatis自动注入关系属性[主实体]，fetchType="lazy"为懒加载配置 -->
		<association property="ztstory" javaType="cn.ibizlab.pms.core.zentao.domain.Story" column="story" select="cn.ibizlab.pms.core.zentao.mapper.StoryMapper.selectById" fetchType="lazy"></association>
		<!--通过mybatis自动注入关系属性[主实体]，fetchType="lazy"为懒加载配置 -->
		<association property="zttestsuite" javaType="cn.ibizlab.pms.core.zentao.domain.TestSuite" column="lib" select="cn.ibizlab.pms.core.zentao.mapper.TestSuiteMapper.selectById" fetchType="lazy"></association>
    </resultMap>

	<!--关系实体暴露select方法供主实体通过外键查询关系实体数据[实体关系名称:DER1N_ZT_CASE_ZT_BRANCH_BRANCH] -->
	 <select id="selectByBranch" resultMap="CaseResultMap"  databaseId="mysql">
        <include refid="select" />
		<trim prefix="where" prefixOverrides="and">
			<if test="true">
			<![CDATA[ AND t1.DELETED = '0' ]]>
			</if>
			<![CDATA[ AND t1.`BRANCH`=#{id} ]]>
		</trim>
     </select>
	<!--关系实体暴露select方法供主实体通过外键查询关系实体数据[实体关系名称:DER1N_ZT_CASE_ZT_BUG_FROMBUG] -->
	 <select id="selectByFrombug" resultMap="CaseResultMap"  databaseId="mysql">
        <include refid="select" />
		<trim prefix="where" prefixOverrides="and">
			<if test="true">
			<![CDATA[ AND t1.DELETED = '0' ]]>
			</if>
			<![CDATA[ AND t1.`FROMBUG`=#{id} ]]>
		</trim>
     </select>
	<!--关系实体暴露select方法供主实体通过外键查询关系实体数据[实体关系名称:DER1N_ZT_CASE_ZT_CASE_FROMCAEID] -->
	 <select id="selectByFromcaseid" resultMap="CaseResultMap"  databaseId="mysql">
        <include refid="select" />
		<trim prefix="where" prefixOverrides="and">
			<if test="true">
			<![CDATA[ AND t1.DELETED = '0' ]]>
			</if>
			<![CDATA[ AND t1.`FROMCASEID`=#{id} ]]>
		</trim>
     </select>
	<!--关系实体暴露select方法供主实体通过外键查询关系实体数据[实体关系名称:DER1N_ZT_CASE_ZT_MODULE_MODULE] -->
	 <select id="selectByModule" resultMap="CaseResultMap"  databaseId="mysql">
        <include refid="select" />
		<trim prefix="where" prefixOverrides="and">
			<if test="true">
			<![CDATA[ AND t1.DELETED = '0' ]]>
			</if>
			<![CDATA[ AND t1.`MODULE`=#{id} ]]>
		</trim>
     </select>
	<!--关系实体暴露select方法供主实体通过外键查询关系实体数据[实体关系名称:DER1N_ZT_CASE_ZT_PRODUCT_PRODUCT] -->
	 <select id="selectByProduct" resultMap="CaseResultMap"  databaseId="mysql">
        <include refid="select" />
		<trim prefix="where" prefixOverrides="and">
			<if test="true">
			<![CDATA[ AND t1.DELETED = '0' ]]>
			</if>
			<![CDATA[ AND t1.`PRODUCT`=#{id} ]]>
		</trim>
     </select>
	<!--关系实体暴露select方法供主实体通过外键查询关系实体数据[实体关系名称:DER1N_ZT_CASE_ZT_STORY_STORY] -->
	 <select id="selectByStory" resultMap="CaseResultMap"  databaseId="mysql">
        <include refid="select" />
		<trim prefix="where" prefixOverrides="and">
			<if test="true">
			<![CDATA[ AND t1.DELETED = '0' ]]>
			</if>
			<![CDATA[ AND t1.`STORY`=#{id} ]]>
		</trim>
     </select>
	<!--关系实体暴露select方法供主实体通过外键查询关系实体数据[实体关系名称:DER1N_ZT_CASE_ZT_TESTSUITE_LIB] -->
	 <select id="selectByLib" resultMap="CaseResultMap"  databaseId="mysql">
        <include refid="select" />
		<trim prefix="where" prefixOverrides="and">
			<if test="true">
			<![CDATA[ AND t1.DELETED = '0' ]]>
			</if>
			<![CDATA[ AND t1.`LIB`=#{id} ]]>
		</trim>
     </select>

    <!--数据集合[BatchNew]-->
	 <select id="searchBatchNew"  parameterType="cn.ibizlab.pms.core.zentao.filter.CaseSearchContext"  resultMap="CaseResultMap">
         select t1.* from (
                <include refid="BatchNew" />
         )t1
     </select>

    <!--数据集合[CurOpenedCase]-->
	 <select id="searchCurOpenedCase"  parameterType="cn.ibizlab.pms.core.zentao.filter.CaseSearchContext"  resultMap="CaseResultMap">
         select t1.* from (
                <include refid="CurOpenedCase" />
         )t1
     </select>

    <!--数据集合[CurSuite]-->
	 <select id="searchCurSuite"  parameterType="cn.ibizlab.pms.core.zentao.filter.CaseSearchContext"  resultMap="CaseResultMap">
         select t1.* from (
                <include refid="CurSuite" />
         )t1
     </select>

    <!--数据集合[CurTestTask]-->
	 <select id="searchCurTestTask"  parameterType="cn.ibizlab.pms.core.zentao.filter.CaseSearchContext"  resultMap="CaseResultMap">
         select t1.* from (
                <include refid="CurTestTask" />
         )t1
     </select>

    <!--数据集合[Default]-->
	 <select id="searchDefault"  parameterType="cn.ibizlab.pms.core.zentao.filter.CaseSearchContext"  resultMap="CaseResultMap">
         select t1.* from (
                <include refid="Default" />
         )t1
     </select>

    <!--数据集合[ESBulk]-->
	 <select id="searchESBulk"  parameterType="cn.ibizlab.pms.core.zentao.filter.CaseSearchContext"  resultMap="CaseResultMap">
         select t1.* from (
                <include refid="ESBulk" />
         )t1
     </select>

    <!--数据集合[ModuleRePortCase]-->
	 <select id="searchModuleRePortCase"  parameterType="cn.ibizlab.pms.core.zentao.filter.CaseSearchContext"  resultMap="CaseResultMap">
         select t1.* from (
                <include refid="ModuleRePortCase" />
         )t1
     </select>

    <!--数据集合[ModuleRePortCaseEntry]-->
	 <select id="searchModuleRePortCaseEntry"  parameterType="cn.ibizlab.pms.core.zentao.filter.CaseSearchContext"  resultMap="CaseResultMap">
         select t1.* from (
                <include refid="ModuleRePortCaseEntry" />
         )t1
     </select>

    <!--数据集合[ModuleRePortCase_Project]-->
	 <select id="searchModuleRePortCase_Project"  parameterType="cn.ibizlab.pms.core.zentao.filter.CaseSearchContext"  resultMap="CaseResultMap">
         select t1.* from (
                <include refid="ModuleRePortCase_Project" />
         )t1
     </select>

    <!--数据集合[MyFavorites]-->
	 <select id="searchMyFavorites"  parameterType="cn.ibizlab.pms.core.zentao.filter.CaseSearchContext"  resultMap="CaseResultMap">
         select t1.* from (
                <include refid="MyFavorite" />
         )t1
     </select>

    <!--数据集合[NotCurTestSuite]-->
	 <select id="searchNotCurTestSuite"  parameterType="cn.ibizlab.pms.core.zentao.filter.CaseSearchContext"  resultMap="CaseResultMap">
         select t1.* from (
                <include refid="NotCurTestSuite" />
         )t1
     </select>

    <!--数据集合[NotCurTestTask]-->
	 <select id="searchNotCurTestTask"  parameterType="cn.ibizlab.pms.core.zentao.filter.CaseSearchContext"  resultMap="CaseResultMap">
         select t1.* from (
                <include refid="NotCurTestTask" />
         )t1
     </select>

    <!--数据集合[NotCurTestTaskProject]-->
	 <select id="searchNotCurTestTaskProject"  parameterType="cn.ibizlab.pms.core.zentao.filter.CaseSearchContext"  resultMap="CaseResultMap">
         select t1.* from (
                <include refid="NotCurTestTaskProject" />
         )t1
     </select>

    <!--数据集合[RePortCase]-->
	 <select id="searchRePortCase"  parameterType="cn.ibizlab.pms.core.zentao.filter.CaseSearchContext"  resultMap="CaseResultMap">
         select t1.* from (
                <include refid="RePortCase" />
         )t1
     </select>

    <!--数据集合[RePortCaseEntry]-->
	 <select id="searchRePortCaseEntry"  parameterType="cn.ibizlab.pms.core.zentao.filter.CaseSearchContext"  resultMap="CaseResultMap">
         select t1.* from (
                <include refid="RePortCaseEntry" />
         )t1
     </select>

    <!--数据集合[RePortCase_Project]-->
	 <select id="searchRePortCase_Project"  parameterType="cn.ibizlab.pms.core.zentao.filter.CaseSearchContext"  resultMap="CaseResultMap">
         select t1.* from (
                <include refid="RePortCase_Project" />
         )t1
     </select>

    <!--数据集合[RunERRePortCase]-->
	 <select id="searchRunERRePortCase"  parameterType="cn.ibizlab.pms.core.zentao.filter.CaseSearchContext"  resultMap="CaseResultMap">
         select t1.* from (
                <include refid="RunERRePortCase" />
         )t1
     </select>

    <!--数据集合[RunERRePortCaseEntry]-->
	 <select id="searchRunERRePortCaseEntry"  parameterType="cn.ibizlab.pms.core.zentao.filter.CaseSearchContext"  resultMap="CaseResultMap">
         select t1.* from (
                <include refid="RunERRePortCaseEntry" />
         )t1
     </select>

    <!--数据集合[RunERRePortCase_Project]-->
	 <select id="searchRunERRePortCase_Project"  parameterType="cn.ibizlab.pms.core.zentao.filter.CaseSearchContext"  resultMap="CaseResultMap">
         select t1.* from (
                <include refid="RunERRePortCase_Project" />
         )t1
     </select>

    <!--数据集合[RunRePortCase]-->
	 <select id="searchRunRePortCase"  parameterType="cn.ibizlab.pms.core.zentao.filter.CaseSearchContext"  resultMap="CaseResultMap">
         select t1.* from (
                <include refid="RunRePortCase" />
         )t1
     </select>

    <!--数据集合[RunRePortCaseEntry]-->
	 <select id="searchRunRePortCaseEntry"  parameterType="cn.ibizlab.pms.core.zentao.filter.CaseSearchContext"  resultMap="CaseResultMap">
         select t1.* from (
                <include refid="RunRePortCaseEntry" />
         )t1
     </select>

    <!--数据集合[RunRePortCase_Project]-->
	 <select id="searchRunRePortCase_Project"  parameterType="cn.ibizlab.pms.core.zentao.filter.CaseSearchContext"  resultMap="CaseResultMap">
         select t1.* from (
                <include refid="RunRePortCase_Project" />
         )t1
     </select>

    <!--数据查询[BatchNew]-->
    <sql id="BatchNew" databaseId="mysql">
		<![CDATA[ SELECT t1.`AUTO`, t1.`BRANCH`, t1.`CASESN`, t1.`COLOR`, t1.`DELETED`, t1.`DEPT`, t1.`DEPTNAME`, t1.`FRAME`, t1.`FREQUENCY`, t1.`FROMBUG`, t1.`FROMCASEID`, t1.`FROMCASEVERSION`, t1.`HOWRUN`, t1.`ID`, 0 AS `ISFAVORITES`, t1.`KEYWORDS`, t1.`LASTEDITEDBY`, t1.`LASTEDITEDDATE`, t1.`LASTRUNDATE`, t1.`LASTRUNNER`, t1.`LASTRUNRESULT`, (case when t1.`LASTRUNRESULT` = '' or t1.`LASTRUNRESULT` is null then 'no' else t1.`LASTRUNRESULT` end) AS `LASTRUNRESULT1`, t1.`LIB`, t11.`NAME` AS `LIBNAME`, t1.`LINKCASE`, t1.`MODULE`, t31.`NAME` AS `MODULENAME`, (case when t1.module = '0' then '/' else (SELECT GROUP_CONCAT( tt.NAME SEPARATOR '>' )  FROM zt_module tt WHERE FIND_IN_SET( tt.id, t31.path ) AND tt.type = 'story'  GROUP BY tt.root limit 0,1) end) AS `MODULENAME1`, t1.`OPENEDBY`, t1.`OPENEDDATE`, t1.`ORDER`, t1.`ORG`, t1.`ORGNAME`, t1.`PATH`, t1.`PRI`, t1.`PRODUCT`, t41.`name` AS `PRODUCTNAME`, (SELECT COUNT(1) FROM zt_testresult WHERE `case` = t1.`ID` ) AS `RESULTCNT`, (SELECT COUNT(1) FROM zt_testresult WHERE `case` = t1.`ID`  and caseResult in('fail','blocked') ) AS `RESULTFALICNT`, t1.`REVIEWEDBY`, t1.`REVIEWEDDATE`, t1.`SCRIPTEDBY`, t1.`SCRIPTEDDATE`, t1.`SCRIPTLOCATION`, t1.`SCRIPTSTATUS`, t1.`STAGE`, t1.`STATUS`, (case when t1.storyVersion < t21.version and t21.`status` <> 'changed' then 'storychange'  else t1.`status` end ) AS `STATUS1`, (SELECT COUNT(1) FROM zt_casestep WHERE `case` = t1.`ID` AND version = t1.`VERSION` ) AS `STEPCNT`, t1.`STORY`, t21.`TITLE` AS `STORYNAME`, t1.`STORYVERSION`, t1.`SUBSTATUS`, t1.`TITLE`, (SELECT COUNT(1) FROM zt_bug WHERE `case` = t1.`ID` ) AS `TOBUGCNT`, t1.`TYPE`, t1.`VERSION` FROM `zt_case` t1  LEFT JOIN `zt_testsuite` t11 ON t1.`LIB` = t11.`TESTSUITESN`  LEFT JOIN `zt_story` t21 ON t1.`STORY` = t21.`STORYSN`  LEFT JOIN `zt_module` t31 ON t1.`MODULE` = t31.`MODULESN`  LEFT JOIN `zt_product` t41 ON t1.`PRODUCT` = t41.`productsn`   ]]>
		<trim prefix="where" prefixOverrides="and">
			<if test="true">
                <![CDATA[ AND t1.DELETED = '0' ]]>
            </if>
			<if test="true">
                <![CDATA[ AND ( 1<>1 ) ]]>
            </if>
			<include refid="searchMode" />
		</trim>
    </sql>
	
	<select id="selectBatchNew"  parameterType="cn.ibizlab.pms.core.zentao.filter.CaseSearchContext" resultMap="CaseResultMap">
		<include refid="BatchNew" />
	</select>

    <!--数据查询[CurOpenedCase]-->
    <sql id="CurOpenedCase" databaseId="mysql">
		<![CDATA[ SELECT t1.`AUTO`, t1.`BRANCH`, t1.`CASESN`, t1.`COLOR`, t1.`DELETED`, t1.`DEPT`, t1.`DEPTNAME`, t1.`FRAME`, t1.`FREQUENCY`, t1.`FROMBUG`, t1.`FROMCASEID`, t1.`FROMCASEVERSION`, t1.`HOWRUN`, t1.`ID`, 0 AS `ISFAVORITES`, t1.`KEYWORDS`, t1.`LASTEDITEDBY`, t1.`LASTEDITEDDATE`, t1.`LASTRUNDATE`, t1.`LASTRUNNER`, t1.`LASTRUNRESULT`, (case when t1.`LASTRUNRESULT` = '' or t1.`LASTRUNRESULT` is null then 'no' else t1.`LASTRUNRESULT` end) AS `LASTRUNRESULT1`, t1.`LIB`, t11.`NAME` AS `LIBNAME`, t1.`LINKCASE`, t1.`MODULE`, t31.`NAME` AS `MODULENAME`, (case when t1.module = '0' then '/' else (SELECT GROUP_CONCAT( tt.NAME SEPARATOR '>' )  FROM zt_module tt WHERE FIND_IN_SET( tt.id, t31.path ) AND tt.type = 'story'  GROUP BY tt.root limit 0,1) end) AS `MODULENAME1`, t1.`OPENEDBY`, t1.`OPENEDDATE`, t1.`ORDER`, t1.`ORG`, t1.`ORGNAME`, t1.`PATH`, t1.`PRI`, t1.`PRODUCT`, t41.`name` AS `PRODUCTNAME`, (SELECT COUNT(1) FROM zt_testresult WHERE `case` = t1.`ID` ) AS `RESULTCNT`, (SELECT COUNT(1) FROM zt_testresult WHERE `case` = t1.`ID`  and caseResult in('fail','blocked') ) AS `RESULTFALICNT`, t1.`REVIEWEDBY`, t1.`REVIEWEDDATE`, t1.`SCRIPTEDBY`, t1.`SCRIPTEDDATE`, t1.`SCRIPTLOCATION`, t1.`SCRIPTSTATUS`, t1.`STAGE`, t1.`STATUS`, (case when t1.storyVersion < t21.version and t21.`status` <> 'changed' then 'storychange'  else t1.`status` end ) AS `STATUS1`, (SELECT COUNT(1) FROM zt_casestep WHERE `case` = t1.`ID` AND version = t1.`VERSION` ) AS `STEPCNT`, t1.`STORY`, t21.`TITLE` AS `STORYNAME`, t1.`STORYVERSION`, t1.`SUBSTATUS`, t1.`TITLE`, (SELECT COUNT(1) FROM zt_bug WHERE `case` = t1.`ID` ) AS `TOBUGCNT`, t1.`TYPE`, t1.`VERSION` FROM `zt_case` t1  LEFT JOIN `zt_testsuite` t11 ON t1.`LIB` = t11.`TESTSUITESN`  LEFT JOIN `zt_story` t21 ON t1.`STORY` = t21.`STORYSN`  LEFT JOIN `zt_module` t31 ON t1.`MODULE` = t31.`MODULESN`  LEFT JOIN `zt_product` t41 ON t1.`PRODUCT` = t41.`productsn`   ]]>
		<trim prefix="where" prefixOverrides="and">
			<if test="true">
                <![CDATA[ AND t1.DELETED = '0' ]]>
            </if>
			<if test="true">
                <![CDATA[ AND ( DATE_FORMAT( t1.openedDate, '%Y' ) = DATE_FORMAT(now(), '%Y' )  AND  t1.`OPENEDBY` =  #{srf.sessioncontext.srfloginname} ) ]]>
            </if>
			<include refid="searchMode" />
		</trim>
    </sql>
	
	<select id="selectCurOpenedCase"  parameterType="cn.ibizlab.pms.core.zentao.filter.CaseSearchContext" resultMap="CaseResultMap">
		<include refid="CurOpenedCase" />
	</select>

    <!--数据查询[CurSuite]-->
    <sql id="CurSuite" databaseId="mysql">
		<![CDATA[ SELECT t1.`AUTO`, t1.`BRANCH`, t1.`CASESN`, t1.`COLOR`, t1.`DELETED`, t1.`DEPT`, t1.`DEPTNAME`, t1.`FRAME`, t1.`FREQUENCY`, t1.`FROMBUG`, t1.`FROMCASEID`, t1.`FROMCASEVERSION`, t1.`HOWRUN`, t1.`ID`, 0 AS `ISFAVORITES`, t1.`KEYWORDS`, t1.`LASTEDITEDBY`, t1.`LASTEDITEDDATE`, t1.`LASTRUNDATE`, t1.`LASTRUNNER`, t1.`LASTRUNRESULT`, (case when t1.`LASTRUNRESULT` = '' or t1.`LASTRUNRESULT` is null then 'no' else t1.`LASTRUNRESULT` end) AS `LASTRUNRESULT1`, t1.`LIB`, t11.`NAME` AS `LIBNAME`, t1.`LINKCASE`, t1.`MODULE`, t31.`NAME` AS `MODULENAME`, (case when t1.module = '0' then '/' else (SELECT GROUP_CONCAT( tt.NAME SEPARATOR '>' )  FROM zt_module tt WHERE FIND_IN_SET( tt.id, t31.path ) AND tt.type = 'story'  GROUP BY tt.root limit 0,1) end) AS `MODULENAME1`, t1.`OPENEDBY`, t1.`OPENEDDATE`, t1.`ORDER`, t1.`ORG`, t1.`ORGNAME`, t1.`PATH`, t1.`PRI`, t1.`PRODUCT`, t41.`name` AS `PRODUCTNAME`, (SELECT COUNT(1) FROM zt_testresult WHERE `case` = t1.`ID` ) AS `RESULTCNT`, (SELECT COUNT(1) FROM zt_testresult WHERE `case` = t1.`ID`  and caseResult in('fail','blocked') ) AS `RESULTFALICNT`, t1.`REVIEWEDBY`, t1.`REVIEWEDDATE`, t1.`SCRIPTEDBY`, t1.`SCRIPTEDDATE`, t1.`SCRIPTLOCATION`, t1.`SCRIPTSTATUS`, t1.`STAGE`, t1.`STATUS`, (case when t1.storyVersion < t21.version and t21.`status` <> 'changed' then 'storychange'  else t1.`status` end ) AS `STATUS1`, (SELECT COUNT(1) FROM zt_casestep WHERE `case` = t1.`ID` AND version = t1.`VERSION` ) AS `STEPCNT`, t1.`STORY`, t21.`TITLE` AS `STORYNAME`, t1.`STORYVERSION`, t1.`SUBSTATUS`, t1.`TITLE`, (SELECT COUNT(1) FROM zt_bug WHERE `case` = t1.`ID` ) AS `TOBUGCNT`, t1.`TYPE`, t1.`VERSION` FROM `zt_case` t1  LEFT JOIN `zt_testsuite` t11 ON t1.`LIB` = t11.`TESTSUITESN`  LEFT JOIN `zt_story` t21 ON t1.`STORY` = t21.`STORYSN`  LEFT JOIN `zt_module` t31 ON t1.`MODULE` = t31.`MODULESN`  LEFT JOIN `zt_product` t41 ON t1.`PRODUCT` = t41.`productsn`   ]]>
		<trim prefix="where" prefixOverrides="and">
			<if test="true">
                <![CDATA[ AND EXISTS(SELECT * FROM `zt_suitecase` t51   WHERE   t1.`CASESN` = t51.`CASE`  AND  ( t51.`SUITE` = #{srf.datacontext.srfparentkey} ) ) ]]>
            </if>
			<if test="true">
                <![CDATA[ AND t1.DELETED = '0' ]]>
            </if>
			<include refid="searchMode" />
		</trim>
    </sql>
	
	<select id="selectCurSuite"  parameterType="cn.ibizlab.pms.core.zentao.filter.CaseSearchContext" resultMap="CaseResultMap">
		<include refid="CurSuite" />
	</select>

    <!--数据查询[CurTestTask]-->
    <sql id="CurTestTask" databaseId="mysql">
		<![CDATA[ SELECT 	t1.`AUTO`,         t1.`id`, 	t1.`BRANCH`, 	t1.`COLOR`, 	t1.`DELETED`, 	t1.`FRAME`, 	t1.`FREQUENCY`, 	t1.`FROMBUG`, 	t1.`FROMCASEID`, 	t1.`FROMCASEVERSION`, 	t1.`HOWRUN`, 	t1.`CASESN`, 	( 	SELECT 		( CASE WHEN COUNT( t.IBZ_FAVORITESID ) > 0 THEN 1 ELSE 0 END ) AS ISFAVORITES  	FROM 		T_IBZ_FAVORITES t  	WHERE 		t.TYPE = 'case'  		AND t.ACCOUNT = #{srf.sessioncontext.srfloginname} and t.OBJECTID = t1.CASESN) AS `ISFAVORITES`, 		t1.`KEYWORDS`, 		t1.`LASTEDITEDBY`, 		t1.`LASTEDITEDDATE`, 		t41.`LASTRUNDATE`, 		t41.`LASTRUNNER`, 		t41.`LASTRUNRESULT`, 		( 		CASE 				 				WHEN ( 				SELECT 					count( 1 )  				FROM 					zt_testresult tt  				WHERE 					tt.`case` = t1.CASESN  					AND tt.run = t41.TESTRUNSN  					AND tt.caseResult = 'fail'  					) > 0 THEN 					'fail'  					WHEN t41.`LASTRUNRESULT` = ''  					OR t41.`LASTRUNRESULT` IS NULL THEN 						'no' ELSE t41.`LASTRUNRESULT`  					END  					) AS `LASTRUNRESULT1`, 					t1.`LIB`, 					t1.`LINKCASE`, 					t1.`MODULE`, 					t11.`NAME` AS `MODULENAME`, 					t1.`OPENEDBY`, 					t1.`OPENEDDATE`, 					t1.`ORDER`, 					t1.`PATH`, 					t1.`PRI`, 					t1.`PRODUCT`, 					t31.`NAME` AS `PRODUCTNAME`, 					t1.`REVIEWEDBY`, 					t1.`REVIEWEDDATE`, 					t1.`SCRIPTEDBY`, 					t1.`SCRIPTEDDATE`, 					t1.`SCRIPTLOCATION`, 					t1.`SCRIPTSTATUS`, 					t1.`STAGE`, 					t1.`STATUS`, 					t1.`STORY`, 					t21.`TITLE` AS `STORYNAME`, 					t1.`STORYVERSION`, 					t1.`SUBSTATUS`, 					t1.`TITLE`, 					t1.`TYPE`, 					t41.task AS task, 					t1.`VERSION`, 					t41.assignedTo AS assignedTo, 					( CASE WHEN t1.version > t41.version THEN 'casechange' ELSE t41.`status` END ) AS `status1`  				FROM 					`zt_case` t1 					LEFT JOIN zt_module t11 ON t1.MODULE = t11.MODULESN 					LEFT JOIN zt_story t21 ON t1.STORY = t21.STORYSN 					LEFT JOIN zt_product t31 ON t1.PRODUCT = t31.productsn 					LEFT JOIN zt_testrun t41 ON t1.CASESN = t41.`case` ]]>
		<trim prefix="where" prefixOverrides="and">
			<if test="true">
                <![CDATA[ AND t41.`TASK` = #{srf.datacontext.srfparentkey} ]]>
            </if>
			<if test="true">
                <![CDATA[ AND t1.DELETED = '0' ]]>
            </if>
			<include refid="searchMode" />
		</trim>
    </sql>
	
	<select id="selectCurTestTask"  parameterType="cn.ibizlab.pms.core.zentao.filter.CaseSearchContext" resultMap="CaseResultMap">
		<include refid="CurTestTask" />
	</select>

    <!--数据查询[Default]-->
    <sql id="Default" databaseId="mysql">
		<![CDATA[  SELECT t1.`AUTO`, t1.`id`, t1.`BRANCH`, t1.`COLOR`, t1.`DELETED`, t1.`FRAME`, t1.`FREQUENCY`, t1.`FROMBUG`, t1.`FROMCASEID`, t1.`FROMCASEVERSION`, t1.`HOWRUN`, t1.`CASESN`, (select (case when COUNT(t.IBZ_FAVORITESID) > 0 then 1 else 0 end ) as ISFAVORITES from T_IBZ_FAVORITES t where t.TYPE = 'case' and t.ACCOUNT = #{srf.sessioncontext.srfloginname} and t.OBJECTID = t1.id) AS `ISFAVORITES`, t1.`KEYWORDS`, t1.`LASTEDITEDBY`, t1.`LASTEDITEDDATE`, t1.`LASTRUNDATE`, t1.`LASTRUNNER`, t1.`LASTRUNRESULT`, (case when t1.`LASTRUNRESULT` = '' or t1.`LASTRUNRESULT` is null then 'no' else t1.`LASTRUNRESULT` end) AS `LASTRUNRESULT1`, t1.`LIB`, t41.`NAME` AS `LIBNAME`, t1.`LINKCASE`, t1.`MODULE`, t11.`NAME` AS `MODULENAME`, t1.`OPENEDBY`, t1.`OPENEDDATE`, t1.`ORDER`, t1.`PATH`, t1.`PRI`, t1.`PRODUCT`, t31.`NAME` AS `PRODUCTNAME`, (SELECT COUNT(1) FROM zt_testresult WHERE `case` = t1.`CASESN` ) AS `RESULTCNT`, (SELECT COUNT(1) FROM zt_testresult WHERE `case` = t1.`CASESN`  and caseResult in('fail','blocked') ) AS `RESULTFALICNT`, t1.`REVIEWEDBY`, t1.`REVIEWEDDATE`, t1.`SCRIPTEDBY`, t1.`SCRIPTEDDATE`, t1.`SCRIPTLOCATION`, t1.`SCRIPTSTATUS`, t1.`STAGE`, t1.`STATUS`, (case when t1.storyVersion < t21.version and t21.`status` <> 'changed' then 'storychange'  else t1.`status` end ) AS `STATUS1`, (SELECT COUNT(1) FROM zt_casestep WHERE `case` = t1.`CASESN` AND version = t1.`VERSION` ) AS `STEPCNT`, t1.`STORY`, t21.`TITLE` AS `STORYNAME`, t1.`STORYVERSION`, t1.`SUBSTATUS`, t1.`TITLE`, (SELECT COUNT(1) FROM zt_bug WHERE `case` = t1.`CASESN` ) AS `TOBUGCNT`, t1.`TYPE`, t1.`VERSION` FROM `zt_case` t1  LEFT JOIN zt_module t11 ON t1.MODULE = t11.MODULESN  LEFT JOIN zt_story t21 ON t1.STORY = t21.STORYSN  LEFT JOIN zt_product t31 ON t1.PRODUCT = t31.productsn  LEFT JOIN zt_testsuite t41 ON t1.LIB = t41.TESTSUITESN ]]>
		<trim prefix="where" prefixOverrides="and">
			<if test="true">
                <![CDATA[ AND t1.DELETED = '0' ]]>
            </if>
			<include refid="searchMode" />
		</trim>
    </sql>
	
	<select id="selectDefault"  parameterType="cn.ibizlab.pms.core.zentao.filter.CaseSearchContext" resultMap="CaseResultMap">
		<include refid="Default" />
	</select>

    <!--数据查询[ESBulk]-->
    <sql id="ESBulk" databaseId="mysql">
		<![CDATA[ SELECT 	t1.CASESN,         t1.`id`, 	t1.title, 	t1.precondition, 	t1.PRODUCT, 	t1.deleted FROM 	zt_case t1 ]]>
		<trim prefix="where" prefixOverrides="and">
			<include refid="searchMode" />
		</trim>
    </sql>
	
	<select id="selectESBulk"  parameterType="cn.ibizlab.pms.core.zentao.filter.CaseSearchContext" resultMap="CaseResultMap">
		<include refid="ESBulk" />
	</select>

    <!--数据查询[ModuleRePortCase]-->
    <sql id="ModuleRePortCase" databaseId="mysql">
		<![CDATA[ SELECT  t1.`AUTO`, t1.`id`, t1.`BRANCH`, t1.`COLOR`, t1.`DELETED`, t1.`FRAME`, t1.`FREQUENCY`, t1.`FROMBUG`, t1.`FROMCASEID`, t1.`FROMCASEVERSION`, t1.`HOWRUN`, t1.`CASESN`, 0 AS `ISFAVORITES`, t1.`KEYWORDS`, t1.`LASTEDITEDBY`, t1.`LASTEDITEDDATE`, t1.LASTRUNDATE AS `LASTRUNDATE`, t1.`LASTRUNNER`, t1.LASTRUNRESULT AS `LASTRUNRESULT`, (case when t1.`LASTRUNRESULT` = '' or t1.`LASTRUNRESULT` is null then 'no' else t1.`LASTRUNRESULT` end) AS `LASTRUNRESULT1`, t1.`LIB`, t41.`NAME` AS `LIBNAME`, t1.`LINKCASE`, t1.`MODULE`, 	CONCAT( 	'/',  case when	( SELECT 	GROUP_CONCAT( tt.NAME SEPARATOR '/' )  FROM 	zt_module tt  WHERE 	FIND_IN_SET( tt.MODULESN, t11.path )  	AND tt.type = 'story'  GROUP BY 	tt.root  	LIMIT 0,1 	) is not null then ( SELECT 	GROUP_CONCAT( tt.NAME SEPARATOR '/' )  FROM 	zt_module tt  WHERE 	FIND_IN_SET( tt.MODULESN, t11.path )  	AND tt.type = 'story'  GROUP BY 	tt.root  	LIMIT 0,1 	) when t11.`name` is null then '' else t11.`name` end 	) AS `MODULENAME`, t1.`OPENEDBY`, t1.`OPENEDDATE`, t1.`ORDER`, t1.`PATH`, t1.`PRI`, t1.`PRODUCT`, t31.`NAME` AS `PRODUCTNAME`, (SELECT COUNT(1) FROM zt_testresult WHERE `case` = t1.`CASESN` ) AS `RESULTCNT`, (SELECT COUNT(1) FROM zt_testresult WHERE `case` = t1.`CASESN`  and caseResult in('fail','blocked') ) AS `RESULTFALICNT`, t1.`REVIEWEDBY`, t1.`REVIEWEDDATE`, t1.`SCRIPTEDBY`, t1.`SCRIPTEDDATE`, t1.`SCRIPTLOCATION`, t1.`SCRIPTSTATUS`, t1.`STAGE`, t1.`STATUS`, (case when t1.storyVersion < t21.version and t21.`status` <> 'changed' then 'storychange'  else t1.`status` end ) AS `STATUS1`, (SELECT COUNT(1) FROM zt_casestep WHERE `case` = t1.`CASESN` AND version = t1.`VERSION` ) AS `STEPCNT`, t1.`STORY`, t21.`TITLE` AS `STORYNAME`, t1.`STORYVERSION`, t1.`SUBSTATUS`, t1.`TITLE`, (SELECT COUNT(1) FROM zt_bug WHERE `case` = t1.`CASESN` ) AS `TOBUGCNT`, t1.`TYPE`, t1.`VERSION` FROM `zt_case` t1  LEFT JOIN zt_module t11 ON t1.MODULE = t11.MODULESN LEFT JOIN zt_story t21 ON t1.STORY = t21.STORYSN  LEFT JOIN zt_product t31 ON t1.PRODUCT = t31.productsn  LEFT JOIN zt_testsuite t41 ON t1.LIB = t41.TESTSUITESN LEFT JOIN zt_testrun t51 on t51.`case` = t1.CASESN LEFT JOIN zt_testreport t61 on t51.task = t61.tasks ]]>
		<trim prefix="where" prefixOverrides="and">
			<if test="true">
                <![CDATA[ AND t1.DELETED = '0' ]]>
            </if>
			<if test="true">
                <![CDATA[ AND t61.TASKSN = #{srf.webcontext.srfparentkey} ]]>
            </if>
			<include refid="searchMode" />
		</trim>
    </sql>
	
	<select id="selectModuleRePortCase"  parameterType="cn.ibizlab.pms.core.zentao.filter.CaseSearchContext" resultMap="CaseResultMap">
		<include refid="ModuleRePortCase" />
	</select>

    <!--数据查询[ModuleRePortCaseEntry]-->
    <sql id="ModuleRePortCaseEntry" databaseId="mysql">
		<![CDATA[ select t1.lastRunResult1,t1.RESULTCNT as RESULTCNT, t1.PRODUCT,CONCAT(ROUND(t1.RESULTCNT / t1.sss * 100, 2),'','%') as TASK from( select t1.PRODUCT,t1.lastRunResult1,t1.resultcnt,(SELECT 	COUNT( 1 )  FROM 	zt_case ttt  LEFT JOIN zt_testrun t51 on t51.`case` = ttt.CASESN LEFT JOIN zt_testreport t61 on t51.task = t61.tasks WHERE 	t61.TESTREPORTSN = #{srf.webcontext.srfparentkey} 	AND ttt.DELETED = '0' ) as sss from ( select t1.PRODUCT,t1.lastRunResult1,COUNT(t1.lastRunResult1) as RESULTCNT from ( SELECT  	CONCAT( 	'/',  case when	( SELECT 	GROUP_CONCAT( tt.NAME SEPARATOR '/' )  FROM 	zt_module tt  WHERE 	FIND_IN_SET( tt.MODULESN, t11.path )  	AND tt.type = 'story'  GROUP BY 	tt.root  	LIMIT 0,1 	) is not null then ( SELECT 	GROUP_CONCAT( tt.NAME SEPARATOR '/' )  FROM 	zt_module tt  WHERE 	FIND_IN_SET( tt.MODULESN, t11.path )  	AND tt.type = 'story'  GROUP BY 	tt.root  	LIMIT 0,1 	) when t11.`name` is null then '' else t11.`name` end 	) AS `lastRunResult1`, t1.`PRODUCT` FROM `zt_case` t1  LEFT JOIN zt_module t11 ON t1.MODULE = t11.MODULESN  LEFT JOIN zt_testrun t51 on t51.`case` = t1.CASESN LEFT JOIN zt_testreport t61 on t51.task = t61.tasks where t61.TESTREPORTSN = #{srf.webcontext.srfparentkey}  	AND t1.DELETED = '0' ) t1 GROUP BY t1.lastRunResult1 ) t1) t1 ]]>
		<trim prefix="where" prefixOverrides="and">
			<include refid="searchMode" />
		</trim>
    </sql>
	
	<select id="selectModuleRePortCaseEntry"  parameterType="cn.ibizlab.pms.core.zentao.filter.CaseSearchContext" resultMap="CaseResultMap">
		<include refid="ModuleRePortCaseEntry" />
	</select>

    <!--数据查询[ModuleRePortCase_Project]-->
    <sql id="ModuleRePortCase_Project" databaseId="mysql">
		<![CDATA[ SELECT  t1.`AUTO`, t1.`id`, t1.`BRANCH`, t1.`COLOR`, t1.`DELETED`, t1.`FRAME`, t1.`FREQUENCY`, t1.`FROMBUG`, t1.`FROMCASEID`, t1.`FROMCASEVERSION`, t1.`HOWRUN`, t1.`CASESN`, 0 AS `ISFAVORITES`, t1.`KEYWORDS`, t1.`LASTEDITEDBY`, t1.`LASTEDITEDDATE`, t1.LASTRUNDATE AS `LASTRUNDATE`, t1.`LASTRUNNER`, t1.LASTRUNRESULT AS `LASTRUNRESULT`, (case when t1.`LASTRUNRESULT` = '' or t1.`LASTRUNRESULT` is null then 'no' else t1.`LASTRUNRESULT` end) AS `LASTRUNRESULT1`, t1.`LIB`, t41.`NAME` AS `LIBNAME`, t1.`LINKCASE`, t1.`MODULE`, 	CONCAT( 	'/',  case when	( SELECT 	GROUP_CONCAT( tt.NAME SEPARATOR '/' )  FROM 	zt_module tt  WHERE 	FIND_IN_SET( tt.MODULESN, t11.path )  	AND tt.type = 'story'  GROUP BY 	tt.root  	LIMIT 0,1 	) is not null then ( SELECT 	GROUP_CONCAT( tt.NAME SEPARATOR '/' )  FROM 	zt_module tt  WHERE 	FIND_IN_SET( tt.MODULESN, t11.path )  	AND tt.type = 'story'  GROUP BY 	tt.root  	LIMIT 0,1 	) when t11.`name` is null then '' else t11.`name` end 	) AS `MODULENAME`, t1.`OPENEDBY`, t1.`OPENEDDATE`, t1.`ORDER`, t1.`PATH`, t1.`PRI`, t1.`PRODUCT`, t31.`NAME` AS `PRODUCTNAME`, (SELECT COUNT(1) FROM zt_testresult WHERE `case` = t1.`CASESN` ) AS `RESULTCNT`, (SELECT COUNT(1) FROM zt_testresult WHERE `case` = t1.`CASESN`  and caseResult in('fail','blocked') ) AS `RESULTFALICNT`, t1.`REVIEWEDBY`, t1.`REVIEWEDDATE`, t1.`SCRIPTEDBY`, t1.`SCRIPTEDDATE`, t1.`SCRIPTLOCATION`, t1.`SCRIPTSTATUS`, t1.`STAGE`, t1.`STATUS`, (case when t1.storyVersion < t21.version and t21.`status` <> 'changed' then 'storychange'  else t1.`status` end ) AS `STATUS1`, (SELECT COUNT(1) FROM zt_casestep WHERE `case` = t1.`CASESN` AND version = t1.`VERSION` ) AS `STEPCNT`, t1.`STORY`, t21.`TITLE` AS `STORYNAME`, t1.`STORYVERSION`, t1.`SUBSTATUS`, t1.`TITLE`, (SELECT COUNT(1) FROM zt_bug WHERE `case` = t1.`CASESN` ) AS `TOBUGCNT`, t1.`TYPE`, t1.`VERSION` FROM `zt_case` t1  LEFT JOIN zt_module t11 ON t1.MODULE = t11.MODULESN  LEFT JOIN zt_story t21 ON t1.STORY = t21.STORYSN  LEFT JOIN zt_product t31 ON t1.PRODUCT = t31.productsn  LEFT JOIN zt_testsuite t41 ON t1.LIB = t41.TESTSUITESN LEFT JOIN zt_testrun t51 on t51.`case` = t1.CASESN LEFT JOIN zt_testreport t61 on FIND_IN_SET(t51.task, t61.tasks) ]]>
		<trim prefix="where" prefixOverrides="and">
			<if test="true">
                <![CDATA[ AND t1.DELETED = '0' ]]>
            </if>
			<if test="true">
                <![CDATA[ AND t61.TESTREPORTSN = #{srf.webcontext.srfparentkey} ]]>
            </if>
			<include refid="searchMode" />
		</trim>
    </sql>
	
	<select id="selectModuleRePortCase_Project"  parameterType="cn.ibizlab.pms.core.zentao.filter.CaseSearchContext" resultMap="CaseResultMap">
		<include refid="ModuleRePortCase_Project" />
	</select>

    <!--数据查询[MyFavorite]-->
    <sql id="MyFavorite" databaseId="mysql">
		<![CDATA[ SELECT 	t1.`AUTO`,         t1.`id`, 	t1.`BRANCH`, 	t1.`COLOR`, 	t1.`DELETED`, 	t1.`FRAME`, 	t1.`FREQUENCY`, 	t1.`FROMBUG`, 	t1.`FROMCASEID`, 	t1.`FROMCASEVERSION`, 	t1.`HOWRUN`, 	t1.`CASESN`, 	1 AS `ISFAVORITES`, 	t1.`KEYWORDS`, 	t1.`LASTEDITEDBY`, 	t1.`LASTEDITEDDATE`, 	t1.`LASTRUNDATE`, 	t1.`LASTRUNNER`, 	t1.`LASTRUNRESULT`, 	( CASE WHEN t1.`LASTRUNRESULT` = '' OR t1.`LASTRUNRESULT` IS NULL THEN 'no' ELSE t1.`LASTRUNRESULT` END ) AS `LASTRUNRESULT1`, 	t1.`LIB`, 	t41.`NAME` AS `LIBNAME`, 	t1.`LINKCASE`, 	t1.`MODULE`, 	t11.`NAME` AS `MODULENAME`, 	( 	CASE 			 			WHEN t1.module = '0' THEN 			'/' ELSE ( 			SELECT 				GROUP_CONCAT( tt.NAME SEPARATOR '>' )  			FROM 				zt_module tt  			WHERE 				FIND_IN_SET( tt.MODULESN, t11.path )  				AND tt.type = 'story'  			GROUP BY 				tt.root  				LIMIT 0, 				1  			)  		END  		) AS `MODULENAME1`, 		t1.`OPENEDBY`, 		t1.`OPENEDDATE`, 		t1.`ORDER`, 		t1.`PATH`, 		t1.`PRI`, 		t1.`PRODUCT`, 		t31.`NAME` AS `PRODUCTNAME`, 		( SELECT COUNT( 1 ) FROM zt_testresult WHERE `case` = t1.`CASESN` ) AS `RESULTCNT`, 		( SELECT COUNT( 1 ) FROM zt_testresult WHERE `case` = t1.`CASESN` AND caseResult IN ( 'fail', 'blocked' ) ) AS `RESULTFALICNT`, 		t1.`REVIEWEDBY`, 		t1.`REVIEWEDDATE`, 		t1.`SCRIPTEDBY`, 		t1.`SCRIPTEDDATE`, 		t1.`SCRIPTLOCATION`, 		t1.`SCRIPTSTATUS`, 		t1.`STAGE`, 		t1.`STATUS`, 		( CASE WHEN t1.storyVersion < t21.version AND t21.`status` <> 'changed' THEN 'storychange' ELSE t1.`status` END ) AS `STATUS1`, 		( SELECT COUNT( 1 ) FROM zt_casestep WHERE `case` = t1.`CASESN` AND version = t1.`VERSION` ) AS `STEPCNT`, 		t1.`STORY`, 		t21.`TITLE` AS `STORYNAME`, 		t1.`STORYVERSION`, 		t1.`SUBSTATUS`, 		t1.`TITLE`, 		( SELECT COUNT( 1 ) FROM zt_bug WHERE `case` = t1.`CASESN` ) AS `TOBUGCNT`, 		t1.`TYPE`, 		t1.`VERSION`  	FROM 		`zt_case` t1 		LEFT JOIN zt_module t11 ON t1.MODULE = t11.MODULESN 		LEFT JOIN zt_story t21 ON t1.STORY = t21.STORYSN 		LEFT JOIN zt_product t31 ON t1.PRODUCT = t31.productsn 		LEFT JOIN zt_testsuite t41 ON t1.LIB = t41.TESTSUITESN ]]>
		<trim prefix="where" prefixOverrides="and">
			<if test="true">
                <![CDATA[ AND t1.DELETED = '0' ]]>
            </if>
			<if test="true">
                <![CDATA[ AND ( 			t1.CASESN IN ( 			SELECT 				t.OBJECTID  			FROM 				T_IBZ_FAVORITES t  			WHERE 			t.type = 'case'  	AND t.account = #{srf.sessioncontext.srfloginname})  AND  t1.DELETED = '0' ) ]]>
            </if>
			<include refid="searchMode" />
		</trim>
    </sql>
	
	<select id="selectMyFavorite"  parameterType="cn.ibizlab.pms.core.zentao.filter.CaseSearchContext" resultMap="CaseResultMap">
		<include refid="MyFavorite" />
	</select>

    <!--数据查询[NotCurTestSuite]-->
    <sql id="NotCurTestSuite" databaseId="mysql">
		<![CDATA[ SELECT 	t1.`AUTO`,         t1.`id`, 	t1.`BRANCH`, 	t1.`COLOR`, 	t1.`DELETED`, 	t1.`FRAME`, 	t1.`FREQUENCY`, 	t1.`FROMBUG`, 	t1.`FROMCASEID`, 	t1.`FROMCASEVERSION`, 	t1.`HOWRUN`, 	t1.`CASESN`, (select (case when COUNT(t.IBZ_FAVORITESID) > 0 then 1 else 0 end ) as ISFAVORITES from T_IBZ_FAVORITES t where t.TYPE = 'case' and t.ACCOUNT = #{srf.sessioncontext.srfloginname} and t.OBJECTID = t1.CASESN) AS `ISFAVORITES`, 	t1.`KEYWORDS`, 	t1.`LASTEDITEDBY`, 	t1.`LASTEDITEDDATE`, 	t1.`LASTRUNDATE`, 	t1.`LASTRUNNER`, 	t1.`LASTRUNRESULT`, (case when t1.`LASTRUNRESULT` = '' or t1.`LASTRUNRESULT` is null then 'no' else t1.`LASTRUNRESULT` end) as  `LASTRUNRESULT1`, 	t1.`LIB`, 	t1.`LINKCASE`, 	t1.`MODULE`, 	t11.`NAME` AS `MODULENAME`, 	t1.`OPENEDBY`, 	t1.`OPENEDDATE`, 	t1.`ORDER`, 	t1.`PATH`, 	t1.`PRI`, 	t1.`PRODUCT`, 	t31.`NAME` AS `PRODUCTNAME`, 	( SELECT COUNT( 1 ) FROM zt_testresult WHERE `case` = t1.`CASESN` ) AS `RESULTCNT`, 	( SELECT COUNT( 1 ) FROM zt_testresult WHERE `case` = t1.`CASESN` AND caseResult IN ( 'fail', 'blocked' ) ) AS `RESULTFALICNT`, 	t1.`REVIEWEDBY`, 	t1.`REVIEWEDDATE`, 	t1.`SCRIPTEDBY`, 	t1.`SCRIPTEDDATE`, 	t1.`SCRIPTLOCATION`, 	t1.`SCRIPTSTATUS`, 	t1.`STAGE`, 	t1.`STATUS`, 	( CASE WHEN t1.storyVersion < t21.version AND t21.`status` <> 'changed' THEN 'storychange' ELSE t1.`status` END ) AS `STATUS1`, 	( SELECT COUNT( 1 ) FROM zt_casestep WHERE `case` = t1.`CASESN` AND version = t1.`VERSION` ) AS `STEPCNT`, 	t1.`STORY`, 	t21.`TITLE` AS `STORYNAME`, 	t1.`STORYVERSION`, 	t1.`SUBSTATUS`, 	t1.`TITLE`, 	( SELECT COUNT( 1 ) FROM zt_bug WHERE `case` = t1.`CASESN` ) AS `TOBUGCNT`, 	t1.`TYPE`, 	t1.`VERSION`  FROM 	`zt_case` t1 	LEFT JOIN zt_module t11 ON t1.MODULE = t11.MODULESN 	LEFT JOIN zt_story t21 ON t1.STORY = t21.STORYSN 	LEFT JOIN zt_product t31 ON t1.PRODUCT = t31.productsn ]]>
		<trim prefix="where" prefixOverrides="and">
			<if test="true">
                <![CDATA[ AND 		NOT ( 			EXISTS ( 			SELECT 				*  			FROM 				zt_suitecase t41  			WHERE 				t1.CASESN = t41.`CASE`  				AND ( t41.`suite` = $ { srfwebcontext ( 'suite', '{\"defname\":\"TASK\",\"dename\":\"ZT_TESTRUN\"}' ) } )  			)  	) ]]>
            </if>
			<if test="true">
                <![CDATA[ AND t1.`deleted` = '0' ]]>
            </if>
			<include refid="searchMode" />
		</trim>
    </sql>
	
	<select id="selectNotCurTestSuite"  parameterType="cn.ibizlab.pms.core.zentao.filter.CaseSearchContext" resultMap="CaseResultMap">
		<include refid="NotCurTestSuite" />
	</select>

    <!--数据查询[NotCurTestTask]-->
    <sql id="NotCurTestTask" databaseId="mysql">
		<![CDATA[ SELECT t1.`AUTO`, t1.`id`, t1.`BRANCH`, t1.`COLOR`, t1.`DELETED`, t1.`FRAME`, t1.`FREQUENCY`, t1.`FROMBUG`, t1.`FROMCASEID`, t1.`FROMCASEVERSION`, t1.`HOWRUN`, t1.`CASESN`, (select (case when COUNT(t.IBZ_FAVORITESID) > 0 then 1 else 0 end ) as ISFAVORITES from T_IBZ_FAVORITES t where t.TYPE = 'case' and t.ACCOUNT = #{srf.sessioncontext.srfloginname} and t.OBJECTID = t1.CASESN) AS `ISFAVORITES`, t1.`KEYWORDS`, t1.`LASTEDITEDBY`, t1.`LASTEDITEDDATE`, t1.`LASTRUNDATE`, t1.`LASTRUNNER`, t1.`LASTRUNRESULT`, (case when t1.`LASTRUNRESULT` = '' or t1.`LASTRUNRESULT` is null then 'no' else t1.`LASTRUNRESULT` end) as  `LASTRUNRESULT1`, t1.`LIB`, t1.`LINKCASE`, t1.`MODULE`, t11.`NAME` AS `MODULENAME`, t1.`OPENEDBY`, t1.`OPENEDDATE`, t1.`ORDER`, t1.`PATH`, t1.`PRI`, t1.`PRODUCT`, t31.`NAME` AS `PRODUCTNAME`, (SELECT COUNT(1) FROM zt_testresult WHERE `case` = t1.`CASESN` ) AS `RESULTCNT`, (SELECT COUNT(1) FROM zt_testresult WHERE `case` = t1.`CASESN`  and caseResult in('fail','blocked') ) AS `RESULTFALICNT`, t1.`REVIEWEDBY`, t1.`REVIEWEDDATE`, t1.`SCRIPTEDBY`, t1.`SCRIPTEDDATE`, t1.`SCRIPTLOCATION`, t1.`SCRIPTSTATUS`, t1.`STAGE`, t1.`STATUS`, (case when t1.storyVersion < t21.version and t21.`status` <> 'changed' then 'storychange'  else t1.`status` end ) AS `STATUS1`, (SELECT COUNT(1) FROM zt_casestep WHERE `case` = t1.`CASESN` AND version = t1.`VERSION` ) AS `STEPCNT`, t1.`STORY`, t21.`TITLE` AS `STORYNAME`, t1.`STORYVERSION`, t1.`SUBSTATUS`, t1.`TITLE`, (SELECT COUNT(1) FROM zt_bug WHERE `case` = t1.`CASESN` ) AS `TOBUGCNT`, t1.`TYPE`, t1.`VERSION` FROM `zt_case` t1  LEFT JOIN zt_module t11 ON t1.MODULE = t11.MODULESN  LEFT JOIN zt_story t21 ON t1.STORY = t21.STORYSN  LEFT JOIN zt_product t31 ON t1.PRODUCT = t31.productsn ]]>
		<trim prefix="where" prefixOverrides="and">
			<if test="true">
                <![CDATA[ AND NOT(EXISTS(SELECT * FROM zt_testrun t41   WHERE   t1.CASESN = t41.`CASE`  AND  ( t41.`task` = #{srf.webcontext.task} ) )) ]]>
            </if>
			<if test="true">
                <![CDATA[ AND t1.DELETED = '0' ]]>
            </if>
			<if test="true">
                <![CDATA[ AND t1.product in (select tt.product from zt_testtask t left join zt_projectproduct tt on tt.project = t.project where t.TESTTASKSN = #{srf.webcontext.task}) ]]>
            </if>
			<include refid="searchMode" />
		</trim>
    </sql>
	
	<select id="selectNotCurTestTask"  parameterType="cn.ibizlab.pms.core.zentao.filter.CaseSearchContext" resultMap="CaseResultMap">
		<include refid="NotCurTestTask" />
	</select>

    <!--数据查询[NotCurTestTaskProject]-->
    <sql id="NotCurTestTaskProject" databaseId="mysql">
		<![CDATA[ SELECT 	t1.`AUTO`,         t1.`id`, 	t1.`BRANCH`, 	t1.`COLOR`, 	t1.`DELETED`, 	t1.`FRAME`, 	t1.`FREQUENCY`, 	t1.`FROMBUG`, 	t1.`FROMCASEID`, 	t1.`FROMCASEVERSION`, 	t1.`HOWRUN`, 	t1.`CASESN`, 	( 	SELECT 		( CASE WHEN COUNT( t.IBZ_FAVORITESID ) > 0 THEN 1 ELSE 0 END ) AS ISFAVORITES  	FROM 		T_IBZ_FAVORITES t  	WHERE 		t.TYPE = 'case'  		AND t.ACCOUNT = #{srf.sessioncontext.srfloginname} and t.OBJECTID = t1.CASESN) AS `ISFAVORITES`, 		t1.`KEYWORDS`, 		t1.`LASTEDITEDBY`, 		t1.`LASTEDITEDDATE`, 		t1.`LASTRUNDATE`, 		t1.`LASTRUNNER`, 		t1.`LASTRUNRESULT`, 		( CASE WHEN t1.`LASTRUNRESULT` = '' OR t1.`LASTRUNRESULT` IS NULL THEN 'no' ELSE t1.`LASTRUNRESULT` END ) AS `LASTRUNRESULT1`, 		t1.`LIB`, 		t1.`LINKCASE`, 		t1.`MODULE`, 		t11.`NAME` AS `MODULENAME`, 		t1.`OPENEDBY`, 		t1.`OPENEDDATE`, 		t1.`ORDER`, 		t1.`PATH`, 		t1.`PRI`, 		t1.`PRODUCT`, 		t31.`NAME` AS `PRODUCTNAME`, 		( SELECT COUNT( 1 ) FROM zt_testresult WHERE `case` = t1.`CASESN` ) AS `RESULTCNT`, 		( SELECT COUNT( 1 ) FROM zt_testresult WHERE `case` = t1.`CASESN` AND caseResult IN ( 'fail', 'blocked' ) ) AS `RESULTFALICNT`, 		t1.`REVIEWEDBY`, 		t1.`REVIEWEDDATE`, 		t1.`SCRIPTEDBY`, 		t1.`SCRIPTEDDATE`, 		t1.`SCRIPTLOCATION`, 		t1.`SCRIPTSTATUS`, 		t1.`STAGE`, 		t1.`STATUS`, 		( CASE WHEN t1.storyVersion < t21.version AND t21.`status` <> 'changed' THEN 'storychange' ELSE t1.`status` END ) AS `STATUS1`, 		( SELECT COUNT( 1 ) FROM zt_casestep WHERE `case` = t1.`CASESN` AND version = t1.`VERSION` ) AS `STEPCNT`, 		t1.`STORY`, 		t21.`TITLE` AS `STORYNAME`, 		t1.`STORYVERSION`, 		t1.`SUBSTATUS`, 		t1.`TITLE`, 		( SELECT COUNT( 1 ) FROM zt_bug WHERE `case` = t1.`CASESN` ) AS `TOBUGCNT`, 		t1.`TYPE`, 		t1.`VERSION`  	FROM 		`zt_case` t1 		LEFT JOIN zt_module t11 ON t1.MODULE = t11.MODULESN 		LEFT JOIN zt_story t21 ON t1.STORY = t21.STORYSN 		LEFT JOIN zt_product t31 ON t1.PRODUCT = t31.productsn ]]>
		<trim prefix="where" prefixOverrides="and">
			<if test="true">
                <![CDATA[ AND NOT ( 			EXISTS ( 			SELECT 				*  			FROM 				zt_testrun t41  			WHERE 				t1.CASESN = t41.`CASE`  				AND ( t41.`task` = $ { srfwebcontext ( 'task', '{\"defname\":\"TASK\",\"dename\":\"ZT_TESTRUN\"}' ) } )  			)  	) ]]>
            </if>
			<if test="true">
                <![CDATA[ AND t1.DELETED = '0' ]]>
            </if>
			<if test="true">
                <![CDATA[ AND 		t1.product IN ( 		SELECT 			tt.product  		FROM 			zt_testtask t 			LEFT JOIN zt_projectproduct tt ON tt.project = t.project  		WHERE 			t.TESTTASKSN = $ { srfwebcontext ( 'task', '{\"defname\":\"TASK\",\"dename\":\"ZT_TESTRUN\"}' ) }  		) ]]>
            </if>
			<include refid="searchMode" />
		</trim>
    </sql>
	
	<select id="selectNotCurTestTaskProject"  parameterType="cn.ibizlab.pms.core.zentao.filter.CaseSearchContext" resultMap="CaseResultMap">
		<include refid="NotCurTestTaskProject" />
	</select>

    <!--数据查询[RePortCase]-->
    <sql id="RePortCase" databaseId="mysql">
		<![CDATA[ SELECT 	t1.`AUTO`,         t1.`id`, 	t1.`BRANCH`, 	t1.`COLOR`, 	t1.`DELETED`, 	t1.`FRAME`, 	t1.`FREQUENCY`, 	t1.`FROMBUG`, 	t1.`FROMCASEID`, 	t1.`FROMCASEVERSION`, 	t1.`HOWRUN`, 	t1.`CASESN`, 	0 AS `ISFAVORITES`, 	t1.`KEYWORDS`, 	t1.`LASTEDITEDBY`, 	t1.`LASTEDITEDDATE`, 	t51.`LASTRUNDATE` AS LASTRUNDATE, 	t51.`LASTRUNNER` AS LASTRUNNER, 	t51.`LASTRUNRESULT` AS LASTRUNRESULT, 	( CASE WHEN t51.`LASTRUNRESULT` = '' OR t51.`LASTRUNRESULT` IS NULL THEN 'no' ELSE t51.`LASTRUNRESULT` END ) AS `LASTRUNRESULT1`, 	t1.`LIB`, 	t41.`NAME` AS `LIBNAME`, 	t1.`LINKCASE`, 	t1.`MODULE`, 	t11.`NAME` AS `MODULENAME`, 	t1.`OPENEDBY`, 	t1.`OPENEDDATE`, 	t1.`ORDER`, 	t1.`PATH`, 	t1.`PRI`, 	t1.`PRODUCT`, 	t31.`NAME` AS `PRODUCTNAME`, 	( SELECT COUNT( 1 ) FROM zt_testresult WHERE `case` = t1.`CASESN` ) AS `RESULTCNT`, 	( SELECT COUNT( 1 ) FROM zt_testresult WHERE `case` = t1.`CASESN` AND caseResult IN ( 'fail', 'blocked' ) ) AS `RESULTFALICNT`, 	t1.`REVIEWEDBY`, 	t1.`REVIEWEDDATE`, 	t1.`SCRIPTEDBY`, 	t1.`SCRIPTEDDATE`, 	t1.`SCRIPTLOCATION`, 	t1.`SCRIPTSTATUS`, 	t1.`STAGE`, 	t1.`STATUS`, 	t51.assignedTo AS assignedTo, 	( CASE WHEN t1.version > t51.version THEN 'casechange' ELSE t51.`status` END ) AS `status1`, 	( SELECT COUNT( 1 ) FROM zt_casestep WHERE `case` = t1.`CASESN` AND version = t1.`VERSION` ) AS `STEPCNT`, 	t1.`STORY`, 	t21.`TITLE` AS `STORYNAME`, 	t1.`STORYVERSION`, 	t1.`SUBSTATUS`, 	t1.`TITLE`, 	( SELECT COUNT( 1 ) FROM zt_bug WHERE `case` = t1.`CASESN` ) AS `TOBUGCNT`, CASE 		 		WHEN t1.`TYPE` = 'feature' THEN 		'功能测试'  		WHEN t1.`TYPE` = 'performance' THEN 		'性能测试'  		WHEN t1.`TYPE` = 'config' THEN 		'配置相关'  		WHEN t1.`TYPE` = 'nstall' THEN 		'安装部署'  		WHEN t1.`TYPE` = '	security' THEN 		'安全相关'  		WHEN t1.`TYPE` = 'interface' THEN 		'接口测试'  		WHEN t1.`TYPE` = 'unit' THEN 		'单元测试'  		WHEN t1.`TYPE` = 'other' THEN 		'其他'  	END AS `TYPE`, 	t1.`VERSION`  FROM 	`zt_case` t1 	LEFT JOIN zt_module t11 ON t1.MODULE = t11.MODULESN 	LEFT JOIN zt_story t21 ON t1.STORY = t21.STORYSN 	LEFT JOIN zt_product t31 ON t1.PRODUCT = t31.productsn 	LEFT JOIN zt_testsuite t41 ON t1.LIB = t41.TESTSUITESN 	LEFT JOIN zt_testrun t51 ON t51.`case` = t1.CASESN 	LEFT JOIN zt_testreport t61 ON t51.task = t61.tasks ]]>
		<trim prefix="where" prefixOverrides="and">
			<if test="true">
                <![CDATA[ AND t1.DELETED = '0' ]]>
            </if>
			<if test="true">
                <![CDATA[ AND t61.TESTREPORTSN = $ { srfwebcontext ( 'srfparentkey', '{\"defname\":\"PATH\",\"dename\":\"ZT_CASE\"}' ) } ]]>
            </if>
			<include refid="searchMode" />
		</trim>
    </sql>
	
	<select id="selectRePortCase"  parameterType="cn.ibizlab.pms.core.zentao.filter.CaseSearchContext" resultMap="CaseResultMap">
		<include refid="RePortCase" />
	</select>

    <!--数据查询[RePortCaseEntry]-->
    <sql id="RePortCaseEntry" databaseId="mysql">
		<![CDATA[ select t1.lastRunResult1,t1.RESULTCNT as RESULTCNT, t1.PRODUCT,CONCAT(ROUND(t1.RESULTCNT / t1.sss * 100, 2),'','%') as TASK from (SELECT 	t1.PRODUCT, 	t1.lastRunResult1, 	t1.RESULTCNT, 	( SELECT 	COUNT( 1 )  FROM 	zt_case ttt  LEFT JOIN zt_testrun t51 on t51.`case` = ttt.CASESN LEFT JOIN zt_testreport t61 on t51.task = t61.tasks WHERE 	t61.TESTREPORTSN = #{srf.webcontext.srfparentkey}  	AND ttt.DELETED = '0'  	) AS sss  FROM 	( SELECT 	t1.PRODUCT, 	t1.lastRunResult1, 	count( t1.lastRunResult1 ) AS RESULTCNT  FROM 	( SELECT 	t1.`PRODUCT`, CASE 	 	WHEN t1.`TYPE` = 'feature' THEN 	'功能测试'  	WHEN t1.`TYPE` = 'performance' THEN 	'性能测试'  	WHEN t1.`TYPE` = 'config' THEN 	'配置相关'  	WHEN t1.`TYPE` = 'nstall' THEN 	'安装部署'  	WHEN t1.`TYPE` = '	security' THEN 	'安全相关'  	WHEN t1.`TYPE` = 'interface' THEN 	'接口测试'  	WHEN t1.`TYPE` = 'unit' THEN 	'单元测试'  	WHEN t1.`TYPE` = 'other' THEN 	'其他'  	END AS `lastRunResult1`  FROM 	`zt_case` t1          LEFT JOIN zt_testrun t51 on t51.`case` = t1.CASESN         LEFT JOIN zt_testreport t61 on t51.task = t61.tasks WHERE 	t61.TESTREPORTSN = #{srf.webcontext.srfparentkey} 	AND t1.DELETED = '0'  	) t1  GROUP BY 	t1.lastRunResult1  ) t1) t1 ]]>
		<trim prefix="where" prefixOverrides="and">
			<include refid="searchMode" />
		</trim>
    </sql>
	
	<select id="selectRePortCaseEntry"  parameterType="cn.ibizlab.pms.core.zentao.filter.CaseSearchContext" resultMap="CaseResultMap">
		<include refid="RePortCaseEntry" />
	</select>

    <!--数据查询[RePortCase_Project]-->
    <sql id="RePortCase_Project" databaseId="mysql">
		<![CDATA[ SELECT DISTINCT t1.`AUTO`, t1.`id`, t1.`BRANCH`, t1.`COLOR`, t1.`DELETED`, t1.`FRAME`, t1.`FREQUENCY`, t1.`FROMBUG`, t1.`FROMCASEID`, t1.`FROMCASEVERSION`, t1.`HOWRUN`, t1.`CASESN`, 0 AS `ISFAVORITES`, t1.`KEYWORDS`, t1.`LASTEDITEDBY`, t1.`LASTEDITEDDATE`, t1.`LASTRUNDATE`, t1.`LASTRUNNER`, t1.`LASTRUNRESULT`, (case when t1.`LASTRUNRESULT` = '' or t1.`LASTRUNRESULT` is null then 'no' else t1.`LASTRUNRESULT` end) AS `LASTRUNRESULT1`, t1.`LIB`, t41.`NAME` AS `LIBNAME`, t1.`LINKCASE`, t1.`MODULE`, t11.`NAME` AS `MODULENAME`, t1.`OPENEDBY`, t1.`OPENEDDATE`, t1.`ORDER`, t1.`PATH`, t1.`PRI`, t1.`PRODUCT`, t31.`NAME` AS `PRODUCTNAME`, (SELECT COUNT(1) FROM zt_testresult WHERE `case` = t1.`CASESN` ) AS `RESULTCNT`, (SELECT COUNT(1) FROM zt_testresult WHERE `case` = t1.`CASESN`  and caseResult in('fail','blocked') ) AS `RESULTFALICNT`, t1.`REVIEWEDBY`, t1.`REVIEWEDDATE`, t1.`SCRIPTEDBY`, t1.`SCRIPTEDDATE`, t1.`SCRIPTLOCATION`, t1.`SCRIPTSTATUS`, t1.`STAGE`, t1.`STATUS`, (case when t1.storyVersion < t21.version and t21.`status` <> 'changed' then 'storychange'  else t1.`status` end ) AS `STATUS1`, (SELECT COUNT(1) FROM zt_casestep WHERE `case` = t1.`CASESN` AND version = t1.`VERSION` ) AS `STEPCNT`, t1.`STORY`, t21.`TITLE` AS `STORYNAME`, t1.`STORYVERSION`, t1.`SUBSTATUS`, t1.`TITLE`, (SELECT COUNT(1) FROM zt_bug WHERE `case` = t1.`CASESN` ) AS `TOBUGCNT`, case when t1.`TYPE` = 'feature' then '功能测试' when t1.`TYPE` = 'performance' then '性能测试' when t1.`TYPE` = 'config' then '配置相关' when t1.`TYPE` = 'nstall' then '安装部署' when t1.`TYPE` = '	security' then '安全相关' when t1.`TYPE` = 'interface' then '接口测试' when t1.`TYPE` = 'unit' then '单元测试' when t1.`TYPE` = 'other' then '其他' end  as `TYPE`, t1.`VERSION` FROM `zt_case` t1  LEFT JOIN zt_module t11 ON t1.MODULE = t11.MODULESN  LEFT JOIN zt_story t21 ON t1.STORY = t21.STORYSN  LEFT JOIN zt_product t31 ON t1.PRODUCT = t31.productsn  LEFT JOIN zt_testsuite t41 ON t1.LIB = t41.TESTSUITESN LEFT JOIN zt_testrun t51 on t51.`case` = t1.CASESN LEFT JOIN zt_testreport t61 on FIND_IN_SET(t51.task, t61.tasks) ]]>
		<trim prefix="where" prefixOverrides="and">
			<if test="true">
                <![CDATA[ AND t1.DELETED = '0' ]]>
            </if>
			<if test="true">
                <![CDATA[ AND t61.TESTREPORTSN = #{srf.webcontext.srfparentkey} ]]>
            </if>
			<include refid="searchMode" />
		</trim>
    </sql>
	
	<select id="selectRePortCase_Project"  parameterType="cn.ibizlab.pms.core.zentao.filter.CaseSearchContext" resultMap="CaseResultMap">
		<include refid="RePortCase_Project" />
	</select>

    <!--数据查询[RunERRePortCase]-->
    <sql id="RunERRePortCase" databaseId="mysql">
		<![CDATA[ SELECT 	t1.`AUTO`,         t1.`id`, 	t1.`BRANCH`, 	t1.`COLOR`, 	t1.`DELETED`, 	t1.`FRAME`, 	t1.`FREQUENCY`, 	t1.`FROMBUG`, 	t1.`FROMCASEID`, 	t1.`FROMCASEVERSION`, 	t1.`HOWRUN`, 	t1.`CASESN`, 	0 AS `ISFAVORITES`, 	t1.`KEYWORDS`, 	t1.`LASTEDITEDBY`, 	t1.`LASTEDITEDDATE`, 	t71.date AS `LASTRUNDATE`, 	t81.realname AS `LASTRUNNER`, 	t71.caseResult AS `LASTRUNRESULT`, 	( CASE WHEN t71.`caseResult` = '' OR t71.`caseResult` IS NULL THEN 'no' ELSE t71.`caseResult` END ) AS `LASTRUNRESULT1`, 	t1.`LIB`, 	t41.`NAME` AS `LIBNAME`, 	t1.`LINKCASE`, 	t1.`MODULE`, 	t11.`NAME` AS `MODULENAME`, 	t1.`OPENEDBY`, 	t1.`OPENEDDATE`, 	t1.`ORDER`, 	t1.`PATH`, 	t1.`PRI`, 	t1.`PRODUCT`, 	t31.`NAME` AS `PRODUCTNAME`, 	( SELECT COUNT( 1 ) FROM zt_testresult WHERE `case` = t1.`CASESN` ) AS `RESULTCNT`, 	( SELECT COUNT( 1 ) FROM zt_testresult WHERE `case` = t1.`CASESN` AND caseResult IN ( 'fail', 'blocked' ) ) AS `RESULTFALICNT`, 	t1.`REVIEWEDBY`, 	t1.`REVIEWEDDATE`, 	t1.`SCRIPTEDBY`, 	t1.`SCRIPTEDDATE`, 	t1.`SCRIPTLOCATION`, 	t1.`SCRIPTSTATUS`, 	t1.`STAGE`, 	t1.`STATUS`, 	( CASE WHEN t1.storyVersion < t21.version AND t21.`status` <> 'changed' THEN 'storychange' ELSE t1.`status` END ) AS `STATUS1`, 	( SELECT COUNT( 1 ) FROM zt_casestep WHERE `case` = t1.`CASESN` AND version = t1.`VERSION` ) AS `STEPCNT`, 	t1.`STORY`, 	t21.`TITLE` AS `STORYNAME`, 	t1.`STORYVERSION`, 	t1.`SUBSTATUS`, 	t1.`TITLE`, 	( SELECT COUNT( 1 ) FROM zt_bug WHERE `case` = t1.`CASESN` ) AS `TOBUGCNT`, 	t1.`TYPE`, 	t1.`VERSION`  FROM 	`zt_case` t1 	LEFT JOIN zt_module t11 ON t1.MODULE = t11.MODULESN 	LEFT JOIN zt_story t21 ON t1.STORY = t21.STORYSN 	LEFT JOIN zt_product t31 ON t1.PRODUCT = t31.productsn 	LEFT JOIN zt_testsuite t41 ON t1.LIB = t41.TESTSUITESN 	LEFT JOIN zt_testrun t61 ON t61.`case` = t1.CASESN 	LEFT JOIN zt_testresult t71 ON t61.TESTRUNSN = t71.run  	AND t71.`case` = t1.CASESN 	LEFT JOIN zt_user t81 ON t71.lastRunner = t81.account 	INNER JOIN zt_testreport t91 ON t61.task = t91.tasks ]]>
		<trim prefix="where" prefixOverrides="and">
			<if test="true">
                <![CDATA[ AND t1.DELETED = '0' ]]>
            </if>
			<if test="true">
                <![CDATA[ AND 	t91.TESTREPORTSN = $ { srfwebcontext ( 'srfparentkey', '{\"defname\":\"PATH\",\"dename\":\"ZT_CASE\"}' ) }  	AND ( FIND_IN_SET( t1.CASESN, t91.cases ) )  	AND t71.date > t91.`begin`  	AND t71.date < t91.`end` ]]>
            </if>
			<include refid="searchMode" />
		</trim>
    </sql>
	
	<select id="selectRunERRePortCase"  parameterType="cn.ibizlab.pms.core.zentao.filter.CaseSearchContext" resultMap="CaseResultMap">
		<include refid="RunERRePortCase" />
	</select>

    <!--数据查询[RunERRePortCaseEntry]-->
    <sql id="RunERRePortCaseEntry" databaseId="mysql">
		<![CDATA[ SELECT 	t1.lastRunResult1, 	t1.RESULTCNT AS RESULTCNT, 	t1.PRODUCT, 	CONCAT( ROUND( t1.RESULTCNT / t1.sss * 100, 2 ), '', '%' ) AS TASK  FROM 	( 	SELECT 		t1.PRODUCT, 		t1.lastRunResult1, 		t1.RESULTCNT, 		( 		SELECT 			count( 1 )  		FROM 			`zt_case` t1 			LEFT JOIN zt_testrun t61 ON t61.`case` = t1.CASESN 			LEFT JOIN zt_testresult t71 ON t61.TESTRUNSN = t71.run  			AND t71.`case` = t1.CASESN 			LEFT JOIN zt_user t81 ON t71.lastRunner = t81.account  		WHERE 			t1.DELETED = '0'  			AND ( 				FIND_IN_SET( 					t1.CASESN, 					( 					SELECT 						tt.cases  					FROM 						zt_testreport tt  				WHERE 	tt.TESTREPORTSN = #{srf.webcontext.srfparentkey} ) ) )  					 					AND t61.task = ( 						SELECT 							tt.tasks  						FROM 							zt_testreport tt  						WHERE 						tt.TESTREPORTSN = #{srf.webcontext.srfparentkey} ) ) as sss from (SELECT t1.PRODUCT, t1.lastRunResult1, count( t1.lastRunResult1 ) AS RESULTCNT FROM ( SELECT t81.realname AS `lastRunResult1`, t1.`PRODUCT` FROM `zt_case` t1 LEFT JOIN zt_testrun t61 ON t61.`case` = t1.CASESN LEFT JOIN zt_testresult t71 ON t61.TESTRUNSN = t71.run 	AND t71.`case` = t1.CASESN LEFT JOIN zt_user t81 ON t71.lastRunner = t81.account WHERE t1.DELETED = '0'  	AND ( FIND_IN_SET( t1.CASESN, ( SELECT tt.cases FROM zt_testreport tt WHERE tt.TESTREPORTSN = #{srf.webcontext.srfparentkey} ) ) )  	AND t61.task = ( SELECT tt.tasks FROM zt_testreport tt WHERE tt.TESTREPORTSN = #{srf.webcontext.srfparentkey} ) ) t1 GROUP BY t1.LASTRUNRESULT1) t1) t1 ]]>
		<trim prefix="where" prefixOverrides="and">
			<include refid="searchMode" />
		</trim>
    </sql>
	
	<select id="selectRunERRePortCaseEntry"  parameterType="cn.ibizlab.pms.core.zentao.filter.CaseSearchContext" resultMap="CaseResultMap">
		<include refid="RunERRePortCaseEntry" />
	</select>

    <!--数据查询[RunERRePortCase_Project]-->
    <sql id="RunERRePortCase_Project" databaseId="mysql">
		<![CDATA[ SELECT  t1.`AUTO`, t1.`id`, t1.`BRANCH`, t1.`COLOR`, t1.`DELETED`, t1.`FRAME`, t1.`FREQUENCY`, t1.`FROMBUG`, t1.`FROMCASEID`, t1.`FROMCASEVERSION`, t1.`HOWRUN`, t1.`CASESN`, 0 AS `ISFAVORITES`, t1.`KEYWORDS`, t1.`LASTEDITEDBY`, t1.`LASTEDITEDDATE`, t71.date AS `LASTRUNDATE`, t81.realname as `LASTRUNNER`, t71.caseResult AS `LASTRUNRESULT`, (case when t71.`caseResult` = '' or t71.`caseResult` is null then 'no' else t71.`caseResult` end) AS `LASTRUNRESULT1`, t1.`LIB`, t41.`NAME` AS `LIBNAME`, t1.`LINKCASE`, t1.`MODULE`, t11.`NAME` AS `MODULENAME`, t1.`OPENEDBY`, t1.`OPENEDDATE`, t1.`ORDER`, t1.`PATH`, t1.`PRI`, t1.`PRODUCT`, t31.`NAME` AS `PRODUCTNAME`, (SELECT COUNT(1) FROM zt_testresult WHERE `case` = t1.`CASESN` ) AS `RESULTCNT`, (SELECT COUNT(1) FROM zt_testresult WHERE `case` = t1.`CASESN`  and caseResult in('fail','blocked') ) AS `RESULTFALICNT`, t1.`REVIEWEDBY`, t1.`REVIEWEDDATE`, t1.`SCRIPTEDBY`, t1.`SCRIPTEDDATE`, t1.`SCRIPTLOCATION`, t1.`SCRIPTSTATUS`, t1.`STAGE`, t1.`STATUS`, (case when t1.storyVersion < t21.version and t21.`status` <> 'changed' then 'storychange'  else t1.`status` end ) AS `STATUS1`, (SELECT COUNT(1) FROM zt_casestep WHERE `case` = t1.`CASESN` AND version = t1.`VERSION` ) AS `STEPCNT`, t1.`STORY`, t21.`TITLE` AS `STORYNAME`, t1.`STORYVERSION`, t1.`SUBSTATUS`, t1.`TITLE`, (SELECT COUNT(1) FROM zt_bug WHERE `case` = t1.`CASESN` ) AS `TOBUGCNT`, t1.`TYPE`, t1.`VERSION` FROM `zt_case` t1  LEFT JOIN zt_module t11 ON t1.MODULE = t11.MODULESN  LEFT JOIN zt_story t21 ON t1.STORY = t21.STORYSN  LEFT JOIN zt_product t31 ON t1.PRODUCT = t31.productsn  LEFT JOIN zt_testsuite t41 ON t1.LIB = t41.TESTSUITESN  LEFT JOIN zt_testrun t61 on t61.`case` = t1.CASESN  LEFT JOIN zt_testresult t71 on t61.TESTRUNSN = t71.run AND t71.`case` = t1.CASESN LEFT JOIN zt_user t81 on t71.lastRunner = t81.account INNER JOIN zt_testreport t91 ON FIND_IN_SET( t61.task, t91.tasks ) ]]>
		<trim prefix="where" prefixOverrides="and">
			<if test="true">
                <![CDATA[ AND t1.DELETED = '0' ]]>
            </if>
			<if test="true">
                <![CDATA[ AND 	t91.testreport = $ { srfwebcontext ( 'srfparentkey', '{\"defname\":\"PATH\",\"dename\":\"ZT_CASE\"}' ) }  	AND ( FIND_IN_SET( t1.CASESN, t91.cases ) )  	AND t71.date > t91.`begin`  	AND t71.date < CONCAT( DATE_FORMAT( t91.`end`, '%Y-%m-%d' ), ' 23:59:59' ) ]]>
            </if>
			<include refid="searchMode" />
		</trim>
    </sql>
	
	<select id="selectRunERRePortCase_Project"  parameterType="cn.ibizlab.pms.core.zentao.filter.CaseSearchContext" resultMap="CaseResultMap">
		<include refid="RunERRePortCase_Project" />
	</select>

    <!--数据查询[RunRePortCase]-->
    <sql id="RunRePortCase" databaseId="mysql">
		<![CDATA[ SELECT 	t1.`AUTO`,         t1.`id`, 	t1.`BRANCH`, 	t1.`COLOR`, 	t1.`DELETED`, 	t1.`FRAME`, 	t1.`FREQUENCY`, 	t1.`FROMBUG`, 	t1.`FROMCASEID`, 	t1.`FROMCASEVERSION`, 	t1.`HOWRUN`, 	t1.`CASESN`, 	0 AS `ISFAVORITES`, 	t1.`KEYWORDS`, 	t1.`LASTEDITEDBY`, 	t1.`LASTEDITEDDATE`, 	t71.date AS `LASTRUNDATE`, 	t71.`LASTRUNNER`, 	t71.caseResult AS `LASTRUNRESULT`, CASE 		 		WHEN t71.caseResult = 'n/a' THEN 		'忽略'  		WHEN t71.caseResult = 'pass' THEN 		'通过'  		WHEN t71.caseResult = 'fail' THEN 		'失败'  		WHEN t71.caseResult = 'blocked' THEN 		'阻塞'  	END AS `LASTRUNRESULT1`, 	t1.`LIB`, 	t41.`NAME` AS `LIBNAME`, 	t1.`LINKCASE`, 	t1.`MODULE`, 	t11.`NAME` AS `MODULENAME`, 	t1.`OPENEDBY`, 	t1.`OPENEDDATE`, 	t1.`ORDER`, 	t1.`PATH`, 	t1.`PRI`, 	t1.`PRODUCT`, 	t31.`NAME` AS `PRODUCTNAME`, 	( SELECT COUNT( 1 ) FROM zt_testresult WHERE `case` = t1.`CASESN` ) AS `RESULTCNT`, 	( SELECT COUNT( 1 ) FROM zt_testresult WHERE `case` = t1.`CASESN` AND caseResult IN ( 'fail', 'blocked' ) ) AS `RESULTFALICNT`, 	t1.`REVIEWEDBY`, 	t1.`REVIEWEDDATE`, 	t1.`SCRIPTEDBY`, 	t1.`SCRIPTEDDATE`, 	t1.`SCRIPTLOCATION`, 	t1.`SCRIPTSTATUS`, 	t1.`STAGE`, 	t1.`STATUS`, 	( CASE WHEN t1.storyVersion < t21.version AND t21.`status` <> 'changed' THEN 'storychange' ELSE t1.`status` END ) AS `STATUS1`, 	( SELECT COUNT( 1 ) FROM zt_casestep WHERE `case` = t1.`CASESN` AND version = t1.`VERSION` ) AS `STEPCNT`, 	t1.`STORY`, 	t21.`TITLE` AS `STORYNAME`, 	t1.`STORYVERSION`, 	t1.`SUBSTATUS`, 	t1.`TITLE`, 	( SELECT COUNT( 1 ) FROM zt_bug WHERE `case` = t1.`CASESN` ) AS `TOBUGCNT`, 	t1.`TYPE`, 	t1.`VERSION`  FROM 	`zt_case` t1 	LEFT JOIN zt_module t11 ON t1.MODULE = t11.MODULESN 	LEFT JOIN zt_story t21 ON t1.STORY = t21.STORYSN 	LEFT JOIN zt_product t31 ON t1.PRODUCT = t31.productsn 	LEFT JOIN zt_testsuite t41 ON t1.LIB = t41.TESTSUITESN 	LEFT JOIN zt_testrun t61 ON t61.`case` = t1.CASESN 	LEFT JOIN zt_testresult t71 ON t61.TESTRUNSN = t71.run  	AND t71.`case` = t1.CASESN 	INNER JOIN zt_testreport t81 ON t61.task = t81.tasks ]]>
		<trim prefix="where" prefixOverrides="and">
			<if test="true">
                <![CDATA[ AND t1.DELETED = '0' ]]>
            </if>
			<if test="true">
                <![CDATA[ AND 	t81.TESTREPORTSN = $ { srfwebcontext ( 'srfparentkey', '{\"defname\":\"PATH\",\"dename\":\"ZT_CASE\"}' ) }  	AND ( FIND_IN_SET( t1.CASESN, t81.cases ) )  	AND t71.date > t81.`begin`  	AND t71.date < t81.`end` ]]>
            </if>
			<include refid="searchMode" />
		</trim>
    </sql>
	
	<select id="selectRunRePortCase"  parameterType="cn.ibizlab.pms.core.zentao.filter.CaseSearchContext" resultMap="CaseResultMap">
		<include refid="RunRePortCase" />
	</select>

    <!--数据查询[RunRePortCaseEntry]-->
    <sql id="RunRePortCaseEntry" databaseId="mysql">
		<![CDATA[ select  t1.lastRunResult1,t1.product,t1.RESULTCNT as RESULTCNT, CONCAT(ROUND(t1.RESULTCNT / t1.sss * 100, 2),'','%') as TASK from (SELECT 	t1.*, 	( SELECT 	count( 1 )  FROM 	( SELECT  CASE 	 WHEN 	t71.caseResult = 'n/a' THEN 	'忽略'  WHEN t71.caseResult = 'pass' THEN '通过'  WHEN t71.caseResult = 'fail' THEN '失败'  WHEN t71.caseResult = 'blocked' THEN '阻塞'  END AS `LASTRUNRESULT1`  FROM 	`zt_case` t1 	LEFT JOIN zt_testrun t61 ON t61.`case` = t1.CASESN 	LEFT JOIN zt_testresult t71 ON t61.TESTRUNSN = t71.run  	AND t71.`case` = t1.CASESN  WHERE 	t1.DELETED = '0'  	AND ( FIND_IN_SET( t1.CASESN, ( SELECT tt.cases FROM zt_testreport tt WHERE tt.TESTREPORTSN = #{srf.webcontext.srfparentkey} ) ) )  	AND t61.task = ( SELECT tt.tasks FROM zt_testreport tt WHERE tt.TESTREPORTSN = #{srf.webcontext.srfparentkey} )  	) tt1  	) AS sss  FROM 	( 	SELECT 		t1.LASTRUNRESULT1, t1.product, 		count( t1.LASTRUNRESULT1 ) AS RESULTCNT  	FROM 		( 		SELECT t1.product, 		CASE 				 			WHEN 				t71.caseResult = 'n/a' THEN 					'忽略'  					WHEN t71.caseResult = 'pass' THEN 					'通过'  					WHEN t71.caseResult = 'fail' THEN 					'失败'  					WHEN t71.caseResult = 'blocked' THEN 					'阻塞'  				END AS `LASTRUNRESULT1`  			FROM 				`zt_case` t1 				LEFT JOIN zt_testrun t61 ON t61.`case` = t1.CASESN 				LEFT JOIN zt_testresult t71 ON t61.TESTRUNSN = t71.run  				AND t71.`case` = t1.CASESN  			WHERE 				t1.DELETED = '0'  				AND ( FIND_IN_SET( t1.CASESN, ( SELECT tt.cases FROM zt_testreport tt WHERE tt.TESTREPORTSN = #{srf.webcontext.srfparentkey} ) ) )  				AND t61.task = ( SELECT tt.tasks FROM zt_testreport tt WHERE tt.TESTREPORTSN = #{srf.webcontext.srfparentkey} )  			) t1  		GROUP BY 		t1.LASTRUNRESULT1  ) t1) t1 ]]>
		<trim prefix="where" prefixOverrides="and">
			<include refid="searchMode" />
		</trim>
    </sql>
	
	<select id="selectRunRePortCaseEntry"  parameterType="cn.ibizlab.pms.core.zentao.filter.CaseSearchContext" resultMap="CaseResultMap">
		<include refid="RunRePortCaseEntry" />
	</select>

    <!--数据查询[RunRePortCase_Project]-->
    <sql id="RunRePortCase_Project" databaseId="mysql">
		<![CDATA[ SELECT 	t1.`AUTO`,         t1.`id`, 	t1.`BRANCH`, 	t1.`COLOR`, 	t1.`DELETED`, 	t1.`FRAME`, 	t1.`FREQUENCY`, 	t1.`FROMBUG`, 	t1.`FROMCASEID`, 	t1.`FROMCASEVERSION`, 	t1.`HOWRUN`, 	t1.`CASESN`, 	0 AS `ISFAVORITES`, 	t1.`KEYWORDS`, 	t1.`LASTEDITEDBY`, 	t1.`LASTEDITEDDATE`, 	t71.date AS `LASTRUNDATE`, 	t71.`LASTRUNNER`, 	t71.caseResult AS `LASTRUNRESULT`, CASE 		 		WHEN t71.caseResult = 'n/a' THEN 		'忽略'  		WHEN t71.caseResult = 'pass' THEN 		'通过'  		WHEN t71.caseResult = 'fail' THEN 		'失败'  		WHEN t71.caseResult = 'blocked' THEN 		'阻塞'  	END AS `LASTRUNRESULT1`, 	t1.`LIB`, 	t41.`NAME` AS `LIBNAME`, 	t1.`LINKCASE`, 	t1.`MODULE`, 	t11.`NAME` AS `MODULENAME`, 	t1.`OPENEDBY`, 	t1.`OPENEDDATE`, 	t1.`ORDER`, 	t1.`PATH`, 	t1.`PRI`, 	t1.`PRODUCT`, 	t31.`NAME` AS `PRODUCTNAME`, 	( SELECT COUNT( 1 ) FROM zt_testresult WHERE `case` = t1.`CASESN` ) AS `RESULTCNT`, 	( SELECT COUNT( 1 ) FROM zt_testresult WHERE `case` = t1.`CASESN` AND caseResult IN ( 'fail', 'blocked' ) ) AS `RESULTFALICNT`, 	t1.`REVIEWEDBY`, 	t1.`REVIEWEDDATE`, 	t1.`SCRIPTEDBY`, 	t1.`SCRIPTEDDATE`, 	t1.`SCRIPTLOCATION`, 	t1.`SCRIPTSTATUS`, 	t1.`STAGE`, 	t1.`STATUS`, 	( CASE WHEN t1.storyVersion < t21.version AND t21.`status` <> 'changed' THEN 'storychange' ELSE t1.`status` END ) AS `STATUS1`, 	( SELECT COUNT( 1 ) FROM zt_casestep WHERE `case` = t1.`CASESN` AND version = t1.`VERSION` ) AS `STEPCNT`, 	t1.`STORY`, 	t21.`TITLE` AS `STORYNAME`, 	t1.`STORYVERSION`, 	t1.`SUBSTATUS`, 	t1.`TITLE`, 	( SELECT COUNT( 1 ) FROM zt_bug WHERE `case` = t1.`CASESN` ) AS `TOBUGCNT`, 	t1.`TYPE`, 	t1.`VERSION`  FROM 	`zt_case` t1 	LEFT JOIN zt_module t11 ON t1.MODULE = t11.MODULESN 	LEFT JOIN zt_story t21 ON t1.STORY = t21.STORYSN 	LEFT JOIN zt_product t31 ON t1.PRODUCT = t31.productsn 	LEFT JOIN zt_testsuite t41 ON t1.LIB = t41.TESTSUITESN 	LEFT JOIN zt_testrun t61 ON t61.`case` = t1.CASESN 	LEFT JOIN zt_testresult t71 ON t61.TESTRUNSN = t71.run  	AND t71.`case` = t1.CASESN 	INNER JOIN zt_testreport t81 ON FIND_IN_SET( t61.task, t81.tasks ) ]]>
		<trim prefix="where" prefixOverrides="and">
			<if test="true">
                <![CDATA[ AND t1.DELETED = '0' ]]>
            </if>
			<if test="true">
                <![CDATA[ AND 	t81.TESTREPORTSN = $ { srfwebcontext ( 'srfparentkey', '{\"defname\":\"PATH\",\"dename\":\"ZT_CASE\"}' ) }  	AND ( FIND_IN_SET( t1.CASESN, t81.cases ) )  	AND t71.date > t81.`begin`  	AND t71.date < CONCAT( DATE_FORMAT( t81.`end`, '%Y-%m-%d' ), ' 23:59:59' ) ]]>
            </if>
			<include refid="searchMode" />
		</trim>
    </sql>
	
	<select id="selectRunRePortCase_Project"  parameterType="cn.ibizlab.pms.core.zentao.filter.CaseSearchContext" resultMap="CaseResultMap">
		<include refid="RunRePortCase_Project" />
	</select>

    <!--数据查询[View]-->
    <sql id="View" databaseId="mysql">
		<![CDATA[ SELECT t1.`AUTO`, t1.`BRANCH`, t1.`CASESN`, t1.`COLOR`, t1.`DELETED`, t1.`DEPT`, t1.`DEPTNAME`, t1.`FRAME`, t1.`FREQUENCY`, t1.`FROMBUG`, t1.`FROMCASEID`, t1.`FROMCASEVERSION`, t1.`HOWRUN`, t1.`ID`, 0 AS `ISFAVORITES`, t1.`KEYWORDS`, t1.`LASTEDITEDBY`, t1.`LASTEDITEDDATE`, t1.`LASTRUNDATE`, t1.`LASTRUNNER`, t1.`LASTRUNRESULT`, (case when t1.`LASTRUNRESULT` = '' or t1.`LASTRUNRESULT` is null then 'no' else t1.`LASTRUNRESULT` end) AS `LASTRUNRESULT1`, t1.`LIB`, t11.`NAME` AS `LIBNAME`, t1.`LINKCASE`, t1.`MODULE`, t31.`NAME` AS `MODULENAME`, (case when t1.module = '0' then '/' else (SELECT GROUP_CONCAT( tt.NAME SEPARATOR '>' )  FROM zt_module tt WHERE FIND_IN_SET( tt.id, t31.path ) AND tt.type = 'story'  GROUP BY tt.root limit 0,1) end) AS `MODULENAME1`, t1.`OPENEDBY`, t1.`OPENEDDATE`, t1.`ORDER`, t1.`ORG`, t1.`ORGNAME`, t1.`PATH`, t1.`PRECONDITION`, t1.`PRI`, t1.`PRODUCT`, t41.`name` AS `PRODUCTNAME`, (SELECT COUNT(1) FROM zt_testresult WHERE `case` = t1.`ID` ) AS `RESULTCNT`, (SELECT COUNT(1) FROM zt_testresult WHERE `case` = t1.`ID`  and caseResult in('fail','blocked') ) AS `RESULTFALICNT`, t1.`REVIEWEDBY`, t1.`REVIEWEDDATE`, t1.`SCRIPTEDBY`, t1.`SCRIPTEDDATE`, t1.`SCRIPTLOCATION`, t1.`SCRIPTSTATUS`, t1.`STAGE`, t1.`STATUS`, (case when t1.storyVersion < t21.version and t21.`status` <> 'changed' then 'storychange'  else t1.`status` end ) AS `STATUS1`, (SELECT COUNT(1) FROM zt_casestep WHERE `case` = t1.`ID` AND version = t1.`VERSION` ) AS `STEPCNT`, t1.`STORY`, t21.`TITLE` AS `STORYNAME`, t1.`STORYVERSION`, t1.`SUBSTATUS`, t1.`TITLE`, (SELECT COUNT(1) FROM zt_bug WHERE `case` = t1.`ID` ) AS `TOBUGCNT`, t1.`TYPE`, t1.`VERSION` FROM `zt_case` t1  LEFT JOIN `zt_testsuite` t11 ON t1.`LIB` = t11.`TESTSUITESN`  LEFT JOIN `zt_story` t21 ON t1.`STORY` = t21.`STORYSN`  LEFT JOIN `zt_module` t31 ON t1.`MODULE` = t31.`MODULESN`  LEFT JOIN `zt_product` t41 ON t1.`PRODUCT` = t41.`productsn`   ]]>
		<trim prefix="where" prefixOverrides="and">
			<if test="true">
                <![CDATA[ AND t1.DELETED = '0' ]]>
            </if>
			<include refid="searchMode" />
		</trim>
    </sql>
	
	<select id="selectView"  parameterType="cn.ibizlab.pms.core.zentao.filter.CaseSearchContext" resultMap="CaseResultMap">
		<include refid="View" />
	</select>

</mapper>

