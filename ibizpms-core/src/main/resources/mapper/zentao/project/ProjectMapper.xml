<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper	namespace="cn.ibizlab.pms.core.zentao.mapper.ProjectMapper">
	
	<!-- 无视图模式 -->
	<sql id="select" databaseId="mysql">
        <![CDATA[ SELECT t1.`ACL`, t1.`BEGIN`, (SELECT COUNT(1) FROM ZT_BUG WHERE PROJECT = t1.`ID` AND DELETED = '0') AS `BUGCNT`, t1.`CANCELEDBY`, t1.`CANCELEDDATE`, t1.`CATID`, t1.`CLOSEDBY`, t1.`CLOSEDDATE`, t1.`CODE`, t1.`DAYS`, t1.`DELETED`, t1.`DESC`, t1.`END`, t1.`ID`, t1.`ISCAT`, '0' AS `ISTOP`, t1.`MDEPTID`, t1.`MDEPTNAME`, t1.`NAME`, t1.`OPENEDBY`, t1.`OPENEDDATE`, t1.`OPENEDVERSION`, t1.`ORDER`, t1.`order` AS `ORDER1`, t1.`ORGID`, t1.`ORGNAME`, t1.`PARENT`, t11.`NAME` AS `PARENTNAME`, t1.`PM`, t1.`PMSEEPROJECTINFO`, t1.`PO`, t1.`PRI`, t1.`PROJECTSN`, t1.`QD`, t1.`RD`, t1.`STATGE`, t1.`STATUS`, (SELECT COUNT(1) FROM ZT_STORY LEFT JOIN ZT_PROJECTSTORY ON ZT_STORY.ID = ZT_PROJECTSTORY.STORY WHERE PROJECT = t1.`ID` AND DELETED = '0') AS `STORYCNT`, t1.`SUBSTATUS`, t1.`SUPPROREPORT`, (SELECT COUNT(1) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0') AS `TASKCNT`, t1.`TEAM`, (SELECT round(SUM(CONSUMED),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0' AND ( `parent` = '' or `parent` = '0' or `parent` = '-1')) AS `TOTALCONSUMED`, (SELECT round(SUM(ESTIMATE),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED =  '0' AND ( `parent` = '' or `parent` = '0' or `parent` = '-1')) AS `TOTALESTIMATE`, (select sum(days * hours)  from zt_team tt where type = 'project' and root = t1.id) AS `TOTALHOURS`, (SELECT round(SUM(`LEFT`),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0' and `status` in ('doing','wait','pause') AND ( `parent` = '' or `parent` = '0' or `parent` = '-1')) AS `TOTALLEFT`, ((SELECT round(SUM( `LEFT` ),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0' AND ( `parent` = '' OR `parent` = '0' OR `parent` = '-1' ) AND `status` in ('doing','wait','pause')) + (SELECT round(SUM( CONSUMED ),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0' AND ( `parent` = '' OR `parent` = '0' OR `parent` = '-1' ))) AS `TOTALWH`, t1.`TYPE`, t1.`UPDATEBY`, t1.`WHITELIST` FROM `zt_project` t1  LEFT JOIN `zt_project` t11 ON t1.`PARENT` = t11.`ID`   ]]>
    </sql>

	
	<!-- 搜索条件 -->
	<sql id="searchMode" databaseId="mysql">
		<if test="srf.n_acl_eq != null ">
			<![CDATA[ AND  t1.`ACL` = #{srf.n_acl_eq,jdbcType=VARCHAR} ]]>
        </if>
		<if test="srf.n_istop_eq != null ">
			<![CDATA[ AND  '0' = #{srf.n_istop_eq,jdbcType=INTEGER} ]]>
        </if>
		<if test="srf.n_pm_eq != null ">
			<![CDATA[ AND  t1.`PM` = #{srf.n_pm_eq,jdbcType=VARCHAR} ]]>
        </if>
		<if test="srf.n_id_eq != null ">
			<![CDATA[ AND  t1.`ID` = #{srf.n_id_eq,jdbcType=BIGINT} ]]>
        </if>
		<if test="srf.n_id_in != null ">
			<![CDATA[ AND  t1.`ID` IN ]]>
            <foreach item="item" collection="srf.n_id_in.split(',|;')"  open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
		<if test="srf.n_id_noteq != null ">
			<![CDATA[ AND  t1.`ID` <> #{srf.n_id_noteq,jdbcType=BIGINT} ]]>
        </if>
		<if test="srf.n_name_eq != null ">
			<![CDATA[ AND  t1.`NAME` = #{srf.n_name_eq,jdbcType=VARCHAR} ]]>
        </if>
		<if test="srf.n_name_like != null ">
            <bind name="bind_n_name_like" value="'%' + srf.n_name_like + '%'" />
            <![CDATA[ AND  t1.`NAME` like #{bind_n_name_like,jdbcType=VARCHAR} ]]>
        </if>
		<if test="srf.n_rd_eq != null ">
			<![CDATA[ AND  t1.`RD` = #{srf.n_rd_eq,jdbcType=VARCHAR} ]]>
        </if>
		<if test="srf.n_pri_eq != null ">
			<![CDATA[ AND  t1.`PRI` = #{srf.n_pri_eq,jdbcType=VARCHAR} ]]>
        </if>
		<if test="srf.n_statge_eq != null ">
			<![CDATA[ AND  t1.`STATGE` = #{srf.n_statge_eq,jdbcType=VARCHAR} ]]>
        </if>
		<if test="srf.n_supproreport_eq != null ">
			<![CDATA[ AND  t1.`SUPPROREPORT` = #{srf.n_supproreport_eq,jdbcType=VARCHAR} ]]>
        </if>
		<if test="srf.n_iscat_eq != null ">
			<![CDATA[ AND  t1.`ISCAT` = #{srf.n_iscat_eq,jdbcType=VARCHAR} ]]>
        </if>
		<if test="srf.n_type_eq != null ">
			<![CDATA[ AND  t1.`TYPE` = #{srf.n_type_eq,jdbcType=VARCHAR} ]]>
        </if>
		<if test="srf.n_po_eq != null ">
			<![CDATA[ AND  t1.`PO` = #{srf.n_po_eq,jdbcType=VARCHAR} ]]>
        </if>
		<if test="srf.n_status_eq != null ">
			<![CDATA[ AND  t1.`STATUS` = #{srf.n_status_eq,jdbcType=VARCHAR} ]]>
        </if>
		<if test="srf.n_status_noteq != null ">
			<![CDATA[ AND  t1.`STATUS` <> #{srf.n_status_noteq,jdbcType=VARCHAR} ]]>
        </if>
		<if test="srf.n_qd_eq != null ">
			<![CDATA[ AND  t1.`QD` = #{srf.n_qd_eq,jdbcType=VARCHAR} ]]>
        </if>
		<if test="srf.n_parentname_eq != null ">
			<![CDATA[ AND  t11.`NAME` = #{srf.n_parentname_eq,jdbcType=VARCHAR} ]]>
        </if>
		<if test="srf.n_parentname_like != null ">
            <bind name="bind_n_parentname_like" value="'%' + srf.n_parentname_like + '%'" />
            <![CDATA[ AND  t11.`NAME` like #{bind_n_parentname_like,jdbcType=VARCHAR} ]]>
        </if>
		<if test="srf.n_parent_eq != null ">
			<![CDATA[ AND  t1.`PARENT` = #{srf.n_parent_eq,jdbcType=BIGINT} ]]>
        </if>
		<if test="ew!=null and ew.sqlSegment!=null and ew.sqlSegment!=''">
		AND ${ew.sqlSegment}
		</if>
	</sql>


    <!--该方法用于重写mybatis中selectById方法，以实现查询逻辑属性-->
	<select id="selectById"  resultMap="ProjectResultMap" databaseId="mysql">
        <include refid="select" />
		<trim prefix="where" prefixOverrides="and">
			<if test="true">
			<![CDATA[ AND t1.DELETED = '0' ]]>
			</if>
			<![CDATA[ AND T1.ID = #{id} ]]>
		</trim>
    </select>


    <!--通过mybatis将查询结果注入到entity中,通过配置autoMapping="true"由mybatis自动处理映射关系 -->
    <resultMap id="ProjectResultMap" type="cn.ibizlab.pms.core.zentao.domain.Project" autoMapping="true">
		<id property="id" column="id" /><!--主键字段映射-->
		<result property="ystarttaskcnt" column="ystartaskcnt" />
		<result property="parent" column="parent" />
            
		
		<!--通过mybatis自动注入关系属性[主实体]，fetchType="lazy"为懒加载配置 -->
		<association property="ibizparent" javaType="cn.ibizlab.pms.core.zentao.domain.Project" column="parent" select="cn.ibizlab.pms.core.zentao.mapper.ProjectMapper.selectById" fetchType="lazy"></association>
    </resultMap>

	<!--关系实体暴露select方法供主实体通过外键查询关系实体数据[实体关系名称:DER1N__ZT_PROJECT__ZT_PROJECT__PARENT] -->
	 <select id="selectByParent" resultMap="ProjectResultMap"  databaseId="mysql">
		select * from (
        <include refid="select" />
		<trim prefix="where" prefixOverrides="and">
			<if test="true">
			<![CDATA[ AND t1.DELETED = '0' ]]>
			</if>
			<![CDATA[ AND t1.`PARENT`=#{id} ]]>
		</trim>
		 )t1
     </select>

    <!--数据集合[BugProject]-->
	 <select id="searchBugProject"  parameterType="cn.ibizlab.pms.core.zentao.filter.ProjectSearchContext"  resultMap="ProjectResultMap">
         select t1.* from (
                <include refid="BugSelectableProjectList" />
         )t1
     </select>

    <!--数据集合[CurDefaultQuery]-->
	 <select id="searchCurDefaultQuery"  parameterType="cn.ibizlab.pms.core.zentao.filter.ProjectSearchContext"  resultMap="ProjectResultMap">
	 	select * from (
         select t1.* from (
                <include refid="CurDefaultQuery" />
         )t1
		 )t1
     </select>

    <!--数据集合[CurDefaultQueryExp]-->
	 <select id="searchCurDefaultQueryExp"  parameterType="cn.ibizlab.pms.core.zentao.filter.ProjectSearchContext"  resultMap="ProjectResultMap">
	 	select * from (
         select t1.* from (
                <include refid="CurDefaultQueryExp" />
         )t1
		 )t1
     </select>

    <!--数据集合[CurPlanProject]-->
	 <select id="searchCurPlanProject"  parameterType="cn.ibizlab.pms.core.zentao.filter.ProjectSearchContext"  resultMap="ProjectResultMap">
         select t1.* from (
                <include refid="CurPlanProject" />
         )t1
     </select>

    <!--数据集合[CurProduct]-->
	 <select id="searchCurProduct"  parameterType="cn.ibizlab.pms.core.zentao.filter.ProjectSearchContext"  resultMap="ProjectResultMap">
         select t1.* from (
                <include refid="CurProduct" />
         )t1
     </select>

    <!--数据集合[CurUser]-->
	 <select id="searchCurUser"  parameterType="cn.ibizlab.pms.core.zentao.filter.ProjectSearchContext"  resultMap="ProjectResultMap">
	 	select * from (
         select t1.* from (
                <include refid="CurUser" />
         )t1
		 )t1
     </select>

    <!--数据集合[CurUserSa]-->
	 <select id="searchCurUserSa"  parameterType="cn.ibizlab.pms.core.zentao.filter.ProjectSearchContext"  resultMap="ProjectResultMap">
	 	select * from (
         select t1.* from (
                <include refid="CurUserSa" />
         )t1
		 )t1
     </select>

    <!--数据集合[Default]-->
	 <select id="searchDefault"  parameterType="cn.ibizlab.pms.core.zentao.filter.ProjectSearchContext"  resultMap="ProjectResultMap">
	 	select * from (
         select t1.* from (
                <include refid="Default" />
         )t1
		 )t1
     </select>

    <!--数据集合[DeveloperQuery]-->
	 <select id="searchDeveloperQuery"  parameterType="cn.ibizlab.pms.core.zentao.filter.ProjectSearchContext"  resultMap="ProjectResultMap">
         select t1.* from (
                <include refid="DeveloperQuery" />
         )t1
     </select>

    <!--数据集合[ESBulk]-->
	 <select id="searchESBulk"  parameterType="cn.ibizlab.pms.core.zentao.filter.ProjectSearchContext"  resultMap="ProjectResultMap">
         select t1.* from (
                <include refid="ESBulk" />
         )t1
     </select>

    <!--数据集合[InvolvedProject]-->
	 <select id="searchInvolvedProject"  parameterType="cn.ibizlab.pms.core.zentao.filter.ProjectSearchContext"  resultMap="ProjectResultMap">
         select t1.* from (
                <include refid="InvolvedProject" />
         )t1
     </select>

    <!--数据集合[InvolvedProject_StoryTaskBug]-->
	 <select id="searchInvolvedProject_StoryTaskBug"  parameterType="cn.ibizlab.pms.core.zentao.filter.ProjectSearchContext"  resultMap="ProjectResultMap">
         select t1.* from (
                <include refid="InvolvedProjectStoryTaskBug" />
         )t1
     </select>

    <!--数据集合[MyProject]-->
	 <select id="searchMyProject"  parameterType="cn.ibizlab.pms.core.zentao.filter.ProjectSearchContext"  resultMap="ProjectResultMap">
         select t1.* from (
                <include refid="MyProject" />
         )t1
     </select>

    <!--数据集合[OpenByQuery]-->
	 <select id="searchOpenByQuery"  parameterType="cn.ibizlab.pms.core.zentao.filter.ProjectSearchContext"  resultMap="ProjectResultMap">
         select t1.* from (
                <include refid="OpenByQuery" />
         )t1
     </select>

    <!--数据集合[OpenQuery]-->
	 <select id="searchOpenQuery"  parameterType="cn.ibizlab.pms.core.zentao.filter.ProjectSearchContext"  resultMap="ProjectResultMap">
         select t1.* from (
                <include refid="OpenQuery" />
         )t1
     </select>

    <!--数据集合[PMQuery]-->
	 <select id="searchPMQuery"  parameterType="cn.ibizlab.pms.core.zentao.filter.ProjectSearchContext"  resultMap="ProjectResultMap">
         select t1.* from (
                <include refid="PMQuery" />
         )t1
     </select>

    <!--数据集合[POQuery]-->
	 <select id="searchPOQuery"  parameterType="cn.ibizlab.pms.core.zentao.filter.ProjectSearchContext"  resultMap="ProjectResultMap">
         select t1.* from (
                <include refid="POQuery" />
         )t1
     </select>

    <!--数据集合[ProjectTeam]-->
	 <select id="searchProjectTeam"  parameterType="cn.ibizlab.pms.core.zentao.filter.ProjectSearchContext"  resultMap="ProjectResultMap">
         select t1.* from (
                <include refid="ProjectTeam" />
         )t1
     </select>

    <!--数据集合[QDQuery]-->
	 <select id="searchQDQuery"  parameterType="cn.ibizlab.pms.core.zentao.filter.ProjectSearchContext"  resultMap="ProjectResultMap">
         select t1.* from (
                <include refid="QDQuery" />
         )t1
     </select>

    <!--数据集合[RDQuery]-->
	 <select id="searchRDQuery"  parameterType="cn.ibizlab.pms.core.zentao.filter.ProjectSearchContext"  resultMap="ProjectResultMap">
         select t1.* from (
                <include refid="RDQuery" />
         )t1
     </select>

    <!--数据集合[StoryProject]-->
	 <select id="searchStoryProject"  parameterType="cn.ibizlab.pms.core.zentao.filter.ProjectSearchContext"  resultMap="ProjectResultMap">
         select t1.* from (
                <include refid="StoryProject" />
         )t1
     </select>

    <!--数据集合[UnDoneProject]-->
	 <select id="searchUnDoneProject"  parameterType="cn.ibizlab.pms.core.zentao.filter.ProjectSearchContext"  resultMap="ProjectResultMap">
         select t1.* from (
                <include refid="UnDoneProject" />
         )t1
     </select>

    <!--数据查询[BugSelectableProjectList]-->
    <sql id="BugSelectableProjectList" databaseId="mysql">
		<![CDATA[ SELECT t1.`ACL`, t1.`BEGIN`, (SELECT COUNT(1) FROM ZT_BUG WHERE PROJECT = t1.`ID` AND DELETED = '0') AS `BUGCNT`, t1.`CANCELEDBY`, t1.`CANCELEDDATE`, t1.`CATID`, t1.`CLOSEDBY`, t1.`CLOSEDDATE`, t1.`CODE`, t1.`DAYS`, t1.`DELETED`, t1.`END`, t1.`ID`, t1.`ISCAT`, '0' AS `ISTOP`, t1.`MDEPTID`, t1.`MDEPTNAME`, t1.`NAME`, t1.`OPENEDBY`, t1.`OPENEDDATE`, t1.`OPENEDVERSION`, t1.`ORDER`, t1.`order` AS `ORDER1`, t1.`ORGID`, t1.`ORGNAME`, t1.`PARENT`, t11.`NAME` AS `PARENTNAME`, t1.`PM`, t1.`PO`, t1.`PRI`, t1.`PROJECTSN`, t1.`QD`, t1.`RD`, t1.`STATGE`, t1.`STATUS`, (SELECT COUNT(1) FROM ZT_STORY LEFT JOIN ZT_PROJECTSTORY ON ZT_STORY.ID = ZT_PROJECTSTORY.STORY WHERE PROJECT = t1.`ID` AND DELETED = '0') AS `STORYCNT`, t1.`SUBSTATUS`, t1.`SUPPROREPORT`, (SELECT COUNT(1) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0') AS `TASKCNT`, t1.`TEAM`, (SELECT round(SUM(CONSUMED),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0' AND ( `parent` = '' or `parent` = '0' or `parent` = '-1')) AS `TOTALCONSUMED`, (SELECT round(SUM(ESTIMATE),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED =  '0' AND ( `parent` = '' or `parent` = '0' or `parent` = '-1')) AS `TOTALESTIMATE`, (select sum(days * hours)  from zt_team tt where type = 'project' and root = t1.id) AS `TOTALHOURS`, (SELECT round(SUM(`LEFT`),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0' and `status` in ('doing','wait','pause') AND ( `parent` = '' or `parent` = '0' or `parent` = '-1')) AS `TOTALLEFT`, ((SELECT round(SUM( `LEFT` ),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0' AND ( `parent` = '' OR `parent` = '0' OR `parent` = '-1' ) AND `status` in ('doing','wait','pause')) + (SELECT round(SUM( CONSUMED ),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0' AND ( `parent` = '' OR `parent` = '0' OR `parent` = '-1' ))) AS `TOTALWH`, t1.`TYPE`, t1.`UPDATEBY` FROM `zt_project` t1  LEFT JOIN `zt_project` t11 ON t1.`PARENT` = t11.`ID`  LEFT OUTER JOIN `zt_projectproduct` t21 ON t1.`ID` = t21.`PROJECT`   ]]>
		<trim prefix="where" prefixOverrides="and">
			<if test="true">
                <![CDATA[ AND ( ( #{srf.webcontext.product} is null  OR  t21.`PRODUCT` = #{srf.webcontext.product} ) ) ]]>
            </if>
			<if test="true">
                <![CDATA[ AND t1.DELETED = '0' ]]>
            </if>
			<include refid="searchMode" />
		</trim>
    </sql>
	
	<select id="selectBugSelectableProjectList"  parameterType="cn.ibizlab.pms.core.zentao.filter.ProjectSearchContext" resultMap="ProjectResultMap">
		<include refid="BugSelectableProjectList" />
	</select>

    <!--数据查询[CurDefaultQuery]-->
    <sql id="CurDefaultQuery" databaseId="mysql">
		<![CDATA[ SELECT t1.MDEPTID, t1.orgid, (SELECT COUNT(1) FROM ZT_BUG WHERE PROJECT = t1.`ID` AND DELETED = '0') AS `BUGCNT`, t1.`CODE`, t1.`DELETED`, t1.`ID`, t1.`NAME`, (CASE WHEN T2.OBJECTORDER IS NOT NULL THEN T2.OBJECTORDER ELSE  t1.`ORDER` END)  as `ORDER`, (CASE WHEN T2.OBJECTORDER IS NOT NULL THEN T2.OBJECTORDER ELSE  t1.`ORDER` END) as `ORDER1`, 	(CASE WHEN T2.OBJECTORDER IS NOT NULL THEN 1 ELSE 0 END) as `ISTOP`, (SELECT COUNT(1) FROM ZT_STORY LEFT JOIN ZT_PROJECTSTORY ON ZT_STORY.ID = ZT_PROJECTSTORY.STORY WHERE PROJECT = t1.`ID` AND DELETED = '0') AS `STORYCNT`, (SELECT COUNT(1) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0') AS `TASKCNT`, t1.`TYPE`, t1.`STATUS`, t1.PROJECTSN FROM `zt_project` t1  left join t_ibz_top t2 on t1.id = t2.OBJECTID and t2.type = 'project' and t2.ACCOUNT = #{srf.sessioncontext.srfloginname} LEFT JOIN zt_project t11 ON t1.PARENT = t11.PROJECTSN ]]>
		<trim prefix="where" prefixOverrides="and">
			<if test="true">
                <![CDATA[ AND t1.deleted = '0' ]]>
            </if>
			<include refid="searchMode" />
		</trim>
    </sql>
	
	<select id="selectCurDefaultQuery"  parameterType="cn.ibizlab.pms.core.zentao.filter.ProjectSearchContext" resultMap="ProjectResultMap">
		<include refid="CurDefaultQuery" />
	</select>

    <!--数据查询[CurDefaultQueryExp]-->
    <sql id="CurDefaultQueryExp" databaseId="mysql">
		<![CDATA[ SELECT t1.MDEPTID, t1.orgid, t1.`CODE`, t1.`DELETED`, t1.`ID`, t1.`NAME`, (CASE WHEN T2.OBJECTORDER IS NOT NULL THEN T2.OBJECTORDER ELSE  t1.`ORDER` END) AS `ORDER`, (CASE WHEN T2.OBJECTORDER IS NOT NULL THEN T2.OBJECTORDER ELSE  t1.`ORDER` END) as `ORDER1`, (CASE WHEN T2.OBJECTORDER IS NOT NULL THEN 1 ELSE 0 END) as `ISTOP`, t1.PROJECTSN FROM `zt_project` t1  left join t_ibz_top t2 on t1.id = t2.OBJECTID and t2.type = 'project' and t2.ACCOUNT =#{srf.sessioncontext.srfloginname} LEFT JOIN zt_project t11 ON t1.PARENT = t11.ID ]]>
		<trim prefix="where" prefixOverrides="and">
			<if test="true">
                <![CDATA[ AND t1.deleted = '0' ]]>
            </if>
			<include refid="searchMode" />
		</trim>
    </sql>
	
	<select id="selectCurDefaultQueryExp"  parameterType="cn.ibizlab.pms.core.zentao.filter.ProjectSearchContext" resultMap="ProjectResultMap">
		<include refid="CurDefaultQueryExp" />
	</select>

    <!--数据查询[CurPlanProject]-->
    <sql id="CurPlanProject" databaseId="mysql">
		<![CDATA[ SELECT t1.`ACL`, t1.`BEGIN`, (SELECT COUNT(1) FROM ZT_BUG WHERE PROJECT = t1.`ID` AND DELETED = '0') AS `BUGCNT`, t1.`CANCELEDBY`, t1.`CANCELEDDATE`, t1.`CATID`, t1.`CLOSEDBY`, t1.`CLOSEDDATE`, t1.`CODE`, t1.`DAYS`, t1.`DELETED`, t1.`END`, t1.`ID`, t1.`ISCAT`, '0' AS `ISTOP`, t1.`MDEPTID`, t1.`MDEPTNAME`, t1.`NAME`, t1.`OPENEDBY`, t1.`OPENEDDATE`, t1.`OPENEDVERSION`, t1.`ORDER`, t1.`order` AS `ORDER1`, t1.`ORGID`, t1.`ORGNAME`, t1.`PARENT`, t11.`NAME` AS `PARENTNAME`, t1.`PM`, t1.`PO`, t1.`PRI`, t1.`PROJECTSN`, t1.`QD`, t1.`RD`, t1.`STATGE`, t1.`STATUS`, (SELECT COUNT(1) FROM ZT_STORY LEFT JOIN ZT_PROJECTSTORY ON ZT_STORY.ID = ZT_PROJECTSTORY.STORY WHERE PROJECT = t1.`ID` AND DELETED = '0') AS `STORYCNT`, t1.`SUBSTATUS`, t1.`SUPPROREPORT`, (SELECT COUNT(1) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0') AS `TASKCNT`, t1.`TEAM`, (SELECT round(SUM(CONSUMED),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0' AND ( `parent` = '' or `parent` = '0' or `parent` = '-1')) AS `TOTALCONSUMED`, (SELECT round(SUM(ESTIMATE),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED =  '0' AND ( `parent` = '' or `parent` = '0' or `parent` = '-1')) AS `TOTALESTIMATE`, (select sum(days * hours)  from zt_team tt where type = 'project' and root = t1.id) AS `TOTALHOURS`, (SELECT round(SUM(`LEFT`),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0' and `status` in ('doing','wait','pause') AND ( `parent` = '' or `parent` = '0' or `parent` = '-1')) AS `TOTALLEFT`, ((SELECT round(SUM( `LEFT` ),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0' AND ( `parent` = '' OR `parent` = '0' OR `parent` = '-1' ) AND `status` in ('doing','wait','pause')) + (SELECT round(SUM( CONSUMED ),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0' AND ( `parent` = '' OR `parent` = '0' OR `parent` = '-1' ))) AS `TOTALWH`, t1.`TYPE`, t1.`UPDATEBY` FROM `zt_project` t1  LEFT JOIN `zt_project` t11 ON t1.`PARENT` = t11.`ID`  LEFT OUTER JOIN `zt_projectproduct` t21 ON t1.`ID` = t21.`PROJECT`   ]]>
		<trim prefix="where" prefixOverrides="and">
			<if test="true">
                <![CDATA[ AND ( t21.`PLAN` = #{srf.webcontext.plan} ) ]]>
            </if>
			<if test="true">
                <![CDATA[ AND t1.DELETED = '0' ]]>
            </if>
			<include refid="searchMode" />
		</trim>
    </sql>
	
	<select id="selectCurPlanProject"  parameterType="cn.ibizlab.pms.core.zentao.filter.ProjectSearchContext" resultMap="ProjectResultMap">
		<include refid="CurPlanProject" />
	</select>

    <!--数据查询[CurProduct]-->
    <sql id="CurProduct" databaseId="mysql">
		<![CDATA[ SELECT t1.`ACL`, t1.`BEGIN`, (SELECT COUNT(1) FROM ZT_BUG WHERE PROJECT = t1.`ID` AND DELETED = '0') AS `BUGCNT`, t1.`CANCELEDBY`, t1.`CANCELEDDATE`, t1.`CATID`, t1.`CLOSEDBY`, t1.`CLOSEDDATE`, t1.`CODE`, t1.`DAYS`, t1.`DELETED`, t1.`END`, t1.`ID`, t1.`ISCAT`, '0' AS `ISTOP`, t1.`MDEPTID`, t1.`MDEPTNAME`, t1.`NAME`, t1.`OPENEDBY`, t1.`OPENEDDATE`, t1.`OPENEDVERSION`, t1.`ORDER`, t1.`order` AS `ORDER1`, t1.`ORGID`, t1.`ORGNAME`, t1.`PARENT`, t11.`NAME` AS `PARENTNAME`, t1.`PM`, t1.`PO`, t1.`PRI`, t1.`PROJECTSN`, t1.`QD`, t1.`RD`, t1.`STATGE`, t1.`STATUS`, (SELECT COUNT(1) FROM ZT_STORY LEFT JOIN ZT_PROJECTSTORY ON ZT_STORY.ID = ZT_PROJECTSTORY.STORY WHERE PROJECT = t1.`ID` AND DELETED = '0') AS `STORYCNT`, t1.`SUBSTATUS`, t1.`SUPPROREPORT`, (SELECT COUNT(1) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0') AS `TASKCNT`, t1.`TEAM`, (SELECT round(SUM(CONSUMED),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0' AND ( `parent` = '' or `parent` = '0' or `parent` = '-1')) AS `TOTALCONSUMED`, (SELECT round(SUM(ESTIMATE),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED =  '0' AND ( `parent` = '' or `parent` = '0' or `parent` = '-1')) AS `TOTALESTIMATE`, (select sum(days * hours)  from zt_team tt where type = 'project' and root = t1.id) AS `TOTALHOURS`, (SELECT round(SUM(`LEFT`),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0' and `status` in ('doing','wait','pause') AND ( `parent` = '' or `parent` = '0' or `parent` = '-1')) AS `TOTALLEFT`, ((SELECT round(SUM( `LEFT` ),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0' AND ( `parent` = '' OR `parent` = '0' OR `parent` = '-1' ) AND `status` in ('doing','wait','pause')) + (SELECT round(SUM( CONSUMED ),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0' AND ( `parent` = '' OR `parent` = '0' OR `parent` = '-1' ))) AS `TOTALWH`, t1.`TYPE`, t1.`UPDATEBY` FROM `zt_project` t1  LEFT JOIN `zt_project` t11 ON t1.`PARENT` = t11.`ID`   ]]>
		<trim prefix="where" prefixOverrides="and">
			<if test="true">
                <![CDATA[ AND EXISTS(SELECT * FROM `zt_projectproduct` t21   WHERE   t1.`ID` = t21.`PROJECT`  AND  ( t21.`PRODUCT` = #{srf.datacontext.n_product_eq} ) ) ]]>
            </if>
			<if test="true">
                <![CDATA[ AND t1.DELETED = '0' ]]>
            </if>
			<include refid="searchMode" />
		</trim>
    </sql>
	
	<select id="selectCurProduct"  parameterType="cn.ibizlab.pms.core.zentao.filter.ProjectSearchContext" resultMap="ProjectResultMap">
		<include refid="CurProduct" />
	</select>

    <!--数据查询[CurUser]-->
    <sql id="CurUser" databaseId="mysql">
		<![CDATA[ select t1.* from (SELECT t1.MDEPTID, t1.orgid, t1.`ACL`, t1.`BEGIN`, (SELECT COUNT(1) FROM ZT_BUG WHERE PROJECT = t1.`ID` AND DELETED = '0') AS `BUGCNT`, t1.`CANCELEDBY`, (select count(1) + 1 from zt_doclib where type = 'project' and project = t1.`id`) as `DOCLIBCNT`, t1.`CANCELEDDATE`, t1.`CATID`, t1.`CLOSEDBY`, t1.`CLOSEDDATE`, t1.`CODE`, t1.`DAYS`, t1.`DELETED`, t1.`END`, t1.`ID`, t1.`ISCAT`, t1.`NAME`, t1.`OPENEDBY`, t1.`OPENEDDATE`, t1.`OPENEDVERSION`, t1.`ORDER`, (CASE WHEN T2.OBJECTORDER IS NOT NULL THEN T2.OBJECTORDER ELSE  t1.`ORDER` END) as `ORDER1`, 	(CASE WHEN T2.OBJECTORDER IS NOT NULL THEN 1 ELSE 0 END) as `ISTOP`, t1.`PARENT`, t11.`NAME` AS `PARENTNAME`, t1.`PM`, t1.`PO`, t1.`PRI`, t1.`QD`, t1.`RD`, t1.`STATGE`, t1.`STATUS`, (SELECT COUNT(1) FROM ZT_STORY LEFT JOIN ZT_PROJECTSTORY ON ZT_STORY.ID = ZT_PROJECTSTORY.STORY WHERE PROJECT = t1.`ID` AND DELETED = '0') AS `STORYCNT`, t1.`SUBSTATUS`, (SELECT COUNT(1) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0') AS `TASKCNT`, t1.`TEAM`, (SELECT round(SUM(CONSUMED),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0' AND ( `parent` = '' or `parent` = '0' or `parent` = '-1')) AS `TOTALCONSUMED`, (SELECT round(SUM(ESTIMATE),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED =  '0' AND ( `parent` = '' or `parent` = '0' or `parent` = '-1')) AS `TOTALESTIMATE`, (select sum(days * hours)  from zt_team tt where type = 'project' and root = t1.id) AS `TOTALHOURS`, (SELECT round(SUM(`LEFT`),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0' and `status` in ('doing','wait','pause') AND ( `parent` = '' or `parent` = '0' or `parent` = '-1')) AS `TOTALLEFT`, ((SELECT round(SUM( `LEFT` ),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0' AND ( `parent` = '' OR `parent` = '0' OR `parent` = '-1' ) AND `status` in ('doing','wait','pause')) + (SELECT round(SUM( CONSUMED ),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0' AND ( `parent` = '' OR `parent` = '0' OR `parent` = '-1' ))) AS `TOTALWH`, t1.`TYPE`, t1.PROJECTSN FROM `zt_project` t1  left join t_ibz_top t2 on t1.id = t2.OBJECTID and t2.type = 'project' and t2.ACCOUNT = #{srf.sessioncontext.srfloginname} LEFT JOIN zt_project t11 ON t1.PARENT = t11.ID  where t1.deleted = '0' and (t1.acl = 'open' or t1.OPENEDBY = #{srf.sessioncontext.srfloginname} or  t1.pm =  #{srf.sessioncontext.srfloginname} or t1.PO = #{srf.sessioncontext.srfloginname} or t1.RD = #{srf.sessioncontext.srfloginname} or t1.QD =  #{srf.sessioncontext.srfloginname} ) union  SELECT t1.MDEPTID, t1.orgid, t1.`ACL`, t1.`BEGIN`, (SELECT COUNT(1) FROM ZT_BUG WHERE PROJECT = t1.`ID` AND DELETED = '0') AS `BUGCNT`, t1.`CANCELEDBY`, (select count(1) + 1 from zt_doclib where type = 'project' and project = t1.`id`) as `DOCLIBCNT`, t1.`CANCELEDDATE`, t1.`CATID`, t1.`CLOSEDBY`, t1.`CLOSEDDATE`, t1.`CODE`, t1.`DAYS`, t1.`DELETED`, t1.`END`, t1.`ID`, t1.`ISCAT`, t1.`NAME`, t1.`OPENEDBY`, t1.`OPENEDDATE`, t1.`OPENEDVERSION`, t1.`ORDER`, (CASE WHEN T2.OBJECTORDER IS NOT NULL THEN T2.OBJECTORDER ELSE  t1.`ORDER` END) as `ORDER1`, 	(CASE WHEN T2.OBJECTORDER IS NOT NULL THEN 1 ELSE 0 END) as `ISTOP`, t1.`PARENT`, t11.`NAME` AS `PARENTNAME`, t1.`PM`, t1.`PO`, t1.`PRI`, t1.`QD`, t1.`RD`, t1.`STATGE`, t1.`STATUS`, (SELECT COUNT(1) FROM ZT_STORY LEFT JOIN ZT_PROJECTSTORY ON ZT_STORY.ID = ZT_PROJECTSTORY.STORY WHERE PROJECT = t1.`ID` AND DELETED = '0') AS `STORYCNT`, t1.`SUBSTATUS`, (SELECT COUNT(1) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0') AS `TASKCNT`, t1.`TEAM`, (SELECT round(SUM(CONSUMED),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0' AND ( `parent` = '' or `parent` = '0' or `parent` = '-1')) AS `TOTALCONSUMED`, (SELECT round(SUM(ESTIMATE),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED =  '0' AND ( `parent` = '' or `parent` = '0' or `parent` = '-1')) AS `TOTALESTIMATE`, (select sum(days * hours)  from zt_team tt where type = 'project' and root = t1.id) AS `TOTALHOURS`, (SELECT round(SUM(`LEFT`),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0' and `status` in ('doing','wait','pause') AND ( `parent` = '' or `parent` = '0' or `parent` = '-1')) AS `TOTALLEFT`, ((SELECT round(SUM( `LEFT` ),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0' AND ( `parent` = '' OR `parent` = '0' OR `parent` = '-1' ) AND `status` in ('doing','wait','pause')) + (SELECT round(SUM( CONSUMED ),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0' AND ( `parent` = '' OR `parent` = '0' OR `parent` = '-1' ))) AS `TOTALWH`, t1.`TYPE`, t1.PROJECTSN FROM `zt_project` t1  left join t_ibz_top t2 on t1.id = t2.OBJECTID and t2.type = 'project' and t2.ACCOUNT = #{srf.sessioncontext.srfloginname} LEFT JOIN zt_project t11 ON t1.PARENT = t11.ID  where t1.deleted = '0' and t1.acl = 'private' and t1.PROJECTSN in (select t3.root from zt_team t3 where t3.account = #{srf.sessioncontext.srfloginname}   and t3.type = 'project')) t1 ]]>
		<trim prefix="where" prefixOverrides="and">
			<include refid="searchMode" />
		</trim>
    </sql>
	
	<select id="selectCurUser"  parameterType="cn.ibizlab.pms.core.zentao.filter.ProjectSearchContext" resultMap="ProjectResultMap">
		<include refid="CurUser" />
	</select>

    <!--数据查询[CurUserSa]-->
    <sql id="CurUserSa" databaseId="mysql">
		<![CDATA[ select t1.* from (SELECT (select tt.product from zt_projectproduct tt where tt.project = t1.id LIMIT 0,1)as products, t1.MDEPTID, t1.orgid, t1.`ACL`, t1.`BEGIN`, (SELECT COUNT(1) FROM ZT_BUG WHERE PROJECT = t1.`ID` AND DELETED = '0') AS `BUGCNT`, t1.`CANCELEDBY`, (select count(1) + 1 from zt_doclib where type = 'project' and project = t1.`id`) as `DOCLIBCNT`, t1.`CANCELEDDATE`, t1.`CATID`, t1.`CLOSEDBY`, t1.`CLOSEDDATE`, t1.`CODE`, t1.`DAYS`, t1.`DELETED`, t1.`END`, t1.`ID`, t1.`ISCAT`, t1.`NAME`, t1.`OPENEDBY`, t1.`OPENEDDATE`, t1.`OPENEDVERSION`, t1.`ORDER`, (CASE WHEN T2.OBJECTORDER IS NOT NULL THEN T2.OBJECTORDER ELSE  t1.`ORDER` END) as `ORDER1`, 	(CASE WHEN T2.OBJECTORDER IS NOT NULL THEN 1 ELSE 0 END) as `ISTOP`, t1.`PARENT`, t11.`NAME` AS `PARENTNAME`, t1.`PM`, t1.`PO`, t1.`PRI`, t1.`QD`, t1.`RD`, t1.`STATGE`, t1.`STATUS`, (SELECT COUNT(1) FROM ZT_STORY LEFT JOIN ZT_PROJECTSTORY ON ZT_STORY.ID = ZT_PROJECTSTORY.STORY WHERE PROJECT = t1.`ID` AND DELETED = '0') AS `STORYCNT`, t1.`SUBSTATUS`, (SELECT COUNT(1) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0') AS `TASKCNT`, t1.`TEAM`, (SELECT round(SUM(CONSUMED),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0' AND ( `parent` = '' or `parent` = '0' or `parent` = '-1')) AS `TOTALCONSUMED`, (SELECT round(SUM(ESTIMATE),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED =  '0' AND ( `parent` = '' or `parent` = '0' or `parent` = '-1')) AS `TOTALESTIMATE`, (select sum(days * hours)  from zt_team tt where type = 'project' and root = t1.id) AS `TOTALHOURS`, (SELECT round(SUM(`LEFT`),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0' and `status` in ('doing','wait','pause') AND ( `parent` = '' or `parent` = '0' or `parent` = '-1')) AS `TOTALLEFT`, ((SELECT round(SUM( `LEFT` ),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0' AND ( `parent` = '' OR `parent` = '0' OR `parent` = '-1' ) AND `status` in ('doing','wait','pause')) + (SELECT round(SUM( CONSUMED ),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0' AND ( `parent` = '' OR `parent` = '0' OR `parent` = '-1' ))) AS `TOTALWH`, t1.`TYPE`, t1.PROJECTSN FROM `zt_project` t1  left join t_ibz_top t2 on t1.id = t2.OBJECTID and t2.type = 'project' and t2.ACCOUNT = #{srf.sessioncontext.srfloginname} LEFT JOIN zt_project t11 ON t1.PARENT = t11.PROJECTSN  where t1.deleted = '0' and (t1.acl = 'open' or t1.OPENEDBY = #{srf.sessioncontext.srfloginname} or  t1.pm =  #{srf.sessioncontext.srfloginname} or t1.PO = #{srf.sessioncontext.srfloginname} or t1.RD = #{srf.sessioncontext.srfloginname} or t1.QD =  #{srf.sessioncontext.srfloginname} ) union  SELECT (select tt.product from zt_projectproduct tt where tt.project = t1.id LIMIT 0,1)as products, t1.MDEPTID, t1.orgid, t1.`ACL`, t1.`BEGIN`, (SELECT COUNT(1) FROM ZT_BUG WHERE PROJECT = t1.`ID` AND DELETED = '0') AS `BUGCNT`, t1.`CANCELEDBY`, (select count(1) + 1 from zt_doclib where type = 'project' and project = t1.`id`) as `DOCLIBCNT`, t1.`CANCELEDDATE`, t1.`CATID`, t1.`CLOSEDBY`, t1.`CLOSEDDATE`, t1.`CODE`, t1.`DAYS`, t1.`DELETED`, t1.`END`, t1.`ID`, t1.`ISCAT`, t1.`NAME`, t1.`OPENEDBY`, t1.`OPENEDDATE`, t1.`OPENEDVERSION`, t1.`ORDER`, (CASE WHEN T2.OBJECTORDER IS NOT NULL THEN T2.OBJECTORDER ELSE  t1.`ORDER` END) as `ORDER1`, 	(CASE WHEN T2.OBJECTORDER IS NOT NULL THEN 1 ELSE 0 END) as `ISTOP`, t1.`PARENT`, t11.`NAME` AS `PARENTNAME`, t1.`PM`, t1.`PO`, t1.`PRI`, t1.`QD`, t1.`RD`, t1.`STATGE`, t1.`STATUS`, (SELECT COUNT(1) FROM ZT_STORY LEFT JOIN ZT_PROJECTSTORY ON ZT_STORY.ID = ZT_PROJECTSTORY.STORY WHERE PROJECT = t1.`ID` AND DELETED = '0') AS `STORYCNT`, t1.`SUBSTATUS`, (SELECT COUNT(1) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0') AS `TASKCNT`, t1.`TEAM`, (SELECT round(SUM(CONSUMED),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0' AND ( `parent` = '' or `parent` = '0' or `parent` = '-1')) AS `TOTALCONSUMED`, (SELECT round(SUM(ESTIMATE),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED =  '0' AND ( `parent` = '' or `parent` = '0' or `parent` = '-1')) AS `TOTALESTIMATE`, (select sum(days * hours)  from zt_team tt where type = 'project' and root = t1.id) AS `TOTALHOURS`, (SELECT round(SUM(`LEFT`),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0' and `status` in ('doing','wait','pause') AND ( `parent` = '' or `parent` = '0' or `parent` = '-1')) AS `TOTALLEFT`, ((SELECT round(SUM( `LEFT` ),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0' AND ( `parent` = '' OR `parent` = '0' OR `parent` = '-1' ) AND `status` in ('doing','wait','pause')) + (SELECT round(SUM( CONSUMED ),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0' AND ( `parent` = '' OR `parent` = '0' OR `parent` = '-1' ))) AS `TOTALWH`, t1.`TYPE`, t1.PROJECTSN FROM `zt_project` t1  left join t_ibz_top t2 on t1.id = t2.OBJECTID and t2.type = 'project' and t2.ACCOUNT = #{srf.sessioncontext.srfloginname} LEFT JOIN zt_project t11 ON t1.PARENT = t11.PROJECTSN  where t1.deleted = '0' and t1.acl = 'private' and t1.PROJECTSN in (select t3.root from zt_team t3 where t3.account = #{srf.sessioncontext.srfloginname}   and t3.type = 'project')) t1 ]]>
		<trim prefix="where" prefixOverrides="and">
			<include refid="searchMode" />
		</trim>
    </sql>
	
	<select id="selectCurUserSa"  parameterType="cn.ibizlab.pms.core.zentao.filter.ProjectSearchContext" resultMap="ProjectResultMap">
		<include refid="CurUserSa" />
	</select>

    <!--数据查询[Default]-->
    <sql id="Default" databaseId="mysql">
		<![CDATA[ SELECT t1.`ACL`, t1.`BEGIN`, (SELECT COUNT(1) FROM ZT_BUG WHERE PROJECT = t1.`ID` AND DELETED = '0') AS `BUGCNT`, t1.`CANCELEDBY`, t1.`CANCELEDDATE`, t1.`CATID`, t1.`CLOSEDBY`, t1.`CLOSEDDATE`, t1.`CODE`, t1.`DAYS`, t1.`DELETED`, t1.`END`, t1.`ID`, t1.`ISCAT`, '0' AS `ISTOP`, t1.`MDEPTID`, t1.`MDEPTNAME`, t1.`NAME`, t1.`OPENEDBY`, t1.`OPENEDDATE`, t1.`OPENEDVERSION`, t1.`ORDER`, t1.`order` AS `ORDER1`, t1.`ORGID`, t1.`ORGNAME`, t1.`PARENT`, t11.`NAME` AS `PARENTNAME`, t1.`PM`, t1.`PO`, t1.`PRI`, t1.`PROJECTSN`, t1.`QD`, t1.`RD`, t1.`STATGE`, t1.`STATUS`, (SELECT COUNT(1) FROM ZT_STORY LEFT JOIN ZT_PROJECTSTORY ON ZT_STORY.ID = ZT_PROJECTSTORY.STORY WHERE PROJECT = t1.`ID` AND DELETED = '0') AS `STORYCNT`, t1.`SUBSTATUS`, t1.`SUPPROREPORT`, (SELECT COUNT(1) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0') AS `TASKCNT`, t1.`TEAM`, (SELECT round(SUM(CONSUMED),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0' AND ( `parent` = '' or `parent` = '0' or `parent` = '-1')) AS `TOTALCONSUMED`, (SELECT round(SUM(ESTIMATE),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED =  '0' AND ( `parent` = '' or `parent` = '0' or `parent` = '-1')) AS `TOTALESTIMATE`, (select sum(days * hours)  from zt_team tt where type = 'project' and root = t1.id) AS `TOTALHOURS`, (SELECT round(SUM(`LEFT`),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0' and `status` in ('doing','wait','pause') AND ( `parent` = '' or `parent` = '0' or `parent` = '-1')) AS `TOTALLEFT`, ((SELECT round(SUM( `LEFT` ),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0' AND ( `parent` = '' OR `parent` = '0' OR `parent` = '-1' ) AND `status` in ('doing','wait','pause')) + (SELECT round(SUM( CONSUMED ),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0' AND ( `parent` = '' OR `parent` = '0' OR `parent` = '-1' ))) AS `TOTALWH`, t1.`TYPE`, t1.`UPDATEBY` FROM `zt_project` t1  LEFT JOIN `zt_project` t11 ON t1.`PARENT` = t11.`ID`   ]]>
		<trim prefix="where" prefixOverrides="and">
			<if test="true">
                <![CDATA[ AND t1.DELETED = '0' ]]>
            </if>
			<include refid="searchMode" />
		</trim>
    </sql>
	
	<select id="selectDefault"  parameterType="cn.ibizlab.pms.core.zentao.filter.ProjectSearchContext" resultMap="ProjectResultMap">
		<include refid="Default" />
	</select>

    <!--数据查询[DeveloperQuery]-->
    <sql id="DeveloperQuery" databaseId="mysql">
		<![CDATA[ SELECT t1.`ACL`, t1.`BEGIN`, (SELECT COUNT(1) FROM ZT_BUG WHERE PROJECT = t1.`ID` AND DELETED = '0') AS `BUGCNT`, t1.`CANCELEDBY`, t1.`CANCELEDDATE`, t1.`CATID`, t1.`CLOSEDBY`, t1.`CLOSEDDATE`, t1.`CODE`, t1.`DAYS`, t1.`DELETED`, t1.`END`, t1.`ID`, t1.`ISCAT`, '0' AS `ISTOP`, t1.`MDEPTID`, t1.`MDEPTNAME`, t1.`NAME`, t1.`OPENEDBY`, t1.`OPENEDDATE`, t1.`OPENEDVERSION`, t1.`ORDER`, t1.`order` AS `ORDER1`, t1.`ORGID`, t1.`ORGNAME`, t1.`PARENT`, t11.`NAME` AS `PARENTNAME`, t1.`PM`, t1.`PO`, t1.`PRI`, t1.`PROJECTSN`, t1.`QD`, t1.`RD`, t1.`STATGE`, t1.`STATUS`, (SELECT COUNT(1) FROM ZT_STORY LEFT JOIN ZT_PROJECTSTORY ON ZT_STORY.ID = ZT_PROJECTSTORY.STORY WHERE PROJECT = t1.`ID` AND DELETED = '0') AS `STORYCNT`, t1.`SUBSTATUS`, t1.`SUPPROREPORT`, (SELECT COUNT(1) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0') AS `TASKCNT`, t1.`TEAM`, (SELECT round(SUM(CONSUMED),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0' AND ( `parent` = '' or `parent` = '0' or `parent` = '-1')) AS `TOTALCONSUMED`, (SELECT round(SUM(ESTIMATE),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED =  '0' AND ( `parent` = '' or `parent` = '0' or `parent` = '-1')) AS `TOTALESTIMATE`, (select sum(days * hours)  from zt_team tt where type = 'project' and root = t1.id) AS `TOTALHOURS`, (SELECT round(SUM(`LEFT`),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0' and `status` in ('doing','wait','pause') AND ( `parent` = '' or `parent` = '0' or `parent` = '-1')) AS `TOTALLEFT`, ((SELECT round(SUM( `LEFT` ),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0' AND ( `parent` = '' OR `parent` = '0' OR `parent` = '-1' ) AND `status` in ('doing','wait','pause')) + (SELECT round(SUM( CONSUMED ),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0' AND ( `parent` = '' OR `parent` = '0' OR `parent` = '-1' ))) AS `TOTALWH`, t1.`TYPE`, t1.`UPDATEBY` FROM `zt_project` t1  LEFT JOIN `zt_project` t11 ON t1.`PARENT` = t11.`ID`   ]]>
		<trim prefix="where" prefixOverrides="and">
			<if test="true">
                <![CDATA[ AND t1.DELETED = '0' ]]>
            </if>
			<if test="true">
                <![CDATA[ AND ( t1.id in (select t3.root from zt_team t3 where t3.account = #{srf.sessioncontext.srfloginname}   and t3.type = 'project') ) ]]>
            </if>
			<include refid="searchMode" />
		</trim>
    </sql>
	
	<select id="selectDeveloperQuery"  parameterType="cn.ibizlab.pms.core.zentao.filter.ProjectSearchContext" resultMap="ProjectResultMap">
		<include refid="DeveloperQuery" />
	</select>

    <!--数据查询[ESBulk]-->
    <sql id="ESBulk" databaseId="mysql">
		<![CDATA[ SELECT 	t1.id, 	t1.`name`, 	t1.`desc`, 	t1.deleted FROM 	zt_project t1 ]]>
		<trim prefix="where" prefixOverrides="and">
			<include refid="searchMode" />
		</trim>
    </sql>
	
	<select id="selectESBulk"  parameterType="cn.ibizlab.pms.core.zentao.filter.ProjectSearchContext" resultMap="ProjectResultMap">
		<include refid="ESBulk" />
	</select>

    <!--数据查询[InvolvedProject]-->
    <sql id="InvolvedProject" databaseId="mysql">
		<![CDATA[  select t1.* from (SELECT t1.MDEPTID, t1.orgid, t1.`ACL`, t1.`BEGIN`, (SELECT COUNT(1) FROM ZT_BUG WHERE PROJECT = t1.`ID` AND DELETED = '0') AS `BUGCNT`, t1.`CANCELEDBY`, t1.`CANCELEDDATE`, t1.`CATID`, t1.`CLOSEDBY`, t1.`CLOSEDDATE`, t1.`CODE`, t1.`DAYS`, t1.`DELETED`, t1.`END`, t1.`ID`, t1.`ISCAT`, '0' AS `ISTOP`, t1.`NAME`, t1.`OPENEDBY`, t1.`OPENEDDATE`, t1.`OPENEDVERSION`, t1.`ORDER`, t1.`order` AS `ORDER1`, t1.`PARENT`, t11.`NAME` AS `PARENTNAME`, t1.`PM`, t1.`PO`, t1.`PRI`, t1.`QD`, t1.`RD`, t1.`STATGE`, CASE  	WHEN t1.`STATUS` = 'wait' THEN 		'doing' 	ELSE 		t1.`STATUS` END  as `STATUS`, (SELECT COUNT(1) FROM ZT_STORY LEFT JOIN ZT_PROJECTSTORY ON ZT_STORY.ID = ZT_PROJECTSTORY.STORY WHERE PROJECT = t1.`ID` AND DELETED = '0') AS `STORYCNT`, t1.`SUBSTATUS`, (SELECT COUNT(1) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0') AS `TASKCNT`, t1.`TEAM`, (SELECT round(SUM(CONSUMED),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0' AND ( `parent` = '' or `parent` = '0' or `parent` = '-1')) AS `TOTALCONSUMED`, (SELECT round(SUM(ESTIMATE),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED =  '0' AND ( `parent` = '' or `parent` = '0' or `parent` = '-1')) AS `TOTALESTIMATE`, (select sum(days * hours)  from zt_team tt where type = 'project' and root = t1.id) AS `TOTALHOURS`, (SELECT round(SUM(`LEFT`),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0' and `status` in ('doing','wait','pause') AND ( `parent` = '' or `parent` = '0' or `parent` = '-1')) AS `TOTALLEFT`, ((SELECT round(SUM( `LEFT` ),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0' AND ( `parent` = '' OR `parent` = '0' OR `parent` = '-1' ) AND `status` in ('doing','wait','pause')) + (SELECT round(SUM( CONSUMED ),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0' AND ( `parent` = '' OR `parent` = '0' OR `parent` = '-1' ))) AS `TOTALWH`, t1.`TYPE`, t1.PROJECTSN FROM `zt_project` t1  LEFT JOIN zt_project t11 ON t1.PARENT = t11.ID  where t1.id in ( SELECT t1.id from zt_project t1 where (YEAR(t1.`begin`) <= #{srf.webcontext.curyear}  and YEAR(t1.`end`) >=  #{srf.webcontext.curyear} ) and ( t1.openedBy = #{srf.sessioncontext.srfloginname} or t1.PO =#{srf.sessioncontext.srfloginname}  or t1.PM =#{srf.sessioncontext.srfloginname} or t1.QD =#{srf.sessioncontext.srfloginname}  or t1.RD =#{srf.sessioncontext.srfloginname} ) ) or t1.id in ( select t1.root from zt_team t1 where t1.type = 'project' and t1.account =#{srf.sessioncontext.srfloginname}  and  YEAR(t1.`join`) = #{srf.webcontext.curyear}  ) or t1.id in  (SELECT DISTINCT t1.project from zt_task t1 LEFT JOIN zt_action t2 on t1.id = t2.OBJECTID and t2.objectType = 'task' where t2.actor = #{srf.sessioncontext.srfloginname} and t2.action = 'finished' and left(t2.date,4) = #{srf.webcontext.curyear}  ) ) t1 ]]>
		<trim prefix="where" prefixOverrides="and">
			<include refid="searchMode" />
		</trim>
    </sql>
	
	<select id="selectInvolvedProject"  parameterType="cn.ibizlab.pms.core.zentao.filter.ProjectSearchContext" resultMap="ProjectResultMap">
		<include refid="InvolvedProject" />
	</select>

    <!--数据查询[InvolvedProjectStoryTaskBug]-->
    <sql id="InvolvedProjectStoryTaskBug" databaseId="mysql">
		<![CDATA[ SELECT t1.*,IFNULL(t2.storycnt,0) as storycnt,IFNULL(t3.taskcnt,0) as ycompletetaskcnt,IFNULL(t4.bugcnt,0) as bugcnt from ( select  t1.id,t1.`name`  from zt_project t1 where t1.id in ( SELECT t1.id from zt_project t1 where (YEAR(t1.`begin`) <= #{srf.webcontext.curyear}  and YEAR(t1.`end`) >=#{srf.webcontext.curyear} ) and ( t1.openedBy =#{srf.sessioncontext.srfloginname} or t1.PO =#{srf.sessioncontext.srfloginname}  or t1.PM =#{srf.sessioncontext.srfloginname} or t1.QD = #{srf.sessioncontext.srfloginname}  or t1.RD = #{srf.sessioncontext.srfloginname} ) ) or t1.id in ( select t1.root from zt_team t1 where t1.type = 'project' and t1.account =#{srf.sessioncontext.srfloginname}  and  YEAR(t1.`join`) =#{srf.webcontext.curyear}  ) or t1.id in  (SELECT DISTINCT t1.project from zt_task t1 LEFT JOIN zt_action t2 on t1.id = t2.OBJECTID and t2.objectType = 'task' where t2.actor =#{srf.sessioncontext.srfloginname}  and t2.action = 'finished' and left(t2.date,4) =  #{srf.webcontext.curyear}  )  ) t1  LEFT JOIN ( SELECT count(1) as storycnt,t1.project from ( select t1.id,t1.`title`,t1.`status`,t2.project from zt_story t1 LEFT JOIN zt_projectstory t2 on t2.story = t1.id  ) t1 GROUP BY t1.project  ) t2 on t2.project = t1.id LEFT JOIN ( select  t1.project,count(1) as taskcnt from zt_task t1 where  t1.finishedBy =  #{srf.sessioncontext.srfloginname}  GROUP  BY t1.project ) t3 on t3.project = t1.id LEFT JOIN ( SELECT  t1.project,count(1) as bugcnt from zt_bug t1 where  t1.resolvedBy =  #{srf.sessioncontext.srfloginname}	 GROUP BY t1.project ) t4 on t4.project = t1.id ]]>
		<trim prefix="where" prefixOverrides="and">
			<include refid="searchMode" />
		</trim>
    </sql>
	
	<select id="selectInvolvedProjectStoryTaskBug"  parameterType="cn.ibizlab.pms.core.zentao.filter.ProjectSearchContext" resultMap="ProjectResultMap">
		<include refid="InvolvedProjectStoryTaskBug" />
	</select>

    <!--数据查询[MyProject]-->
    <sql id="MyProject" databaseId="mysql">
		<![CDATA[ SELECT         t1.MDEPTID,         t1.orgid, 	t1.`ACL`, 	t1.`BEGIN`, 	( SELECT COUNT( 1 ) FROM ZT_BUG WHERE PROJECT = t1.`ID` AND DELETED = '0' ) AS `BUGCNT`, 	t1.`CANCELEDBY`, 	t1.`CANCELEDDATE`, 	t1.`CATID`, 	t1.`CLOSEDBY`, 	t1.`CLOSEDDATE`, 	t1.`CODE`, 	t1.`DAYS`, 	t1.`DELETED`, 	t1.`END`, 	t1.`ID`, 	t1.`ISCAT`, 	t1.`NAME`, 	t1.`OPENEDBY`, 	t1.`OPENEDDATE`, 	t1.`OPENEDVERSION`, 	t1.`ORDER`, 	t1.`ORDER` AS `ORDER1`, 	t1.`PARENT`, 	t11.`NAME` AS `PARENTNAME`, 	t1.`PM`, 	t1.`PO`, 	t1.`PRI`, 	t1.`QD`, 	t1.`RD`, 	t1.`STATGE`, 	t1.`STATUS`, 	( SELECT 	COUNT( 1 )  FROM 	ZT_STORY 	LEFT JOIN ZT_PROJECTSTORY ON ZT_STORY.ID = ZT_PROJECTSTORY.STORY  WHERE 	PROJECT = t1.`ID`  	AND DELETED = '0'  	) AS `STORYCNT`, 	t1.`SUBSTATUS`, 	( SELECT COUNT( 1 ) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0' ) AS `TASKCNT`, 	t1.`TEAM`, 	t1.`TYPE` , 	t21.role, 	t21.account, 	t21.`join`, 	t21.hours, 	t1.PROJECTSN FROM 	`zt_project` t1 	LEFT JOIN zt_project t11 ON t1.PARENT = t11.id 	INNER JOIN zt_team t21 on t1.id = t21.root and t21.type= 'project' ]]>
		<trim prefix="where" prefixOverrides="and">
			<if test="true">
                <![CDATA[ AND t1.DELETED = '0' ]]>
            </if>
			<if test="true">
                <![CDATA[ AND t21.`account` =#{srf.sessioncontext.srfloginname} ]]>
            </if>
			<include refid="searchMode" />
		</trim>
    </sql>
	
	<select id="selectMyProject"  parameterType="cn.ibizlab.pms.core.zentao.filter.ProjectSearchContext" resultMap="ProjectResultMap">
		<include refid="MyProject" />
	</select>

    <!--数据查询[OpenByQuery]-->
    <sql id="OpenByQuery" databaseId="mysql">
		<![CDATA[ SELECT t1.`ACL`, t1.`BEGIN`, (SELECT COUNT(1) FROM ZT_BUG WHERE PROJECT = t1.`ID` AND DELETED = '0') AS `BUGCNT`, t1.`CANCELEDBY`, t1.`CANCELEDDATE`, t1.`CATID`, t1.`CLOSEDBY`, t1.`CLOSEDDATE`, t1.`CODE`, t1.`DAYS`, t1.`DELETED`, t1.`END`, t1.`ID`, t1.`ISCAT`, '0' AS `ISTOP`, t1.`MDEPTID`, t1.`MDEPTNAME`, t1.`NAME`, t1.`OPENEDBY`, t1.`OPENEDDATE`, t1.`OPENEDVERSION`, t1.`ORDER`, t1.`order` AS `ORDER1`, t1.`ORGID`, t1.`ORGNAME`, t1.`PARENT`, t11.`NAME` AS `PARENTNAME`, t1.`PM`, t1.`PO`, t1.`PRI`, t1.`PROJECTSN`, t1.`QD`, t1.`RD`, t1.`STATGE`, t1.`STATUS`, (SELECT COUNT(1) FROM ZT_STORY LEFT JOIN ZT_PROJECTSTORY ON ZT_STORY.ID = ZT_PROJECTSTORY.STORY WHERE PROJECT = t1.`ID` AND DELETED = '0') AS `STORYCNT`, t1.`SUBSTATUS`, t1.`SUPPROREPORT`, (SELECT COUNT(1) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0') AS `TASKCNT`, t1.`TEAM`, (SELECT round(SUM(CONSUMED),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0' AND ( `parent` = '' or `parent` = '0' or `parent` = '-1')) AS `TOTALCONSUMED`, (SELECT round(SUM(ESTIMATE),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED =  '0' AND ( `parent` = '' or `parent` = '0' or `parent` = '-1')) AS `TOTALESTIMATE`, (select sum(days * hours)  from zt_team tt where type = 'project' and root = t1.id) AS `TOTALHOURS`, (SELECT round(SUM(`LEFT`),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0' and `status` in ('doing','wait','pause') AND ( `parent` = '' or `parent` = '0' or `parent` = '-1')) AS `TOTALLEFT`, ((SELECT round(SUM( `LEFT` ),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0' AND ( `parent` = '' OR `parent` = '0' OR `parent` = '-1' ) AND `status` in ('doing','wait','pause')) + (SELECT round(SUM( CONSUMED ),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0' AND ( `parent` = '' OR `parent` = '0' OR `parent` = '-1' ))) AS `TOTALWH`, t1.`TYPE`, t1.`UPDATEBY` FROM `zt_project` t1  LEFT JOIN `zt_project` t11 ON t1.`PARENT` = t11.`ID`   ]]>
		<trim prefix="where" prefixOverrides="and">
			<if test="true">
                <![CDATA[ AND t1.DELETED = '0' ]]>
            </if>
			<if test="true">
                <![CDATA[ AND ( t1.`OPENEDBY` =  #{srf.sessioncontext.srfloginname} ) ]]>
            </if>
			<include refid="searchMode" />
		</trim>
    </sql>
	
	<select id="selectOpenByQuery"  parameterType="cn.ibizlab.pms.core.zentao.filter.ProjectSearchContext" resultMap="ProjectResultMap">
		<include refid="OpenByQuery" />
	</select>

    <!--数据查询[OpenQuery]-->
    <sql id="OpenQuery" databaseId="mysql">
		<![CDATA[ SELECT t1.`ACL`, t1.`BEGIN`, (SELECT COUNT(1) FROM ZT_BUG WHERE PROJECT = t1.`ID` AND DELETED = '0') AS `BUGCNT`, t1.`CANCELEDBY`, t1.`CANCELEDDATE`, t1.`CATID`, t1.`CLOSEDBY`, t1.`CLOSEDDATE`, t1.`CODE`, t1.`DAYS`, t1.`DELETED`, t1.`END`, t1.`ID`, t1.`ISCAT`, '0' AS `ISTOP`, t1.`MDEPTID`, t1.`MDEPTNAME`, t1.`NAME`, t1.`OPENEDBY`, t1.`OPENEDDATE`, t1.`OPENEDVERSION`, t1.`ORDER`, t1.`order` AS `ORDER1`, t1.`ORGID`, t1.`ORGNAME`, t1.`PARENT`, t11.`NAME` AS `PARENTNAME`, t1.`PM`, t1.`PO`, t1.`PRI`, t1.`PROJECTSN`, t1.`QD`, t1.`RD`, t1.`STATGE`, t1.`STATUS`, (SELECT COUNT(1) FROM ZT_STORY LEFT JOIN ZT_PROJECTSTORY ON ZT_STORY.ID = ZT_PROJECTSTORY.STORY WHERE PROJECT = t1.`ID` AND DELETED = '0') AS `STORYCNT`, t1.`SUBSTATUS`, t1.`SUPPROREPORT`, (SELECT COUNT(1) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0') AS `TASKCNT`, t1.`TEAM`, (SELECT round(SUM(CONSUMED),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0' AND ( `parent` = '' or `parent` = '0' or `parent` = '-1')) AS `TOTALCONSUMED`, (SELECT round(SUM(ESTIMATE),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED =  '0' AND ( `parent` = '' or `parent` = '0' or `parent` = '-1')) AS `TOTALESTIMATE`, (select sum(days * hours)  from zt_team tt where type = 'project' and root = t1.id) AS `TOTALHOURS`, (SELECT round(SUM(`LEFT`),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0' and `status` in ('doing','wait','pause') AND ( `parent` = '' or `parent` = '0' or `parent` = '-1')) AS `TOTALLEFT`, ((SELECT round(SUM( `LEFT` ),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0' AND ( `parent` = '' OR `parent` = '0' OR `parent` = '-1' ) AND `status` in ('doing','wait','pause')) + (SELECT round(SUM( CONSUMED ),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0' AND ( `parent` = '' OR `parent` = '0' OR `parent` = '-1' ))) AS `TOTALWH`, t1.`TYPE`, t1.`UPDATEBY` FROM `zt_project` t1  LEFT JOIN `zt_project` t11 ON t1.`PARENT` = t11.`ID`   ]]>
		<trim prefix="where" prefixOverrides="and">
			<if test="true">
                <![CDATA[ AND t1.DELETED = '0' ]]>
            </if>
			<if test="true">
                <![CDATA[ AND ( t1.`ACL` = 'open' ) ]]>
            </if>
			<include refid="searchMode" />
		</trim>
    </sql>
	
	<select id="selectOpenQuery"  parameterType="cn.ibizlab.pms.core.zentao.filter.ProjectSearchContext" resultMap="ProjectResultMap">
		<include refid="OpenQuery" />
	</select>

    <!--数据查询[PMQuery]-->
    <sql id="PMQuery" databaseId="mysql">
		<![CDATA[ SELECT t1.`ACL`, t1.`BEGIN`, (SELECT COUNT(1) FROM ZT_BUG WHERE PROJECT = t1.`ID` AND DELETED = '0') AS `BUGCNT`, t1.`CANCELEDBY`, t1.`CANCELEDDATE`, t1.`CATID`, t1.`CLOSEDBY`, t1.`CLOSEDDATE`, t1.`CODE`, t1.`DAYS`, t1.`DELETED`, t1.`END`, t1.`ID`, t1.`ISCAT`, '0' AS `ISTOP`, t1.`MDEPTID`, t1.`MDEPTNAME`, t1.`NAME`, t1.`OPENEDBY`, t1.`OPENEDDATE`, t1.`OPENEDVERSION`, t1.`ORDER`, t1.`order` AS `ORDER1`, t1.`ORGID`, t1.`ORGNAME`, t1.`PARENT`, t11.`NAME` AS `PARENTNAME`, t1.`PM`, t1.`PO`, t1.`PRI`, t1.`PROJECTSN`, t1.`QD`, t1.`RD`, t1.`STATGE`, t1.`STATUS`, (SELECT COUNT(1) FROM ZT_STORY LEFT JOIN ZT_PROJECTSTORY ON ZT_STORY.ID = ZT_PROJECTSTORY.STORY WHERE PROJECT = t1.`ID` AND DELETED = '0') AS `STORYCNT`, t1.`SUBSTATUS`, t1.`SUPPROREPORT`, (SELECT COUNT(1) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0') AS `TASKCNT`, t1.`TEAM`, (SELECT round(SUM(CONSUMED),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0' AND ( `parent` = '' or `parent` = '0' or `parent` = '-1')) AS `TOTALCONSUMED`, (SELECT round(SUM(ESTIMATE),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED =  '0' AND ( `parent` = '' or `parent` = '0' or `parent` = '-1')) AS `TOTALESTIMATE`, (select sum(days * hours)  from zt_team tt where type = 'project' and root = t1.id) AS `TOTALHOURS`, (SELECT round(SUM(`LEFT`),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0' and `status` in ('doing','wait','pause') AND ( `parent` = '' or `parent` = '0' or `parent` = '-1')) AS `TOTALLEFT`, ((SELECT round(SUM( `LEFT` ),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0' AND ( `parent` = '' OR `parent` = '0' OR `parent` = '-1' ) AND `status` in ('doing','wait','pause')) + (SELECT round(SUM( CONSUMED ),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0' AND ( `parent` = '' OR `parent` = '0' OR `parent` = '-1' ))) AS `TOTALWH`, t1.`TYPE`, t1.`UPDATEBY` FROM `zt_project` t1  LEFT JOIN `zt_project` t11 ON t1.`PARENT` = t11.`ID`   ]]>
		<trim prefix="where" prefixOverrides="and">
			<if test="true">
                <![CDATA[ AND t1.DELETED = '0' ]]>
            </if>
			<if test="true">
                <![CDATA[ AND ( t1.`PM` =  #{srf.sessioncontext.srfloginname} ) ]]>
            </if>
			<include refid="searchMode" />
		</trim>
    </sql>
	
	<select id="selectPMQuery"  parameterType="cn.ibizlab.pms.core.zentao.filter.ProjectSearchContext" resultMap="ProjectResultMap">
		<include refid="PMQuery" />
	</select>

    <!--数据查询[POQuery]-->
    <sql id="POQuery" databaseId="mysql">
		<![CDATA[ SELECT t1.`ACL`, t1.`BEGIN`, (SELECT COUNT(1) FROM ZT_BUG WHERE PROJECT = t1.`ID` AND DELETED = '0') AS `BUGCNT`, t1.`CANCELEDBY`, t1.`CANCELEDDATE`, t1.`CATID`, t1.`CLOSEDBY`, t1.`CLOSEDDATE`, t1.`CODE`, t1.`DAYS`, t1.`DELETED`, t1.`END`, t1.`ID`, t1.`ISCAT`, '0' AS `ISTOP`, t1.`MDEPTID`, t1.`MDEPTNAME`, t1.`NAME`, t1.`OPENEDBY`, t1.`OPENEDDATE`, t1.`OPENEDVERSION`, t1.`ORDER`, t1.`order` AS `ORDER1`, t1.`ORGID`, t1.`ORGNAME`, t1.`PARENT`, t11.`NAME` AS `PARENTNAME`, t1.`PM`, t1.`PO`, t1.`PRI`, t1.`PROJECTSN`, t1.`QD`, t1.`RD`, t1.`STATGE`, t1.`STATUS`, (SELECT COUNT(1) FROM ZT_STORY LEFT JOIN ZT_PROJECTSTORY ON ZT_STORY.ID = ZT_PROJECTSTORY.STORY WHERE PROJECT = t1.`ID` AND DELETED = '0') AS `STORYCNT`, t1.`SUBSTATUS`, t1.`SUPPROREPORT`, (SELECT COUNT(1) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0') AS `TASKCNT`, t1.`TEAM`, (SELECT round(SUM(CONSUMED),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0' AND ( `parent` = '' or `parent` = '0' or `parent` = '-1')) AS `TOTALCONSUMED`, (SELECT round(SUM(ESTIMATE),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED =  '0' AND ( `parent` = '' or `parent` = '0' or `parent` = '-1')) AS `TOTALESTIMATE`, (select sum(days * hours)  from zt_team tt where type = 'project' and root = t1.id) AS `TOTALHOURS`, (SELECT round(SUM(`LEFT`),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0' and `status` in ('doing','wait','pause') AND ( `parent` = '' or `parent` = '0' or `parent` = '-1')) AS `TOTALLEFT`, ((SELECT round(SUM( `LEFT` ),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0' AND ( `parent` = '' OR `parent` = '0' OR `parent` = '-1' ) AND `status` in ('doing','wait','pause')) + (SELECT round(SUM( CONSUMED ),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0' AND ( `parent` = '' OR `parent` = '0' OR `parent` = '-1' ))) AS `TOTALWH`, t1.`TYPE`, t1.`UPDATEBY` FROM `zt_project` t1  LEFT JOIN `zt_project` t11 ON t1.`PARENT` = t11.`ID`   ]]>
		<trim prefix="where" prefixOverrides="and">
			<if test="true">
                <![CDATA[ AND t1.DELETED = '0' ]]>
            </if>
			<if test="true">
                <![CDATA[ AND ( t1.`PO` =  #{srf.sessioncontext.srfloginname} ) ]]>
            </if>
			<include refid="searchMode" />
		</trim>
    </sql>
	
	<select id="selectPOQuery"  parameterType="cn.ibizlab.pms.core.zentao.filter.ProjectSearchContext" resultMap="ProjectResultMap">
		<include refid="POQuery" />
	</select>

    <!--数据查询[ProjectTeam]-->
    <sql id="ProjectTeam" databaseId="mysql">
		<![CDATA[ SELECT t1.MDEPTID, t1.orgid, t1.`ACL`, t1.`BEGIN`, (SELECT COUNT(1) FROM ZT_BUG WHERE PROJECT = t1.`ID` AND DELETED = '0') AS `BUGCNT`, t1.`CANCELEDBY`, t1.`CANCELEDDATE`, t1.`CATID`, t1.`CLOSEDBY`, t1.`CLOSEDDATE`, t1.`CODE`, t1.`DAYS`, t1.`DELETED`, t1.`END`, t1.`ID`, t1.`ISCAT`, '0' AS `ISTOP`, t1.`NAME`, t1.`OPENEDBY`, t1.`OPENEDDATE`, t1.`OPENEDVERSION`, t1.`ORDER`, t1.`order` AS `ORDER1`, t1.`PARENT`, t11.`NAME` AS `PARENTNAME`, t1.`PM`, t1.`PO`, t1.`PRI`, t1.`QD`, t1.`RD`, t1.`STATGE`, t1.`STATUS`, (SELECT COUNT(1) FROM ZT_STORY LEFT JOIN ZT_PROJECTSTORY ON ZT_STORY.ID = ZT_PROJECTSTORY.STORY WHERE PROJECT = t1.`ID` AND DELETED = '0') AS `STORYCNT`, t1.`SUBSTATUS`, (SELECT COUNT(1) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0') AS `TASKCNT`, t1.`TEAM`, (SELECT round(SUM(CONSUMED),0) FROM ZT_TASK WHERE PROJECT = t1.`id` AND DELETED = '0' AND ( `parent` = '' or `parent` = '0' or `parent` = '-1')) AS `TOTALCONSUMED`, (SELECT round(SUM(ESTIMATE),0) FROM ZT_TASK WHERE PROJECT = t1.`id` AND DELETED =  '0' AND ( `parent` = '' or `parent` = '0' or `parent` = '-1')) AS `TOTALESTIMATE`, (select sum(days * hours)  from zt_team tt where type = 'project' and root = t1.id) AS `TOTALHOURS`, (SELECT round(SUM(`LEFT`),0) FROM ZT_TASK WHERE PROJECT = t1.`id` AND DELETED = '0' AND ( `parent` = '' or `parent` = '0' or `parent` = '-1')) AS `TOTALLEFT`, ((SELECT round(SUM( ESTIMATE ),0) FROM ZT_TASK WHERE PROJECT = t1.`id` AND DELETED = '0' AND ( `parent` = '' OR `parent` = '0' OR `parent` = '-1' ) ) + (SELECT round(SUM( CONSUMED ),0) FROM ZT_TASK WHERE PROJECT = t1.`id` AND DELETED = '0' AND ( `parent` = '' OR `parent` = '0' OR `parent` = '-1' ) )) AS `TOTALWH`, t1.`TYPE`, t1.`PROJECTSN` FROM `zt_project` t1  LEFT JOIN zt_project t11 ON t1.PARENT = t11.id left join zt_team t21 on t1.id= t21.root ]]>
		<trim prefix="where" prefixOverrides="and">
			<if test="true">
                <![CDATA[ AND t1.DELETED = '0' ]]>
            </if>
			<if test="true">
                <![CDATA[ AND t21.type = 'project' ]]>
            </if>
			<if test="true">
                <![CDATA[ AND  t21.account = #{srf.sessioncontext.srfloginname} ]]>
            </if>
			<include refid="searchMode" />
		</trim>
    </sql>
	
	<select id="selectProjectTeam"  parameterType="cn.ibizlab.pms.core.zentao.filter.ProjectSearchContext" resultMap="ProjectResultMap">
		<include refid="ProjectTeam" />
	</select>

    <!--数据查询[QDQuery]-->
    <sql id="QDQuery" databaseId="mysql">
		<![CDATA[ SELECT t1.`ACL`, t1.`BEGIN`, (SELECT COUNT(1) FROM ZT_BUG WHERE PROJECT = t1.`ID` AND DELETED = '0') AS `BUGCNT`, t1.`CANCELEDBY`, t1.`CANCELEDDATE`, t1.`CATID`, t1.`CLOSEDBY`, t1.`CLOSEDDATE`, t1.`CODE`, t1.`DAYS`, t1.`DELETED`, t1.`END`, t1.`ID`, t1.`ISCAT`, '0' AS `ISTOP`, t1.`MDEPTID`, t1.`MDEPTNAME`, t1.`NAME`, t1.`OPENEDBY`, t1.`OPENEDDATE`, t1.`OPENEDVERSION`, t1.`ORDER`, t1.`order` AS `ORDER1`, t1.`ORGID`, t1.`ORGNAME`, t1.`PARENT`, t11.`NAME` AS `PARENTNAME`, t1.`PM`, t1.`PO`, t1.`PRI`, t1.`PROJECTSN`, t1.`QD`, t1.`RD`, t1.`STATGE`, t1.`STATUS`, (SELECT COUNT(1) FROM ZT_STORY LEFT JOIN ZT_PROJECTSTORY ON ZT_STORY.ID = ZT_PROJECTSTORY.STORY WHERE PROJECT = t1.`ID` AND DELETED = '0') AS `STORYCNT`, t1.`SUBSTATUS`, t1.`SUPPROREPORT`, (SELECT COUNT(1) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0') AS `TASKCNT`, t1.`TEAM`, (SELECT round(SUM(CONSUMED),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0' AND ( `parent` = '' or `parent` = '0' or `parent` = '-1')) AS `TOTALCONSUMED`, (SELECT round(SUM(ESTIMATE),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED =  '0' AND ( `parent` = '' or `parent` = '0' or `parent` = '-1')) AS `TOTALESTIMATE`, (select sum(days * hours)  from zt_team tt where type = 'project' and root = t1.id) AS `TOTALHOURS`, (SELECT round(SUM(`LEFT`),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0' and `status` in ('doing','wait','pause') AND ( `parent` = '' or `parent` = '0' or `parent` = '-1')) AS `TOTALLEFT`, ((SELECT round(SUM( `LEFT` ),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0' AND ( `parent` = '' OR `parent` = '0' OR `parent` = '-1' ) AND `status` in ('doing','wait','pause')) + (SELECT round(SUM( CONSUMED ),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0' AND ( `parent` = '' OR `parent` = '0' OR `parent` = '-1' ))) AS `TOTALWH`, t1.`TYPE`, t1.`UPDATEBY` FROM `zt_project` t1  LEFT JOIN `zt_project` t11 ON t1.`PARENT` = t11.`ID`   ]]>
		<trim prefix="where" prefixOverrides="and">
			<if test="true">
                <![CDATA[ AND t1.DELETED = '0' ]]>
            </if>
			<if test="true">
                <![CDATA[ AND ( t1.`QD` =  #{srf.sessioncontext.srfloginname} ) ]]>
            </if>
			<include refid="searchMode" />
		</trim>
    </sql>
	
	<select id="selectQDQuery"  parameterType="cn.ibizlab.pms.core.zentao.filter.ProjectSearchContext" resultMap="ProjectResultMap">
		<include refid="QDQuery" />
	</select>

    <!--数据查询[RDQuery]-->
    <sql id="RDQuery" databaseId="mysql">
		<![CDATA[ SELECT t1.`ACL`, t1.`BEGIN`, (SELECT COUNT(1) FROM ZT_BUG WHERE PROJECT = t1.`ID` AND DELETED = '0') AS `BUGCNT`, t1.`CANCELEDBY`, t1.`CANCELEDDATE`, t1.`CATID`, t1.`CLOSEDBY`, t1.`CLOSEDDATE`, t1.`CODE`, t1.`DAYS`, t1.`DELETED`, t1.`END`, t1.`ID`, t1.`ISCAT`, '0' AS `ISTOP`, t1.`MDEPTID`, t1.`MDEPTNAME`, t1.`NAME`, t1.`OPENEDBY`, t1.`OPENEDDATE`, t1.`OPENEDVERSION`, t1.`ORDER`, t1.`order` AS `ORDER1`, t1.`ORGID`, t1.`ORGNAME`, t1.`PARENT`, t11.`NAME` AS `PARENTNAME`, t1.`PM`, t1.`PO`, t1.`PRI`, t1.`PROJECTSN`, t1.`QD`, t1.`RD`, t1.`STATGE`, t1.`STATUS`, (SELECT COUNT(1) FROM ZT_STORY LEFT JOIN ZT_PROJECTSTORY ON ZT_STORY.ID = ZT_PROJECTSTORY.STORY WHERE PROJECT = t1.`ID` AND DELETED = '0') AS `STORYCNT`, t1.`SUBSTATUS`, t1.`SUPPROREPORT`, (SELECT COUNT(1) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0') AS `TASKCNT`, t1.`TEAM`, (SELECT round(SUM(CONSUMED),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0' AND ( `parent` = '' or `parent` = '0' or `parent` = '-1')) AS `TOTALCONSUMED`, (SELECT round(SUM(ESTIMATE),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED =  '0' AND ( `parent` = '' or `parent` = '0' or `parent` = '-1')) AS `TOTALESTIMATE`, (select sum(days * hours)  from zt_team tt where type = 'project' and root = t1.id) AS `TOTALHOURS`, (SELECT round(SUM(`LEFT`),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0' and `status` in ('doing','wait','pause') AND ( `parent` = '' or `parent` = '0' or `parent` = '-1')) AS `TOTALLEFT`, ((SELECT round(SUM( `LEFT` ),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0' AND ( `parent` = '' OR `parent` = '0' OR `parent` = '-1' ) AND `status` in ('doing','wait','pause')) + (SELECT round(SUM( CONSUMED ),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0' AND ( `parent` = '' OR `parent` = '0' OR `parent` = '-1' ))) AS `TOTALWH`, t1.`TYPE`, t1.`UPDATEBY` FROM `zt_project` t1  LEFT JOIN `zt_project` t11 ON t1.`PARENT` = t11.`ID`   ]]>
		<trim prefix="where" prefixOverrides="and">
			<if test="true">
                <![CDATA[ AND t1.DELETED = '0' ]]>
            </if>
			<if test="true">
                <![CDATA[ AND ( t1.`RD` =  #{srf.sessioncontext.srfloginname} ) ]]>
            </if>
			<include refid="searchMode" />
		</trim>
    </sql>
	
	<select id="selectRDQuery"  parameterType="cn.ibizlab.pms.core.zentao.filter.ProjectSearchContext" resultMap="ProjectResultMap">
		<include refid="RDQuery" />
	</select>

    <!--数据查询[StoryProject]-->
    <sql id="StoryProject" databaseId="mysql">
		<![CDATA[ select concat(t1.`name`, '  ' ,t.ACCOUNTS) accounts,t1.id ,t1.`name`  from zt_project t1 left join (select GROUP_CONCAT(t.realnames Separator ' ') as ACCOUNTS,t.root from (select t.account,t1.realname, CONCAT(UPPER(left(t.account,1)),':',t1.realname) as realnames,t.root from zt_team t left join zt_user t1 on t1.account = t.account where  t.type = 'project' and t1.deleted = '0') t GROUP BY t.root) t on t1.PROJECTSN = t.root ]]>
		<trim prefix="where" prefixOverrides="and">
			<if test="true">
                <![CDATA[ AND t1.id in ( select tt.project from zt_task tt where tt.deleted = '0' and tt.story = #{srf.datacontext.story} ) ]]>
            </if>
			<include refid="searchMode" />
		</trim>
    </sql>
	
	<select id="selectStoryProject"  parameterType="cn.ibizlab.pms.core.zentao.filter.ProjectSearchContext" resultMap="ProjectResultMap">
		<include refid="StoryProject" />
	</select>

    <!--数据查询[UnDoneProject]-->
    <sql id="UnDoneProject" databaseId="mysql">
		<![CDATA[ select t1.* from (SELECT t1.MDEPTID, t1.orgid, t1.`ACL`, t1.`BEGIN`, (SELECT COUNT(1) FROM ZT_BUG WHERE PROJECT = t1.`ID` AND DELETED = '0') AS `BUGCNT`, t1.`CANCELEDBY`, (select count(1) + 1 from zt_doclib where type = 'project' and project = t1.`id`) as `DOCLIBCNT`, t1.`CANCELEDDATE`, t1.`CATID`, t1.`CLOSEDBY`, t1.`CLOSEDDATE`, t1.`CODE`, t1.`DAYS`, t1.`DELETED`, t1.`END`, t1.`ID`, t1.`ISCAT`, t1.`NAME`, t1.`OPENEDBY`, t1.`OPENEDDATE`, t1.`OPENEDVERSION`, t1.`ORDER`, (CASE WHEN T2.OBJECTORDER IS NOT NULL THEN T2.OBJECTORDER ELSE  t1.`ORDER` END) as `ORDER1`, 	(CASE WHEN T2.OBJECTORDER IS NOT NULL THEN 1 ELSE 0 END) as `ISTOP`, t1.`PARENT`, t11.`NAME` AS `PARENTNAME`, t1.`PM`, t1.`PO`, t1.`PRI`, t1.`QD`, t1.`RD`, t1.`STATGE`, t1.`STATUS`, (SELECT COUNT(1) FROM ZT_STORY LEFT JOIN ZT_PROJECTSTORY ON ZT_STORY.ID = ZT_PROJECTSTORY.STORY WHERE PROJECT = t1.`ID` AND DELETED = '0') AS `STORYCNT`, t1.`SUBSTATUS`, (SELECT COUNT(1) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0') AS `TASKCNT`, t1.`TEAM`, (SELECT round(SUM(CONSUMED),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0' AND ( `parent` = '' or `parent` = '0' or `parent` = '-1')) AS `TOTALCONSUMED`, (SELECT round(SUM(ESTIMATE),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED =  '0' AND ( `parent` = '' or `parent` = '0' or `parent` = '-1')) AS `TOTALESTIMATE`, (select sum(days * hours)  from zt_team tt where type = 'project' and root = t1.id) AS `TOTALHOURS`, (SELECT round(SUM(`LEFT`),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0' and `status` in ('doing','wait','pause') AND ( `parent` = '' or `parent` = '0' or `parent` = '-1')) AS `TOTALLEFT`, ((SELECT round(SUM( `LEFT` ),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0' AND ( `parent` = '' OR `parent` = '0' OR `parent` = '-1' ) AND `status` in ('doing','wait','pause')) + (SELECT round(SUM( CONSUMED ),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0' AND ( `parent` = '' OR `parent` = '0' OR `parent` = '-1' ))) AS `TOTALWH`, t1.`TYPE`, t1.PROJECTSN FROM `zt_project` t1  left join t_ibz_top t2 on t1.id = t2.OBJECTID and t2.type = 'project' and t2.ACCOUNT = #{srf.sessioncontext.srfloginname} LEFT JOIN zt_project t11 ON t1.PARENT = t11.ID  where t1.deleted = '0' and (t1.acl = 'open' or t1.OPENEDBY = #{srf.sessioncontext.srfloginname} or  t1.pm =  #{srf.sessioncontext.srfloginname} or t1.PO = #{srf.sessioncontext.srfloginname} or t1.RD = #{srf.sessioncontext.srfloginname} or t1.QD =  #{srf.sessioncontext.srfloginname} ) union  SELECT t1.MDEPTID, t1.orgid, t1.`ACL`, t1.`BEGIN`, (SELECT COUNT(1) FROM ZT_BUG WHERE PROJECT = t1.`ID` AND DELETED = '0') AS `BUGCNT`, t1.`CANCELEDBY`, (select count(1) + 1 from zt_doclib where type = 'project' and project = t1.`id`) as `DOCLIBCNT`, t1.`CANCELEDDATE`, t1.`CATID`, t1.`CLOSEDBY`, t1.`CLOSEDDATE`, t1.`CODE`, t1.`DAYS`, t1.`DELETED`, t1.`END`, t1.`ID`, t1.`ISCAT`, t1.`NAME`, t1.`OPENEDBY`, t1.`OPENEDDATE`, t1.`OPENEDVERSION`, t1.`ORDER`, (CASE WHEN T2.OBJECTORDER IS NOT NULL THEN T2.OBJECTORDER ELSE  t1.`ORDER` END) as `ORDER1`, 	(CASE WHEN T2.OBJECTORDER IS NOT NULL THEN 1 ELSE 0 END) as `ISTOP`, t1.`PARENT`, t11.`NAME` AS `PARENTNAME`, t1.`PM`, t1.`PO`, t1.`PRI`, t1.`QD`, t1.`RD`, t1.`STATGE`, t1.`STATUS`, (SELECT COUNT(1) FROM ZT_STORY LEFT JOIN ZT_PROJECTSTORY ON ZT_STORY.ID = ZT_PROJECTSTORY.STORY WHERE PROJECT = t1.`ID` AND DELETED = '0') AS `STORYCNT`, t1.`SUBSTATUS`, (SELECT COUNT(1) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0') AS `TASKCNT`, t1.`TEAM`, (SELECT round(SUM(CONSUMED),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0' AND ( `parent` = '' or `parent` = '0' or `parent` = '-1')) AS `TOTALCONSUMED`, (SELECT round(SUM(ESTIMATE),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED =  '0' AND ( `parent` = '' or `parent` = '0' or `parent` = '-1')) AS `TOTALESTIMATE`, (select sum(days * hours)  from zt_team tt where type = 'project' and root = t1.id) AS `TOTALHOURS`, (SELECT round(SUM(`LEFT`),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0' and `status` in ('doing','wait','pause') AND ( `parent` = '' or `parent` = '0' or `parent` = '-1')) AS `TOTALLEFT`, ((SELECT round(SUM( `LEFT` ),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0' AND ( `parent` = '' OR `parent` = '0' OR `parent` = '-1' ) AND `status` in ('doing','wait','pause')) + (SELECT round(SUM( CONSUMED ),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0' AND ( `parent` = '' OR `parent` = '0' OR `parent` = '-1' ))) AS `TOTALWH`, t1.`TYPE`, t1.PROJECTSN FROM `zt_project` t1  left join t_ibz_top t2 on t1.id = t2.OBJECTID and t2.type = 'project' and t2.ACCOUNT = #{srf.sessioncontext.srfloginname} LEFT JOIN zt_project t11 ON t1.PARENT = t11.ID  where t1.deleted = '0' and t1.acl = 'private' and t1.id in (select t3.root from zt_team t3 where t3.account = #{srf.sessioncontext.srfloginname}   and t3.type = 'project')) t1 ]]>
		<trim prefix="where" prefixOverrides="and">
			<if test="true">
                <![CDATA[ AND t1.deleted = '0' ]]>
            </if>
			<if test="true">
                <![CDATA[ AND t1.`status` <> 'closed' ]]>
            </if>
			<include refid="searchMode" />
		</trim>
    </sql>
	
	<select id="selectUnDoneProject"  parameterType="cn.ibizlab.pms.core.zentao.filter.ProjectSearchContext" resultMap="ProjectResultMap">
		<include refid="UnDoneProject" />
	</select>

    <!--数据查询[View]-->
    <sql id="View" databaseId="mysql">
		<![CDATA[ SELECT t1.`ACL`, t1.`BEGIN`, (SELECT COUNT(1) FROM ZT_BUG WHERE PROJECT = t1.`ID` AND DELETED = '0') AS `BUGCNT`, t1.`CANCELEDBY`, t1.`CANCELEDDATE`, t1.`CATID`, t1.`CLOSEDBY`, t1.`CLOSEDDATE`, t1.`CODE`, t1.`DAYS`, t1.`DELETED`, t1.`DESC`, t1.`END`, t1.`ID`, t1.`ISCAT`, '0' AS `ISTOP`, t1.`MDEPTID`, t1.`MDEPTNAME`, t1.`NAME`, t1.`OPENEDBY`, t1.`OPENEDDATE`, t1.`OPENEDVERSION`, t1.`ORDER`, t1.`order` AS `ORDER1`, t1.`ORGID`, t1.`ORGNAME`, t1.`PARENT`, t11.`NAME` AS `PARENTNAME`, t1.`PM`, t1.`PMSEEPROJECTINFO`, t1.`PO`, t1.`PRI`, t1.`PROJECTSN`, t1.`QD`, t1.`RD`, t1.`STATGE`, t1.`STATUS`, (SELECT COUNT(1) FROM ZT_STORY LEFT JOIN ZT_PROJECTSTORY ON ZT_STORY.ID = ZT_PROJECTSTORY.STORY WHERE PROJECT = t1.`ID` AND DELETED = '0') AS `STORYCNT`, t1.`SUBSTATUS`, t1.`SUPPROREPORT`, (SELECT COUNT(1) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0') AS `TASKCNT`, t1.`TEAM`, (SELECT round(SUM(CONSUMED),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0' AND ( `parent` = '' or `parent` = '0' or `parent` = '-1')) AS `TOTALCONSUMED`, (SELECT round(SUM(ESTIMATE),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED =  '0' AND ( `parent` = '' or `parent` = '0' or `parent` = '-1')) AS `TOTALESTIMATE`, (select sum(days * hours)  from zt_team tt where type = 'project' and root = t1.id) AS `TOTALHOURS`, (SELECT round(SUM(`LEFT`),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0' and `status` in ('doing','wait','pause') AND ( `parent` = '' or `parent` = '0' or `parent` = '-1')) AS `TOTALLEFT`, ((SELECT round(SUM( `LEFT` ),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0' AND ( `parent` = '' OR `parent` = '0' OR `parent` = '-1' ) AND `status` in ('doing','wait','pause')) + (SELECT round(SUM( CONSUMED ),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0' AND ( `parent` = '' OR `parent` = '0' OR `parent` = '-1' ))) AS `TOTALWH`, t1.`TYPE`, t1.`UPDATEBY`, t1.`WHITELIST` FROM `zt_project` t1  LEFT JOIN `zt_project` t11 ON t1.`PARENT` = t11.`ID`   ]]>
		<trim prefix="where" prefixOverrides="and">
			<if test="true">
                <![CDATA[ AND t1.DELETED = '0' ]]>
            </if>
			<include refid="searchMode" />
		</trim>
    </sql>
	
	<select id="selectView"  parameterType="cn.ibizlab.pms.core.zentao.filter.ProjectSearchContext" resultMap="ProjectResultMap">
		<include refid="View" />
	</select>

</mapper>

