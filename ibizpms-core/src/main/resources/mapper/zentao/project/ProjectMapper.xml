<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper	namespace="cn.ibizlab.pms.core.zentao.mapper.ProjectMapper">

    <!--该方法用于重写mybatis中selectById方法，以实现查询逻辑属性-->
	<select id="selectById"  resultMap="ProjectResultMap" databaseId="mysql">
        <![CDATA[select t1.* from (SELECT t1.`ACL`, t1.`BEGIN`, (SELECT COUNT(1) FROM ZT_BUG WHERE PROJECT = t1.`ID` AND DELETED = '0') AS `BUGCNT`, t1.`CANCELEDBY`, t1.`CANCELEDDATE`, t1.`CATID`, t1.`CLOSEDBY`, t1.`CLOSEDDATE`, t1.`CODE`, t1.`DAYS`, t1.`DELETED`, t1.`DESC`, t1.`END`, t1.`ID`, t1.`ISCAT`, t1.`NAME`, t1.`OPENEDBY`, t1.`OPENEDDATE`, t1.`OPENEDVERSION`, t1.`ORDER`, t1.`PARENT`, t11.`NAME` AS `PARENTNAME`, t1.`PM`, t1.`PO`, t1.`PRI`, t1.`QD`, t1.`RD`, t1.`STATGE`, t1.`STATUS`, (SELECT COUNT(1) FROM ZT_STORY LEFT JOIN ZT_PROJECTSTORY ON ZT_STORY.ID = ZT_PROJECTSTORY.STORY WHERE PROJECT = t1.`ID` AND DELETED = '0') AS `STORYCNT`, t1.`SUBSTATUS`, (SELECT COUNT(1) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0') AS `TASKCNT`, t1.`TEAM`, (SELECT round(SUM(CONSUMED),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0' AND ( `parent` = '' or `parent` = '0' or `parent` = '-1')) AS `TOTALCONSUMED`, (SELECT round(SUM(ESTIMATE),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED =  '0' AND ( `parent` = '' or `parent` = '0' or `parent` = '-1')) AS `TOTALESTIMATE`, (select sum(days * hours)  from zt_team tt where type = 'project' and root = t1.id) AS `TOTALHOURS`, (SELECT round(SUM(`LEFT`),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0' AND ( `parent` = '' or `parent` = '0' or `parent` = '-1')) AS `TOTALLEFT`, ((SELECT round(SUM( ESTIMATE ),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0' AND ( `parent` = '' OR `parent` = '0' OR `parent` = '-1' ) ) + (SELECT round(SUM( CONSUMED ),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0' AND ( `parent` = '' OR `parent` = '0' OR `parent` = '-1' ) )) AS `TOTALWH`, t1.`TYPE`, t1.`WHITELIST` FROM `zt_project` t1  LEFT JOIN zt_project t11 ON t1.PARENT = t11.ID  ) t1 where id=#{id}]]>
    </select>

    <!--通过mybatis将查询结果注入到entity中,通过配置autoMapping="true"由mybatis自动处理映射关系 -->
    <resultMap id="ProjectResultMap" type="cn.ibizlab.pms.core.zentao.domain.Project" autoMapping="true">
        <id property="id" column="id" /><!--主键字段映射-->
		<result property="parent" column="parent" />
            
		
		<!--通过mybatis自动注入关系属性[主实体]，fetchType="lazy"为懒加载配置 -->
		<association property="ibizparent" javaType="cn.ibizlab.pms.core.zentao.domain.Project" column="parent" select="cn.ibizlab.pms.core.zentao.mapper.ProjectMapper.selectById" fetchType="lazy"></association>
    </resultMap>

	<!--关系实体暴露select方法供主实体通过外键查询关系实体数据[实体关系名称:DER1N__ZT_PROJECT__ZT_PROJECT__PARENT] -->
	 <select id="selectByParent" resultMap="ProjectResultMap">
         select t1.* from (
                <include refid="Default" />
			 ) t1
			 where  parent=#{id}
     </select>

    <!--数据集合[BugProject]-->
	 <select id="searchBugProject"  parameterType="cn.ibizlab.pms.core.zentao.filter.ProjectSearchContext"  resultMap="ProjectResultMap">
         select t1.* from (
                <include refid="BugSelectableProjectList" />
         )t1
         <where><if test="ew!=null and ew.sqlSegment!=null and !ew.emptyOfWhere">${ew.sqlSegment}</if></where>
         <if test="ew!=null and ew.sqlSegment!=null and ew.emptyOfWhere">${ew.sqlSegment}</if>
     </select>

    <!--数据集合[CurProduct]-->
	 <select id="searchCurProduct"  parameterType="cn.ibizlab.pms.core.zentao.filter.ProjectSearchContext"  resultMap="ProjectResultMap">
         select t1.* from (
                <include refid="CurProduct" />
         )t1
         <where><if test="ew!=null and ew.sqlSegment!=null and !ew.emptyOfWhere">${ew.sqlSegment}</if></where>
         <if test="ew!=null and ew.sqlSegment!=null and ew.emptyOfWhere">${ew.sqlSegment}</if>
     </select>

    <!--数据集合[Default]-->
	 <select id="searchDefault"  parameterType="cn.ibizlab.pms.core.zentao.filter.ProjectSearchContext"  resultMap="ProjectResultMap">
         select t1.* from (
                <include refid="Default" />
         )t1
         <where><if test="ew!=null and ew.sqlSegment!=null and !ew.emptyOfWhere">${ew.sqlSegment}</if></where>
         <if test="ew!=null and ew.sqlSegment!=null and ew.emptyOfWhere">${ew.sqlSegment}</if>
     </select>

    <!--数据集合[MyProject]-->
	 <select id="searchMyProject"  parameterType="cn.ibizlab.pms.core.zentao.filter.ProjectSearchContext"  resultMap="ProjectResultMap">
         select t1.* from (
                <include refid="MyProject" />
         )t1
         <where><if test="ew!=null and ew.sqlSegment!=null and !ew.emptyOfWhere">${ew.sqlSegment}</if></where>
         <if test="ew!=null and ew.sqlSegment!=null and ew.emptyOfWhere">${ew.sqlSegment}</if>
     </select>

    <!--数据查询[BugSelectableProjectList]-->
    <sql id="BugSelectableProjectList" databaseId="mysql">
		<![CDATA[ SELECT t1.`ACL`, t1.`BEGIN`, (SELECT COUNT(1) FROM ZT_BUG WHERE PROJECT = t1.`ID` AND DELETED = '0') AS `BUGCNT`, t1.`CANCELEDBY`, t1.`CANCELEDDATE`, t1.`CATID`, t1.`CLOSEDBY`, t1.`CLOSEDDATE`, t1.`CODE`, t1.`DAYS`, t1.`DELETED`, t1.`END`, t1.`ID`, t1.`ISCAT`, t1.`NAME`, t1.`OPENEDBY`, t1.`OPENEDDATE`, t1.`OPENEDVERSION`, t1.`ORDER`, t1.`PARENT`, t11.`NAME` AS `PARENTNAME`, t1.`PM`, t1.`PO`, t1.`PRI`, t1.`QD`, t1.`RD`, t1.`STATGE`, t1.`STATUS`, (SELECT COUNT(1) FROM ZT_STORY LEFT JOIN ZT_PROJECTSTORY ON ZT_STORY.ID = ZT_PROJECTSTORY.STORY WHERE PROJECT = t1.`ID` AND DELETED = '0') AS `STORYCNT`, t1.`SUBSTATUS`, (SELECT COUNT(1) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0') AS `TASKCNT`, t1.`TEAM`, (SELECT round(SUM(CONSUMED),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0' AND ( `parent` = '' or `parent` = '0' or `parent` = '-1')) AS `TOTALCONSUMED`, (SELECT round(SUM(ESTIMATE),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED =  '0' AND ( `parent` = '' or `parent` = '0' or `parent` = '-1')) AS `TOTALESTIMATE`, (select sum(days * hours)  from zt_team tt where type = 'project' and root = t1.id) AS `TOTALHOURS`, (SELECT round(SUM(`LEFT`),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0' AND ( `parent` = '' or `parent` = '0' or `parent` = '-1')) AS `TOTALLEFT`, ((SELECT round(SUM( ESTIMATE ),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0' AND ( `parent` = '' OR `parent` = '0' OR `parent` = '-1' ) ) + (SELECT round(SUM( CONSUMED ),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0' AND ( `parent` = '' OR `parent` = '0' OR `parent` = '-1' ) )) AS `TOTALWH`, t1.`TYPE` FROM `zt_project` t1  LEFT JOIN zt_project t11 ON t1.PARENT = t11.ID  LEFT OUTER JOIN zt_projectproduct t21 ON t1.ID = t21.PROJECT  
					 WHERE 	( ( #{srf.webcontext.product} is null  OR  t21.`PRODUCT` = #{srf.webcontext.product} ) )
						 AND t1.DELETED = '0'
			]]>
    </sql>
    <!--数据查询[CurProduct]-->
    <sql id="CurProduct" databaseId="mysql">
		<![CDATA[ SELECT t1.`ACL`, t1.`BEGIN`, (SELECT COUNT(1) FROM ZT_BUG WHERE PROJECT = t1.`ID` AND DELETED = '0') AS `BUGCNT`, t1.`CANCELEDBY`, t1.`CANCELEDDATE`, t1.`CATID`, t1.`CLOSEDBY`, t1.`CLOSEDDATE`, t1.`CODE`, t1.`DAYS`, t1.`DELETED`, t1.`END`, t1.`ID`, t1.`ISCAT`, t1.`NAME`, t1.`OPENEDBY`, t1.`OPENEDDATE`, t1.`OPENEDVERSION`, t1.`ORDER`, t1.`PARENT`, t11.`NAME` AS `PARENTNAME`, t1.`PM`, t1.`PO`, t1.`PRI`, t1.`QD`, t1.`RD`, t1.`STATGE`, t1.`STATUS`, (SELECT COUNT(1) FROM ZT_STORY LEFT JOIN ZT_PROJECTSTORY ON ZT_STORY.ID = ZT_PROJECTSTORY.STORY WHERE PROJECT = t1.`ID` AND DELETED = '0') AS `STORYCNT`, t1.`SUBSTATUS`, (SELECT COUNT(1) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0') AS `TASKCNT`, t1.`TEAM`, (SELECT round(SUM(CONSUMED),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0' AND ( `parent` = '' or `parent` = '0' or `parent` = '-1')) AS `TOTALCONSUMED`, (SELECT round(SUM(ESTIMATE),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED =  '0' AND ( `parent` = '' or `parent` = '0' or `parent` = '-1')) AS `TOTALESTIMATE`, (select sum(days * hours)  from zt_team tt where type = 'project' and root = t1.id) AS `TOTALHOURS`, (SELECT round(SUM(`LEFT`),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0' AND ( `parent` = '' or `parent` = '0' or `parent` = '-1')) AS `TOTALLEFT`, ((SELECT round(SUM( ESTIMATE ),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0' AND ( `parent` = '' OR `parent` = '0' OR `parent` = '-1' ) ) + (SELECT round(SUM( CONSUMED ),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0' AND ( `parent` = '' OR `parent` = '0' OR `parent` = '-1' ) )) AS `TOTALWH`, t1.`TYPE` FROM `zt_project` t1  LEFT JOIN zt_project t11 ON t1.PARENT = t11.ID  
					 WHERE 	EXISTS(SELECT * FROM zt_projectproduct t21   WHERE   t1.ID = t21.PROJECT  AND  ( t21.`PRODUCT` = #{srf.datacontext.n_product_eq} ) )
						 AND t1.DELETED = '0'
			]]>
    </sql>
    <!--数据查询[Default]-->
    <sql id="Default" databaseId="mysql">
		<![CDATA[ SELECT t1.`ACL`, t1.`BEGIN`, (SELECT COUNT(1) FROM ZT_BUG WHERE PROJECT = t1.`ID` AND DELETED = '0') AS `BUGCNT`, t1.`CANCELEDBY`, t1.`CANCELEDDATE`, t1.`CATID`, t1.`CLOSEDBY`, t1.`CLOSEDDATE`, t1.`CODE`, t1.`DAYS`, t1.`DELETED`, t1.`END`, t1.`ID`, t1.`ISCAT`, t1.`NAME`, t1.`OPENEDBY`, t1.`OPENEDDATE`, t1.`OPENEDVERSION`, t1.`ORDER`, t1.`PARENT`, t11.`NAME` AS `PARENTNAME`, t1.`PM`, t1.`PO`, t1.`PRI`, t1.`QD`, t1.`RD`, t1.`STATGE`, t1.`STATUS`, (SELECT COUNT(1) FROM ZT_STORY LEFT JOIN ZT_PROJECTSTORY ON ZT_STORY.ID = ZT_PROJECTSTORY.STORY WHERE PROJECT = t1.`ID` AND DELETED = '0') AS `STORYCNT`, t1.`SUBSTATUS`, (SELECT COUNT(1) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0') AS `TASKCNT`, t1.`TEAM`, (SELECT round(SUM(CONSUMED),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0' AND ( `parent` = '' or `parent` = '0' or `parent` = '-1')) AS `TOTALCONSUMED`, (SELECT round(SUM(ESTIMATE),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED =  '0' AND ( `parent` = '' or `parent` = '0' or `parent` = '-1')) AS `TOTALESTIMATE`, (select sum(days * hours)  from zt_team tt where type = 'project' and root = t1.id) AS `TOTALHOURS`, (SELECT round(SUM(`LEFT`),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0' AND ( `parent` = '' or `parent` = '0' or `parent` = '-1')) AS `TOTALLEFT`, ((SELECT round(SUM( ESTIMATE ),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0' AND ( `parent` = '' OR `parent` = '0' OR `parent` = '-1' ) ) + (SELECT round(SUM( CONSUMED ),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0' AND ( `parent` = '' OR `parent` = '0' OR `parent` = '-1' ) )) AS `TOTALWH`, t1.`TYPE` FROM `zt_project` t1  LEFT JOIN zt_project t11 ON t1.PARENT = t11.ID  
					 WHERE 	t1.DELETED = '0'
			]]>
    </sql>
    <!--数据查询[MyProject]-->
    <sql id="MyProject" databaseId="mysql">
		<![CDATA[ select t1.* from (SELECT 	t1.`ACL`, 	t1.`BEGIN`, 	( SELECT COUNT( 1 ) FROM ZT_BUG WHERE PROJECT = t1.`ID` AND DELETED = '0' ) AS `BUGCNT`, 	t1.`CANCELEDBY`, 	t1.`CANCELEDDATE`, 	t1.`CATID`, 	t1.`CLOSEDBY`, 	t1.`CLOSEDDATE`, 	t1.`CODE`, 	t1.`DAYS`, 	t1.`DELETED`, 	t1.`END`, 	t1.`ID`, 	t1.`ISCAT`, 	t1.`NAME`, 	t1.`OPENEDBY`, 	t1.`OPENEDDATE`, 	t1.`OPENEDVERSION`, 	t1.`ORDER`, 	t1.`PARENT`, 	t11.`NAME` AS `PARENTNAME`, 	t1.`PM`, 	t1.`PO`, 	t1.`PRI`, 	t1.`QD`, 	t1.`RD`, 	t1.`STATGE`, 	t1.`STATUS`, 	( SELECT 	COUNT( 1 )  FROM 	ZT_STORY 	LEFT JOIN ZT_PROJECTSTORY ON ZT_STORY.ID = ZT_PROJECTSTORY.STORY  WHERE 	PROJECT = t1.`ID`  	AND DELETED = '0'  	) AS `STORYCNT`, 	t1.`SUBSTATUS`, 	( SELECT COUNT( 1 ) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0' ) AS `TASKCNT`, 	t1.`TEAM`, 	t1.`TYPE` , 	t21.role, 	t21.account, 	t21.`join`, 	t21.hours FROM 	`zt_project` t1 	LEFT JOIN zt_project t11 ON t1.PARENT = t11.ID 	INNER JOIN zt_team t21 on t1.ID = t21.root and t21.type= 'project' ) t1
					 WHERE 	t1.DELETED = '0'
			]]>
    </sql>
    <!--数据查询[View]-->
    <sql id="View" databaseId="mysql">
		<![CDATA[ SELECT t1.`ACL`, t1.`BEGIN`, (SELECT COUNT(1) FROM ZT_BUG WHERE PROJECT = t1.`ID` AND DELETED = '0') AS `BUGCNT`, t1.`CANCELEDBY`, t1.`CANCELEDDATE`, t1.`CATID`, t1.`CLOSEDBY`, t1.`CLOSEDDATE`, t1.`CODE`, t1.`DAYS`, t1.`DELETED`, t1.`DESC`, t1.`END`, t1.`ID`, t1.`ISCAT`, t1.`NAME`, t1.`OPENEDBY`, t1.`OPENEDDATE`, t1.`OPENEDVERSION`, t1.`ORDER`, t1.`PARENT`, t11.`NAME` AS `PARENTNAME`, t1.`PM`, t1.`PO`, t1.`PRI`, t1.`QD`, t1.`RD`, t1.`STATGE`, t1.`STATUS`, (SELECT COUNT(1) FROM ZT_STORY LEFT JOIN ZT_PROJECTSTORY ON ZT_STORY.ID = ZT_PROJECTSTORY.STORY WHERE PROJECT = t1.`ID` AND DELETED = '0') AS `STORYCNT`, t1.`SUBSTATUS`, (SELECT COUNT(1) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0') AS `TASKCNT`, t1.`TEAM`, (SELECT round(SUM(CONSUMED),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0' AND ( `parent` = '' or `parent` = '0' or `parent` = '-1')) AS `TOTALCONSUMED`, (SELECT round(SUM(ESTIMATE),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED =  '0' AND ( `parent` = '' or `parent` = '0' or `parent` = '-1')) AS `TOTALESTIMATE`, (select sum(days * hours)  from zt_team tt where type = 'project' and root = t1.id) AS `TOTALHOURS`, (SELECT round(SUM(`LEFT`),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0' AND ( `parent` = '' or `parent` = '0' or `parent` = '-1')) AS `TOTALLEFT`, ((SELECT round(SUM( ESTIMATE ),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0' AND ( `parent` = '' OR `parent` = '0' OR `parent` = '-1' ) ) + (SELECT round(SUM( CONSUMED ),0) FROM ZT_TASK WHERE PROJECT = t1.`ID` AND DELETED = '0' AND ( `parent` = '' OR `parent` = '0' OR `parent` = '-1' ) )) AS `TOTALWH`, t1.`TYPE`, t1.`WHITELIST` FROM `zt_project` t1  LEFT JOIN zt_project t11 ON t1.PARENT = t11.ID  
					 WHERE 	t1.DELETED = '0'
			]]>
    </sql>
</mapper>

