import{a as t,f as e}from"./p-38dcedc4.js";class n{constructor(){this.map=new Map,this.maxListeners=100}setMaxListeners(t){this.maxListeners=t}addListener(t,e){if(e instanceof Function){this.map.has(t)||this.map.set(t,[]);const n=this.map.get(t);n.length<this.maxListeners?n.push(e):console.warn("事件监听已达最大上限，无法新增监听!")}else console.error("回调必须是一个函数!")}removeListener(t,e){if(this.map.has(t)){const n=this.map.get(t);if(n.length>0)for(let t=0;t<n.length;t++)if(n[t]===e){n.splice(t,1);break}}}emit(t,...e){this.map.has(t)&&this.map.get(t).forEach((t=>{t(...e)}))}}class r{constructor(t){this.e=new n,this.e.setMaxListeners(t||300)}on(t,e){this.e.addListener(t,e)}off(t,e){this.e.removeListener(t,e)}emit(t,e){this.e.emit(t,e)}}function s(t){return"[object Object]"===Object.prototype.toString.call(t)}function i(t){return"[object Array]"===Object.prototype.toString.call(t)}function o(t){return null!=t&&"object"==typeof t&&!0===t["@@functional/placeholder"]}function c(t){return function e(n){return 0===arguments.length||o(n)?e:t.apply(this,arguments)}}function u(t){return function e(n,r){switch(arguments.length){case 0:return e;case 1:return o(n)?e:c((function(e){return t(n,e)}));default:return o(n)&&o(r)?e:o(n)?c((function(e){return t(e,r)})):o(r)?c((function(e){return t(n,e)})):t(n,r)}}}const a=Array.isArray||function(t){return null!=t&&t.length>=0&&"[object Array]"===Object.prototype.toString.call(t)};function f(t,e){return Object.prototype.hasOwnProperty.call(e,t)}var h=Object.prototype.toString,l=function(){return"[object Arguments]"===h.call(arguments)?function(t){return"[object Arguments]"===h.call(t)}:function(t){return f("callee",t)}}(),p=!{toString:null}.propertyIsEnumerable("toString"),y=["constructor","valueOf","isPrototypeOf","toString","propertyIsEnumerable","hasOwnProperty","toLocaleString"],b=function(){return arguments.propertyIsEnumerable("length")}(),g=function(t,e){for(var n=0;n<t.length;){if(t[n]===e)return!0;n+=1}return!1},j=c("function"!=typeof Object.keys||b?function(t){if(Object(t)!==t)return[];var e,n,r=[],s=b&&l(t);for(e in t)!f(e,t)||s&&"length"===e||(r[r.length]=e);if(p)for(n=y.length-1;n>=0;)f(e=y[n],t)&&!g(r,e)&&(r[r.length]=e),n-=1;return r}:function(t){return Object(t)!==t?[]:Object.keys(t)}),O=c((function(t){return null==t})),A=c((function(t){return null===t?"Null":void 0===t?"Undefined":Object.prototype.toString.call(t).slice(8,-1)}));function d(t){for(var e,n=[];!(e=t.next()).done;)n.push(e.value);return n}function w(t,e,n){for(var r=0,s=n.length;r<s;){if(t(e,n[r]))return!0;r+=1}return!1}const v="function"==typeof Object.is?Object.is:function(t,e){return t===e?0!==t||1/t==1/e:t!=t&&e!=e};function m(t,e,n,r){var s=d(t);function i(t,e){return S(t,e,n.slice(),r.slice())}return!w((function(t,e){return!w(i,e,t)}),d(e),s)}function S(t,e,n,r){if(v(t,e))return!0;var s,i=A(t);if(i!==A(e))return!1;if(null==t||null==e)return!1;if("function"==typeof t["fantasy-land/equals"]||"function"==typeof e["fantasy-land/equals"])return"function"==typeof t["fantasy-land/equals"]&&t["fantasy-land/equals"](e)&&"function"==typeof e["fantasy-land/equals"]&&e["fantasy-land/equals"](t);if("function"==typeof t.equals||"function"==typeof e.equals)return"function"==typeof t.equals&&t.equals(e)&&"function"==typeof e.equals&&e.equals(t);switch(i){case"Arguments":case"Array":case"Object":if("function"==typeof t.constructor&&"Promise"===(null==(s=String(t.constructor).match(/^function (\w*)/))?"":s[1]))return t===e;break;case"Boolean":case"Number":case"String":if(typeof t!=typeof e||!v(t.valueOf(),e.valueOf()))return!1;break;case"Date":if(!v(t.valueOf(),e.valueOf()))return!1;break;case"Error":return t.name===e.name&&t.message===e.message;case"RegExp":if(t.source!==e.source||t.global!==e.global||t.ignoreCase!==e.ignoreCase||t.multiline!==e.multiline||t.sticky!==e.sticky||t.unicode!==e.unicode)return!1}for(var o=n.length-1;o>=0;){if(n[o]===t)return r[o]===e;o-=1}switch(i){case"Map":return t.size===e.size&&m(t.entries(),e.entries(),n.concat([t]),r.concat([e]));case"Set":return t.size===e.size&&m(t.values(),e.values(),n.concat([t]),r.concat([e]));case"Arguments":case"Array":case"Object":case"Boolean":case"Number":case"String":case"Date":case"Error":case"RegExp":case"Int8Array":case"Uint8Array":case"Uint8ClampedArray":case"Int16Array":case"Uint16Array":case"Int32Array":case"Uint32Array":case"Float32Array":case"Float64Array":case"ArrayBuffer":break;default:return!1}var c=j(t);if(c.length!==j(e).length)return!1;var u=n.concat([t]),a=r.concat([e]);for(o=c.length-1;o>=0;){var h=c[o];if(!f(h,e)||!S(e[h],t[h],u,a))return!1;o-=1}return!0}var x=u((function(t,e){return S(t,e,[],[])})),P=c((function(t){return null!=t&&"function"==typeof t["fantasy-land/empty"]?t["fantasy-land/empty"]():null!=t&&null!=t.constructor&&"function"==typeof t.constructor["fantasy-land/empty"]?t.constructor["fantasy-land/empty"]():null!=t&&"function"==typeof t.empty?t.empty():null!=t&&null!=t.constructor&&"function"==typeof t.constructor.empty?t.constructor.empty():a(t)?[]:function(t){return"[object String]"===Object.prototype.toString.call(t)}(t)?"":function(t){return"[object Object]"===Object.prototype.toString.call(t)}(t)?{}:l(t)?function(){return arguments}():void 0})),I=c((function(t){return null!=t&&x(t,P(t))}));function M(t){return!O(t)&&!I(t)}class C{constructor(t,e,n){var r;this.enableOpenDesign=!1,this.text=null,this.key=n,i(t)?(this.type="array",this.models=t,this.text=n):s(t)?(this.type="object",this.model=t,this.text=this.calcText(this.model),this.calcEnableOpenDesign(this.model)):(this.type="default",this.text=n,"[object Boolean]"===Object.prototype.toString.call(e)?this.value=e.toString():s(e)?(this.value=e.id,this.text=`<ref> ${e.id}`):this.value=e),(O(r=this.text)||I(r))&&console.error("展示文本计算异常!",this.model)}get existKey(){return M(this.key)}get isDefault(){return"default"===this.type}get isArray(){return"array"===this.type}get isObj(){return"object"===this.type}get data(){return this.isObj?this.model.isFill?this.model.M:this.model.refM:this.models}calcEnableOpenDesign(t){(t.instanceof("app.view.IPSAppView")||t.instanceof("control.IPSControl"))&&(this.enableOpenDesign=!0)}calcText(t){const e=this.data;return t.instanceof("app.view.IPSAppView")&&e.modelref?e.view?`${e.view}[${e.viewType}]`:e.viewType:t.name||t.codeName}}const E=t=>!("isConnected"in t)||t.isConnected,U=(()=>{let t;return(...e)=>{t&&clearTimeout(t),t=setTimeout((()=>{t=0,(t=>{for(let e of t.keys())t.set(e,t.get(e).filter(E))})(...e)}),2e3)}})();class k{constructor(){this.appLoaded=!1,this.modelService=null,this.model=null,this.context={},this.params={}}}class D extends class{constructor(){this.evt=new r(3e3),this.store=((n,r)=>{const s=((t,e=((t,e)=>t!==e))=>{let n=new Map(Object.entries(null!=t?t:{}));const r={dispose:[],get:[],set:[],reset:[]},s=()=>{n=new Map(Object.entries(null!=t?t:{})),r.reset.forEach((t=>t()))},i=t=>(r.get.forEach((e=>e(t))),n.get(t)),o=(t,s)=>{const i=n.get(t);e(s,i,t)&&(n.set(t,s),r.set.forEach((e=>e(t,s,i))))},c="undefined"==typeof Proxy?{}:new Proxy(t,{get:(t,e)=>i(e),ownKeys:()=>Array.from(n.keys()),getOwnPropertyDescriptor:()=>({enumerable:!0,configurable:!0}),has:(t,e)=>n.has(e),set:(t,e,n)=>(o(e,n),!0)}),u=(t,e)=>(r[t].push(e),()=>{((t,e)=>{const n=t.indexOf(e);n>=0&&(t[n]=t[t.length-1],t.length--)})(r[t],e)});return{state:c,get:i,set:o,on:u,onChange:(e,n)=>{const r=u("set",((t,r)=>{t===e&&n(r)})),s=u("reset",(()=>n(t[e])));return()=>{r(),s()}},use:(...t)=>t.forEach((t=>{t.set&&u("set",t.set),t.get&&u("get",t.get),t.reset&&u("reset",t.reset)})),dispose:()=>{r.dispose.forEach((t=>t())),s()},reset:s,forceUpdate:t=>{const e=n.get(t);r.set.forEach((n=>n(t,e,e)))}}})(n,r);return(({on:n})=>{const r=new Map;"function"==typeof t&&(n("dispose",(()=>{r.clear()})),n("get",(e=>{const n=t();n&&((t,e,n)=>{const r=t.get(e);r?r.includes(n)||r.push(n):t.set(e,[n])})(r,e,n)})),n("set",(t=>{const n=r.get(t);n&&r.set(t,n.filter(e)),U(r)})),n("reset",(()=>{r.forEach((t=>t.forEach(e))),U(r)})))})(s),s})(this.getState()),this.data=this.store.state,this.init()}init(){for(const t in this.data)this.store.onChange(t,(e=>{this.evt.emit(t,e),this.evt.emit("change",t,e)}))}on(t,e){return this.evt.on(t,e)}off(t,e){return this.evt.off(t,e)}onChange(t){this.evt.on("change",t)}offChange(t){this.evt.off("change",t)}}{constructor(){if(D.instance)return D.instance;super()}getState(){return new k}static getInstance(){return this.instance}}D.instance=new D;export{D as G,C as M,i as a,s as i,M as n}