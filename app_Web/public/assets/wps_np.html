<!DOCTYPE html>
<html lang="en" style="height: 100%;">

<head>
  <meta charset="UTF-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <meta content="ie=edge" http-equiv="X-UA-Compatible">
  <title>文档</title>
  <script src="./js/wps-ext.js" type="text/javascript"></script>


  <style>
    html,
    body {
      margin: 0;
      padding: 0;
    }

    embed {
      box-shadow: 0 0 2px black;
    }

    #wpsContainer {
      height: 99%;
    }

    #saveToRemoteBtn,
    #confrimSaveBtn {
      position: absolute;
      right: 0;
      width: 100px;
      height: 40px;
      cursor: pointer;
      /*opacity:0;*/
      filter: alpha(opacity=0);
      z-index: -9999;
    }
  </style>

  <script>
    // 打开远程文档地址（本地测试用）
    let remoteGetUrl = '';
    // 保存远程文档地址（本地测试用）
    let remoteSaveUrl = '';
    // 获取url中的readonly,true表示只读打卡文档
    let readonly = '';
    // 获取基础路径
    let baseUrl ='';
    // 处理信息
    let $log;

		/**
		 * 打印处理信息
		 */
    function log(value) {
      if (!$log) {
        $log = document.querySelector("#log");
      }

      if (typeof value === 'string' || value instanceof String) {
        alert(value);
        return;
      }

      let toShow = '';
      for (let k in value) {
        toShow = `${toShow}${k}:${value[k]}`
      }
      alert(toShow);
    }

		/**
		 * 处理
		 */
    function handlePromise(promise, then, katch) {
      promise
        .then(value => {
          then ? then(value) : log(value);
        })
        .catch(e => {
          console.error(e);
          katch ? katch(e.message) : log(e.message);
        });
    }

		/**
		 * 获取url中的参数
		 */
    function getUrlParam(name) {
      var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)"); //构造一个含有目标参数的正则表达式对象
      var r = window.location.search.substr(1).match(reg); //匹配目标参数
      if (r != null) return unescape(r[2]);
      return null; //返回参数值
    }

		/**
		 * 获取需要的location部分
		 */
    function getNeedLocation() {
      // 截取地址，拼接需要部分组成新地址
      if(!baseUrl) {
        const scheme = window.location.protocol;
        const host = window.location.host;
        baseUrl = scheme + "//" + host + "/";
      }
      return baseUrl;
    }

		/**
		 * 保存到远程文档
		 */
    function saveToRemote() {
      // handlePromise(wpsExt.apis.saveToRemote({ url: "http://172.16.100.204:18080/net-disk/editview/recdoc/210513_1392780787876675585/%E6%A8%A1%E6%9D%BF%E6%96%87%E4%BB%B6.wps?authcode=1392780787897647106" }), () => {
      //   log('保存完成');
      // });
      return wpsExt.apis.getText();
    }

    /**
		 * 打开文档
		 */
     function openFile(file,param) {
      handlePromise(wpsExt.apis.openRemoteDoc({file,readonly:param.readonly,isempty:param.isempty}), () => { console.log('打开文档完成'); });
    }

		/**
		 * 保存确认
		 */
    function confrimSave() {
      var flag = confirm("是否保存文档?");
      if (flag == true) {
        saveToRemote();
      }
    }

		/**
		 * 初始化
		 */
    function init() {
      readOnly = getUrlParam('readonly');
      let idCounter = 0;
      let id;
      const div = document.createElement('div');
      id = `id${idCounter++}`;
      div.id = id;
      div.style.width = '100%';
      div.style.height = '100%';

      // 给div为wps添加一个子div，用于放置文档
      document.querySelector('#wps').appendChild(div);
      // 创建一个wps扩展窗口
      window.wpsExt = Wps.createNew(document.querySelector(`#${id}`));    
      // 拼接请求地址
      let baseUrl = getNeedLocation();
      // remoteGetUrl = baseUrl;
      // remoteGetUrl = fileid;
      // remoteSaveUrl = baseUrl + 'ibizutil/uploadofficefileByWPS?fileid=' + fileid;
      // if (fileid) {
      //   let param = { url: remoteGetUrl, readOnly: false, revisionMode: false };
      //   // 判断是否只读模式打开文档
      //   if (readonly) {
      //     param.readOnly = readonly;
      //   }
      //   // 请求打开远程文档
        
      // } else {
      //   // 输出信息
      //   log('url参数fileid为空，打开远程文档失败');
      // }
    }


  </script>
</head>

<body style="height: 100%;" onload="init()">
  <div id="wpsContainer">
    <div id="wps" style="width: 100%;height: 100%;"></div>
  </div>
</body>

</html>